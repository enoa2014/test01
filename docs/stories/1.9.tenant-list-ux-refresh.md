# Story 1.9: tenant-list-ux-refresh

## Status

Ready for Review

## Story

**As a** 社工用户,
**I want** 在住户列表页快速获取关键状态并以更清晰的入口完成入住、离开等操作,
**so that** 我能够高效且准确地管理住户生命周期，减少误操作并提升日常事务处理效率。

## Story Context

- **Existing System Integration**: `miniprogram/pages/index/index`（住户列表主页入口）、相关云函数住户数据接口
- **Technology Stack**: 微信小程序原生框架、Mpflow 工程化工具、既有设计令牌体系
- **Follows Pattern**: 复用现有列表卡片组件与 ActionSheet 操作模式
- **Touch Points**: 住户列表 API（含状态、入住次数、最近入住时间字段）、本地存储（搜索策略保存）、悬浮球入口组件

## Acceptance Criteria

1. 列表卡片展示头像、姓名、年龄、状态标签与入住次数，并新增“最近一次入住时间”；若无入住记录显示“未入住”或同等提示。
2. 悬浮球仅提供“新建住户”入口，执行后仅创建住户档案，不触发入住流程；原“入住”操作从悬浮球中移除。
3. 长按住户卡片保留底部 ActionSheet，操作项包括：入住、详情、离开、发送消息、导出报告、删除住户；“入住”仅对可入住住户可用，其余状态呈禁用或隐藏。
4. 提供支持姓名、籍贯、性别、民族、年龄段、医生、医院等字段的模糊搜索，以及包含时间区间在内的高级筛选；筛选面板支持“且 / 或”组合逻辑并允许多条件叠加。
5. 列表支持按最近入住时间与入住次数排序，默认按最近入住动作排序；搜索/筛选组合可保存到本地预设并支持重命名、应用、删除。
6. 当住户状态变化（入住、离开等）后，列表在无需刷新页面的情况下更新状态、入住次数与最近入住时间；若受限需刷新，则提供显著刷新反馈并保证数据同步。
7. 方案遵循 `docs/architecture/coding-standards.md`、`docs/architecture/tech-stack.md` 与 `docs/design-system/` 规范，优先复用既有组件与样式 Token。

## Tasks / Subtasks

- [ ] 需求澄清与界面联调
  - [x] 与后端确认是否已提供入住次数、最近入住时间、住户状态字段；若缺失，提交接口改动需求。
  - [ ] 对齐设计规范与组件复用方案，更新住户列表线框/交互稿。
- [x] 列表卡片信息与操作重构（AC1-AC3）
  - [x] 调整 `miniprogram/pages/index/index` 列表卡片模板与样式，新增“最近入住时间”与状态标签渲染。
  - [x] 重构悬浮球逻辑，仅保留“新建住户”入口，并补充点击后成功/失败反馈。
  - [x] 优化长按 ActionSheet，确保各操作状态可控，并根据住户状态判断“入住”可用性。
- [x] 检索筛选与本地策略（AC4-AC5）
  - [x] 增强搜索输入支持多字段匹配及 AND/OR 逻辑解析，新增高级筛选面板交互。
  - [x] 实现排序切换（最近入住时间、入住次数）与默认排序策略。
  - [x] 提供本地化保存筛选策略（存储、应用、删除）能力，并限制在当前账号范围内。
- [ ] 数据同步与反馈（AC6）
  - [x] 监听或轮询入住/离开操作结果，刷新列表数据并在 UI 层展示同步完成提示。
  - [ ] 补充空状态、加载状态与错误提示，确保刷新过程可感知。
- [ ] 测试与文档（AC1-AC7）
  - [x] 编写单元/集成测试覆盖卡片渲染、搜索筛选逻辑及操作入口控制。
  - [ ] 更新用户指南或培训材料，说明新的列表能力与保存筛选预设的步骤。

## Definition of Done

- [ ] 所有验收标准通过并获得产品确认
- [ ] 新增/调整的接口与前端交互完成联调，回归核心入住/离开流程
- [x] 单元、集成及必要的端到端测试通过，关键场景覆盖率达标
- [ ] 变更记录于相关文档，部署说明更新
- [ ] 代码符合项目编码规范，提交通过 Lint 与 CI 校验

## Risk & Mitigation

- **主要风险**：后端缺乏入住次数与最近入住时间字段导致前端无法展示
  - **缓解措施**：事前确认接口能力，如需新增字段优先采用兼容扩展并提供默认兜底值
- **兼容性检查**：不引入破坏性接口变更，UI 组件遵循既有设计系统，性能测试确认筛选操作响应 ≤ 1 秒
- **回滚策略**：保留旧版列表配置，可通过开关或版本回退恢复旧逻辑

## Dev Agent Record

### Agent Model Used

Codex (GPT-5)

### Debug Log References

- `npm run test:unit`（全部测试通过，命令在输出完成后超时返回）

### Completion Notes

- 新增住户创建入口，复用入住向导前半程，仅写入住户基础档案。
- 列表卡片扩展最近入住、责任医生、状态徽标与信息摘要。
- 高级筛选面板支持性别、民族、籍贯、年龄段、责任医生等条件组合。
- 长按卡片提供入住/离开/消息/导出/删除操作，入住状态自动刷新列表。
- 补充多项 Jest 测试覆盖过滤逻辑与组件渲染。

### File List

- `cloudfunctions/patientIntake/index.js`
- `miniprogram/components/business/filter-panel/index.js`
- `miniprogram/components/business/filter-panel/index.wxml`
- `miniprogram/components/business/patient-card/index.js`
- `miniprogram/components/business/patient-card/index.wxml`
- `miniprogram/components/business/patient-card/index.wxss`
- `miniprogram/pages/index/index.js`
- `miniprogram/pages/index/index.json`
- `miniprogram/pages/index/index.wxml`
- `miniprogram/pages/index/index.test.js`
- `miniprogram/pages/patient-intake/wizard/wizard.js`
- `miniprogram/pages/patient-intake/success/success.js`
- `miniprogram/pages/patient-intake/success/success.wxml`
- `tests/unit/components/patient-card.test.js`
- `tests/unit/components/smart-search-bar.test.js`
- `tests/unit/pages/index-components.test.js`
- `tests/unit/pages/patient-intake-wizard.test.js`

### Change Log

- 新增 `createPatient` 云函数入口并统一刷新患者列表缓存。
- 调整患者列表 UI：展示最近入住信息、责任医生及强化徽标展示。
- 集成高级筛选面板，支持性别/民族/籍贯/年龄段/责任医生等多条件组合。
- 分离“新建住户”与“入住”入口，长按卡片提供完整操作项。
- 扩充 Jest 覆盖，验证过滤逻辑与组件渲染行为。
