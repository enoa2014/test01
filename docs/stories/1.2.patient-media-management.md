# Story 1.2: patient-media-management

## Status

Ready for Review

## Story

**As a** 后台护理/管理员用户,
**I want** 在患者档案中管理图片及文档（上传、浏览、下载),
**so that** 能完整记录患者资料并在护理与追踪时快速获取相关文件。

## Acceptance Criteria

1. 在患者详情页提供“资料管理”入口，支持上传图片（JPG/PNG/WebP）与文档（TXT、PDF、Word(doc/docx)、Excel(xls/xlsx)）；单个文件≤10 MB（向下取整，10×1024×1024 字节），单次批量≤5 个，前端在选择阶段提示剩余配额与预计提交大小。
2. 每位患者附件总数≤20、总容量≤30 MB；后台上传必须读取当前计数并在同一事务/锁内更新，确保并发场景仍不突破配额；超限时返回结构化错误码（如 MEDIA_QUOTA_EXCEEDED）与本地化提示。
3. 图片上传后展示在照片墙：缩略图网格按上传时间倒序；点击任意图片可进入原图预览（支持缩放、左右切换、原图下载），下载需使用有时效且关联用户的预签名链接。
4. 文档列表展示文件名、类型、大小、上传时间、上传人，提供下载按钮；点击文件名仅对 TXT 文件提供在线预览（纯文本渲染，大小上限 1 MB），其它类型仅提示“仅支持下载”。
5. 上传/删除/下载操作仅限后台登录用户；接口需先做权限校验，再执行文件操作；本故事范围内不保留审计/隐私日志。
6. 上传或删除完成后服务端同步更新附件计数与容量，并返回最新配额；前端据此刷新 UI；删除为不可恢复的硬删除，同时记录操作时间与操作者用于界面反馈。
7. 自动化测试至少覆盖：合法图片/文档上传成功、批量/单文件超限失败、并发上传配额一致性、权限拒绝、照片墙预览与下载、TXT 在线预览、非 TXT 下载 200 响应、删除后配额恢复。

## Tasks / Subtasks

- [x] 后台 UI 扩展（AC1-AC4、AC6）
  - [x] 在患者详情页添加“资料管理”区域，区分“照片墙 / 文档列表”视图，可分页或懒加载。
  - [x] 图片上传控件：拖拽/点击选择、展示剩余配额与预计大小、单次≤5 文件、类型白名单提示。
  - [x] 文档列表：表格展示类型、大小、上传人、上传时间，支持排序/过滤，并提示 TXT 可预览。
  - [x] 配额显示模块：展示“已用/剩余数量 & 容量”，操作后即时刷新。
- [x] 后端文件服务（AC1-AC6）
  - [x] 拆分/新增文件管理云函数，校验类型、单个尺寸、总数/容量，并处理并发事务。
  - [x] 采用存储目录 `patient-media/{patientKey}/{uuid}`，写入 `patient_media` 元数据集合（patientKey、category、filename、displayName、mimeType、sizeBytes、hash、uploaderId、createdAt、storagePath、thumbPath、downloadCount、deletedAt、deletedBy、quotaSnapshot）。
  - [x] 删除接口执行硬删除并回收配额；失败时回滚并清理残留云存储对象。
  - [x] 下载接口返回 ≤5 分钟有效的预签名 URL，不泄露真实路径，并通过 `Content-Disposition` 指定展示名称。
- [x] 照片墙与预览实现（AC3）
  - [x] 缩略图生成与缓存策略（云存储图片处理或异步任务），支持懒加载。
  - [x] 预览组件：左右切换、缩放、原图下载按钮、错误兜底与加载占位。
- [x] 权限控制（AC5）
  - [x] 后端统一鉴权，仅后台角色可访问；前端根据权限决定是否显示上传/删除操作。
- [x] 自动化测试与文档（AC7）
  - [x] 扩展 `run-patient-suite` 或新增 E2E 脚本覆盖上传/预览/下载/删除/配额场景。
  - [ ] 添加服务层测试：类型/大小/配额校验、并发上传、权限拒绝、TXT 预览大小限制。
  - [x] 更新 README / QA Notes 记录新命令、示例文件与清理策略。

## Dev Notes

- 前端需兼容 `miniprogram/pages/patient-detail` 现有结构；照片墙建议采用虚拟列表 + 懒加载，避免一次加载全部原图。
- 存储目录：`patient-media/{patientKey}/{fileUuid}`；缩略图放置 `patient-media/{patientKey}/thumb/{fileUuid}`；使用 sha256 做去重与重试幂等键。
- 上传接口使用云开发 `uploadFile` + 后端校验；请求中携带 session/token；失败回滚需删除已上传对象。
- 并发配额控制：采用事务/乐观锁同时更新配额与元数据；冲突时返回 MEDIA_QUOTA_EXCEEDED 并删除临时对象。
- TXT 在线预览：后端返回纯文本内容（需 UTF-8 转码与转义），超出 1 MB 时提示“请下载查看”。
- 本故事不包含内容安全/限流/审计需求，如后续需要单独立项。
- 自动化脚本需准备 KB 级示例图片/文档，并在测试结束后调用删除接口清理。

### Testing

- 执行记录：npm run test:e2e（缺少自动化种子数据导致未找到测试患者，需先运行 npm run test:e2e:patients 预置数据）
- 前端单元/组件测试：配额提示、上传限制文案、照片墙缩略图渲染与懒加载、预览缩放/切换/下载、TXT 预览渲染、非 TXT 下载提示。
- 服务/集成测试：上传类型/大小/配额校验；并发上传事务冲突；权限拒绝；下载预签名 URL 过期/篡改场景；删除回收配额与硬删除幂等。
- E2E（可基于 `run-patient-suite` 扩展）：正向上传→预览→下载→删除→配额恢复；逆向非法类型/超限/越权；并发上传触达边界并验证结果。
- 非功能：照片墙首屏与 P95 加载时间、缩略图命中率；预签名 URL 使用次数统计。

## Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-09-21 | v0.1    | 初版故事草稿（患者多媒体资料管理）        | Sarah  |
| 2025-09-21 | v0.2    | 根据 QA 反馈完善配额、权限、测试等细节    | Sarah  |
| 2025-09-21 | v0.3    | 明确无还原、TXT 单一预览、无风控/审计需求 | Sarah  |

## QA Results

- Gate: PASS
- Rationale: 关键决策（硬删除、TXT 预览范围、无审计/限流）已明确；AC/任务/测试覆盖与并发、权限及预签名要求已落地，可进入开发阶段
- Must-fix Follow-up: 在实施阶段验证事务回滚清理与 TXT 预览 1 MB 限制；确保预签名链接 TTL≤5 分钟
- Should-monitor: 缩略图生成失败兜底、预签名滥用监控建议在后续迭代讨论
- Tests: 单元/集成/E2E 场景详列于 Testing 部分，需全部覆盖
- Decision: Quinn（Test Architect），2025-09-21T02:23:30Z
