# Story 1.13: patient-theme-token-alignment

## Status

Approved

## Story

**As a** 前端维护人员,
**I want** 统一患者档案小程序的主题令牌与主题切换入口,
**so that** 页面风格一致、个性化主题更易发现并便于后续维护。

## Story Context

- **Existing System Integration**: 全局样式位于 `miniprogram/styles/`（含 `tailwind.input.css`、`foundation.wxss`、设计令牌输出），主题切换逻辑在 `miniprogram/utils/theme.js` 与详情/分析页头部组件中使用。
- **Technology Stack**: 微信小程序 + Tailwind/TDesign 令牌方案，构建依赖 Mpflow 与设计令牌生成脚本。
- **Follows Pattern**: 复用现有语义化样式类与 `themeManager` 封装，避免硬编码颜色。
- **Touch Points**: `miniprogram/styles/tailwind.input.css`、`miniprogram/styles/generated/`、`miniprogram/utils/theme.js`、各页面头部组件（详情页、分析页）。

## Acceptance Criteria

1. 清理旧的 `--color-*` 与 `--ink-*` 等非语义变量，统一使用语义类（如 `text-primary`、`bg-surface-muted`、`success`/`warning`）；在 `tailwind.input.css` 中保留迁移标注，并更新编译脚本确保生成文件不丢失映射。
2. 在详情页与分析页头部显著位置展示“当前主题”提示及切换入口（或在“更多”/操作菜单中提供），主题切换仍调用现有 `themeManager`，交互通过手动及键盘操作均可触达。
3. 全局圆角、阴影、间距统一采用设计令牌（`--radius-*`、`--shadow-*`、`--space-*`），移除散落的硬编码值；更新相关组件/页面样式并确保回归后视觉一致。
4. 修改后所有页面在浅色/深色主题下通过视觉巡检，确认无反向兼容问题；设计令牌生成脚本、lint 与构建任务全部通过。

## Tasks / Subtasks

- [ ] 令牌整理（AC1、AC3）
  - [ ] 审核 `tailwind.input.css` 与 `generated/tokens.wxss`，移除非语义变量并补充迁移注释。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 更新使用硬编码颜色/圆角/阴影/间距的组件与页面，统一引用语义类或令牌变量。[Source: architecture/coding-standards.md#1-通用约定]
- [ ] 主题入口优化（AC2）
  - [ ] 在详情页、分析页头部加主题提示或入口，调整 WXML/WXSS 使其遵循 BEM 与设计令牌规范。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 扩展 `theme.js` 以暴露所需状态/事件，并保持与现有订阅机制兼容。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 验证与构建（AC4）
  - [ ] 运行设计令牌生成脚本与 Mpflow 构建，确保样式生效且不破坏既有页面。[Source: architecture/tech-stack.md#2-工具与工程化]
  - [ ] 编写或更新组件/视觉回归检查清单，记录浅色/深色验证结果。[Source: architecture/coding-standards.md#3-Git-与提交规范]

## Project Structure Notes

- 改动集中于 `miniprogram/styles/` 与关键页面头部模块，符合源码结构基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 不涉及云函数或数据库结构调整。

## Dev Notes

- **Previous Story Insights**: 未在既有故事中找到主题令牌治理记录，需自行梳理设计系统输出。
- **Data Models**: 无数据结构变更需求。[No specific guidance found in architecture docs]
- **API Specifications**: 无额外接口调用。[No specific guidance found in architecture docs]
- **Component Specifications**: 继续使用现有页面头部组件与 `themeManager` 封装；可复用列表页 `.theme-picker` 样式（`miniprogram/pages/index/index.wxss:42`）与 `themeManager.selectTheme` 逻辑，在详情/分析页抽取共享 `ThemeIndicator`，按钮采用 `pm-button` 并补充 `aria-label`。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- **File Locations**: 样式及工具位于 `miniprogram/styles/`、`miniprogram/utils/theme.js`。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 需运行已有 lint、样式检查与必要的视觉/手动验证；项目单元测试覆盖率要求 ≥80%。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 遵循设计令牌与 BEM 命名、避免模板复杂逻辑。[Source: architecture/coding-standards.md#4-小程序代码规范]

## Definition of Done

- [ ] 验收标准全部满足，并通过设计/产品确认
- [ ] 设计令牌生成、构建与 lint 脚本全部通过
- [ ] 浅色/深色主题视觉巡检记录完成
- [ ] 测试与文档更新完毕
- [ ] 代码通过 CI 并符合提交规范

## Risk & Mitigation

- **风险**：统一变量可能影响旧样式
  - **缓解**：逐步替换并保留迁移注释，必要时引入兼容 fallback
- **风险**：主题入口干扰现有布局
  - **缓解**：在设计评审后微调布局，必要时使用折叠入口
- **回滚策略**：保留原 CSS 变量备份，出现问题可通过 git revert 或 feature flag 回退

## Testing

- 单元测试：无（以构建校验与视觉检查为主）
- 集成/视觉测试：浅色/深色主题在核心页面截图比对
- 手工测试：主题切换交互、头部入口、可访问性（键盘导航）

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出主题令牌治理与入口优化故事草稿 | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
