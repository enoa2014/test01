# Story 1.16: patient-intake-wizard-guidance

## Status

Approved

## Story

**As a** 社工或志愿者,
**I want** 在住户录入流程中获得更清晰的搜索、校验与完成引导,
**so that** 能够更快录入新的住户信息并减少流程中断或错误。

## Story Context

- **Existing System Integration**: 录入流程页面包括选择页 `miniprogram/pages/patient-intake/select`、向导页 `patient-intake/wizard`、完成页 `patient-intake/finish`，依赖 `patientIntake` 云函数。
- **Technology Stack**: 微信小程序原生框架 + 云开发。
- **Follows Pattern**: 复用现有向导步骤与表单配置，扩展即时校验与引导。
- **Touch Points**: 相应页面 WXML/WXSS/JS、`patient-intake` 组件/工具函数、`patientIntake` 云函数校验逻辑。

## Acceptance Criteria

1. 选择页支持高亮搜索命中结果，若无匹配项显示空态提示并提供主按钮“创建新住户”；空态按钮调用当前流程的新增路径。
2. 向导每一步提供即时校验：必填、格式、长度、选项限制在字段 blur 或输入时提示；页面顶部展示错误计数与“点击定位”功能，点击后滚动到对应字段。
3. 完成页明确主次 CTA：分别为“查看详情”“继续添加”“返回列表”，并在返回列表时刷新列表数据；CTA 支持键盘焦点与无障碍描述。
4. 录入流程改造后与现有 `patientIntake` 接口兼容，错误提示结构化（含错误码/文案）；新增交互覆盖单元/集成测试。

## Tasks / Subtasks

- [ ] 选择页优化（AC1）
  - [ ] 更新搜索结果渲染以高亮匹配字符，并在无结果时展示空态组件与“创建新住户”按钮。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 确认按钮调用当前流程的新增逻辑并记录埋点（若存在）。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 向导校验与错误定位（AC2）
  - [ ] 扩展字段配置加入即时校验规则，利用现有校验工具或新增函数在输入时校验。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 在页面顶部添加错误计数条，提供点击滚动定位能力并确保性能可控。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 完成页 CTA 与刷新（AC3、AC4）
  - [ ] 调整 CTA 排列与样式，突出主要按钮并添加辅助提示文案。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 返回列表时调用刷新逻辑（如事件通知或重新请求），确保列表页面数据显示最新。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 测试与文档（AC4）
  - [ ] 更新/新增单元、集成测试覆盖即时校验、错误定位、CTA 行为与刷新流程。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 在 UX 落地或培训文档中记录新的流程指引。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 改动集中于 `miniprogram/pages/patient-intake/`，符合项目结构基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 云函数 `patientIntake` 如需返回更多错误信息，需保持兼容旧客户端。

## Dev Notes

- **Previous Story Insights**: 无记录直接涉及录入流程优化，需复习现有 `patient-intake` 字段配置与校验模块。
- **Data Models**: `patients` 与 `patient_intake_records` 字段定义详见数据模型文档，校验需与后端一致。[Source: architecture/data-model.md#集合设计]
- **API Specifications**: `patientIntake` 云函数负责保存/校验，确保错误码与前端提示同步。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- **Component Specifications**: 录入向导使用配置驱动渲染，需更新配置并保持 BEM 命名。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 相关文件位于 `miniprogram/pages/patient-intake/` 与 `cloudfunctions/patientIntake/`。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 更新相关测试，保持 ≥80% 覆盖率并运行 Mpflow E2E 录入场景。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 即时校验需优化性能，避免频繁 setData；滚动定位需节流。

## Definition of Done

- [ ] 验收标准全部满足并获产品确认
- [ ] 真机验证录入流程无卡顿、错误提示准确
- [ ] 新增/更新测试全部通过
- [ ] 文档与培训材料更新
- [ ] 代码通过 lint、CI

## Risk & Mitigation

- **风险**：即时校验影响输入性能
  - **缓解**：使用节流/防抖，并在失焦时再次校验
- **风险**：返回列表刷新失败导致数据不同步
  - **缓解**：采用事件通知或回调，必要时增加轮询验证
- **回滚策略**：保留旧向导配置与样式，问题时可快速恢复

## Testing

- 单元测试：校验函数、错误计数组件
- 集成测试：完整录入流程、空态创建、返回列表刷新
- 手工测试：弱网、键盘操作、不同用户角色权限

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出录入流程搜索/校验/完成页优化故事 | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
