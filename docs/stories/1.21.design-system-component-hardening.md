# Story 1.21: design-system-component-hardening

## Status

Approved

## Story

**As a** 设计系统与前端维护者,
**I want** 将常用页面区块抽象为可复用组件并补充快照校验,
**so that** 后续页面改造时可快速复用一致的展示与交互，降低回归风险。

## Story Context

- **Existing System Integration**: 详情页、列表、分析页等重复使用“区块标题”“统计卡片”“空态”等 UI 模式，目前散落在各页面实现。
- **Technology Stack**: 微信小程序原生框架，组件目录位于 `miniprogram/components/`。
- **Follows Pattern**: 依据设计系统（Story 001.1）与 UX 评估建议，抽象 `SectionHeader`、`StatCard`、`EmptyState`、`ErrorState`、`Skeleton`、`MediaToolbar` 等组件。
- **Touch Points**: 新增组件目录、现有页面引用、测试与文档。

## Acceptance Criteria

1. 新增或整理以下组件：`pm-section-header`、`pm-stat-card`、`pm-empty-state`、`pm-error-state`、`pm-skeleton`、`pm-media-toolbar`；组件接受设计令牌配置并支持主题切换，API 文档清晰。
2. 页面（详情、列表、附件、分析）至少各替换一处旧实现为新组件，验证样式与交互保持一致；组件支持插槽或属性方便定制。
3. 引入快照或可视化校验脚本（如基于 Mpflow 页面或 Jest 快照）以检测组件外观回归，并在 CI 或手动流程中运行。
4. 更新组件文档，说明属性、示例与使用规范；同时更新 Storybook/Component Lab（如仍使用）以覆盖新组件。

## Tasks / Subtasks

- [ ] 组件实现与样式（AC1、AC2）
  - [ ] 在 `miniprogram/components/` 下创建上述组件目录，遵循小程序组件结构与设计令牌使用。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 编写组件属性、事件、插槽文档，确保主题与无障碍支持。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 页面替换与验证（AC2）
  - [ ] 在患者详情、列表、分析等页面替换旧实现，确保功能无回归并更新测试/[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 快照/可视化测试（AC3）
  - [ ] 扩展 Jest 快照或 Mpflow 可视化脚本，对关键组件输出快照比对并纳入 CI。[Source: architecture/tech-stack.md#4-测试体系]
- [ ] 文档更新（AC4）
  - [ ] 在 `docs/design-system/` 或组件文档中记录属性说明与示例；更新 Component Lab 展示页面。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 新增组件需遵循 `components/` 目录分层，命名以 `pm-` 前缀并保持一致结构。[Source: architecture/source-tree.md#source-tree-baseline]
- 需同步更新 `component-lab` 或相关演示页面。

## Dev Notes

- **Previous Story Insights**: 设计系统基础（Story 001.1）与业务组件（Story 001.4）提供参考，需确保组件样式与令牌一致。
- **Data Models**: 与数据无直接关系。[No specific guidance found in architecture docs]
- **API Specifications**: 组件 API 需文档化，便于后续使用。[Source: architecture/coding-standards.md#1-通用约定]
- **Component Specifications**: 遵循设计系统与 BEM 命名、支持可访问属性。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 组件位于 `miniprogram/components/`，文档位于 `docs/design-system/`。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: Jest/快照测试 + 手动巡检，保持 ≥80% 覆盖率。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 注意组件性能（Skeleton 不应过度渲染），支持浅/深主题。

## Definition of Done

- [ ] 组件实现并在核心页面落地验证
- [ ] 快照/可视化测试脚本可运行并纳入流程
- [ ] 设计系统文档与 Component Lab 更新
- [ ] 测试、lint、CI 全部通过
- [ ] 产品/UX 确认组件外观与交互

## Risk & Mitigation

- **风险**：组件 API 设计不合理导致后续扩展困难
  - **缓解**：与设计/开发联合评审接口
- **风险**：快照测试易碎
  - **缓解**：限定关键场景，结合视觉巡检
- **回滚策略**：保留旧实现，出现问题时恢复页面旧代码并迭代组件

## Testing

- 单元测试：组件渲染、属性/事件
- 快照测试：组件外观比对
- 手工测试：在 Component Lab 或真机中验证浅/深主题、无障碍

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出通用组件沉淀与快照校验故事草稿   | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
