# Story 1.17: analysis-sticky-filters

## Status

Approved

## Story

**As a** 管理人员或社工,
**I want** 在分析页拥有吸顶筛选条与筛选摘要,
**so that** 我可以快速切换时间、医院、状态并随时了解到当前数据范围，提升决策效率。

## Story Context

- **Existing System Integration**: 分析页 `miniprogram/pages/analysis/index`，依赖 `dashboardService` 云函数获取统计数据。
- **Technology Stack**: 微信小程序原生框架 + 设计令牌，后端为云函数 API。
- **Follows Pattern**: 复用现有筛选组件/弹框，扩展吸顶导航与摘要展示。
- **Touch Points**: `analysis/index.wxml/.wxss/.js`、`cloudfunctions/dashboardService`。

## Acceptance Criteria

1. 分析页顶部添加吸顶筛选条，包含时间段、医院、状态等快速筛选控件；筛选条在滚动时保持吸顶且支持键盘焦点与 `aria` 标签。
2. 应用筛选后在筛选条下方显示当前筛选摘要（如“2024 Q3 · XX 医院 · 在住/待入住”），提供“一键清除”操作。
3. 当数据为空时展示空态说明与返回路径按钮（如“去调整筛选”），遵循设计系统样式；数据加载中展示骨架或 Loading。
4. 页面记住最近一次筛选组合（本地缓存），返回分析页时自动恢复；切换图表模式时保持筛选不变。
5. 方案兼容现有 `dashboardService` 接口；若需新增筛选参数确保默认值与旧客户端兼容；新增交互覆盖单元/集成测试。

## Tasks / Subtasks

- [ ] 吸顶筛选条实现（AC1）
  - [ ] 在 `analysis/index.wxml` 添加吸顶容器与筛选控件，遵循 BEM 与设计令牌规范。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 在 `index.js` 处理吸顶逻辑、键盘焦点与无障碍属性。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 筛选摘要与空态（AC2、AC3）
  - [ ] 构建筛选摘要组件/方法，实时反映当前筛选并提供清除操作。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 设计空态/加载态 UI，复用 `pm-button` 与统一文案模板。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 状态持久化与兼容性（AC4、AC5）
  - [ ] 将筛选条件存储于本地（如 `wx.setStorage`），返回页面时恢复；切换图表模式等操作保持筛选。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
  - [ ] 若向 `dashboardService` 传递新参数，更新云函数默认值并保持后向兼容。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- [ ] 测试与文档（AC5）
  - [ ] 更新测试覆盖筛选条、摘要、空态与状态恢复逻辑。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 记录变更于 UX/分析页说明文档，方便培训。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 改动集中在 `miniprogram/pages/analysis/` 与 `cloudfunctions/dashboardService`（若需要），符合结构基线。[Source: architecture/source-tree.md#source-tree-baseline]

## Dev Notes

- **Previous Story Insights**: 未找到分析页相关故事记录，本次实现需审查现有筛选组件与数据接口。
- **Data Models**: 分析数据来源于统计聚合（详见数据模型文档），筛选条件需匹配字段命名。[Source: architecture/data-model.md#集合设计]
- **API Specifications**: `dashboardService` 需确保新参数默认值与旧客户端兼容。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- **Component Specifications**: 继续使用设计系统按钮/空态组件，如无可复用组件需按规范新增。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **Component Specifications**: 继续使用设计系统按钮/空态组件；吸顶筛选条可复用业务组件 `filter-panel`，外层容器使用 `position: sticky` 固定，筛选摘要采用 `pm-badge`/`pm-button` ghost 组合并提供“一键清除”。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 页面与云函数路径见 `source-tree` 基线。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: Jest/集成测试覆盖新增筛选逻辑，保持 ≥80% 覆盖率；必要时新增 E2E 场景。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 吸顶与滚动监听需节流；缓存逻辑注意版本升级与清理。

## Definition of Done

- [ ] 验收标准全部达成并获产品确认
- [ ] 真机验证吸顶、筛选摘要、空态表现
- [ ] 新增/更新测试全部通过
- [ ] 文档/说明更新
- [ ] 代码通过 CI 与 lint

## Risk & Mitigation

- **风险**：吸顶筛选影响页面性能
  - **缓解**：使用节流与 CSS 吸顶特性，减少 JS 监听
- **风险**：筛选缓存导致旧数据残留
  - **缓解**：存储版本号，必要时在应用更新时清理
- **回滚策略**：保留旧筛选面板与布局，可快速关闭新吸顶组件

## Testing

- 单元测试：筛选状态管理、摘要渲染
- 集成测试：筛选切换、清除、空态展示、状态持久化
- 手工测试：多维度筛选组合、弱网加载、键盘操作

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出分析页吸顶筛选与摘要故事草稿     | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
