# Story 1.11: patient-detail-section-navigation

## Status

Approved

## Story

**As a** 后台护理/管理员用户,
**I want** 在住户详情页通过锚点导航快速定位各信息区块,
**so that** 我能够在信息密度较高的页面中迅速查看或更新所需资料，降低滚动与误读成本。

## Story Context

- **Existing System Integration**: 住户详情页 `wx-project/pages/patient-detail/detail` 及其数据加载逻辑，需要与现有的基本信息、家庭信息、经济信息、入院记录、附件区块保持同步。
- **Technology Stack**: 微信小程序原生框架，复用设计令牌与既有组件体系。
- **Follows Pattern**: 延续当前详情页的骨架屏、分段渲染与状态管理方式，新增的导航控件需遵循页面现有的事件绑定与模块化结构。
- **Touch Points**: `detail.wxml` / `detail.wxss` / `detail.js`，以及用于定位区块的 `id`/`data-section` 属性。

## Acceptance Criteria

1. 在住户详情页顶部新增锚点导航条，默认包含“基础信息 / 家庭情况 / 经济情况 / 入住记录 / 附件资料”按钮；导航条在滚动超过头部后保持吸顶展示。
2. 点击锚点按钮时，页面以平滑滚动方式跳转到对应区块，同时更新导航条的激活态；导航条需支持键盘与无障碍焦点切换。
3. 用户滚动页面时，当前视窗内最接近顶部的区块自动对应导航激活态；当列表末尾无更多内容时，高亮保持在最后一个区块。
4. 导航条提供“返回顶部”操作，点击后滚动回页面首屏并重置激活态；在弱网或数据加载未完成时需禁用跳转并提示“内容加载中”。
5. 方案遵循 `docs/ux-ui-assessment.md` 中关于区块导航与信息分段的指导，保持现有数据显示与权限逻辑不变。

## Tasks / Subtasks

- [ ] 导航结构与样式实现（AC1、AC4）
  - [ ] 在 `wx-project/pages/patient-detail/detail.wxml` 中新增锚点导航容器与“返回顶部”按钮，并为各区块配置可滚动定位标识。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 在 `detail.wxss` 中补充吸顶、激活态与无障碍焦点样式，复用设计令牌与 BEM 命名规范。[Source: architecture/coding-standards.md#小程序代码规范]
- [ ] 导航交互与状态管理（AC2、AC3、AC4）
  - [ ] 在 `detail.js` 中实现锚点点击滚动、滚动侦听与激活态计算逻辑，复用现有页面数据结构与 `setData` 方法。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
  - [ ] 增加加载状态判断，未完成数据拉取时禁用导航并给出提示。[Source: architecture/coding-standards.md#小程序代码规范]
- [ ] 无障碍与可测试性（AC2、AC4）
  - [ ] 为导航元素补充 `aria-label`/`role` 等属性，并确保键盘导航顺序正确。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 编写或更新相关单元/集成测试，覆盖激活态切换与弱网禁用逻辑。[Source: architecture/tech-stack.md#4-测试体系]
- [ ] 文档与同步（AC5）
  - [ ] 在 UX 落地记录或变更日志中登记锚点导航改造，提示设计与前端协作注意事项。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 变更集中于 `wx-project/pages/patient-detail/`，符合前端页面结构基线，无需新增目录。[Source: architecture/source-tree.md#source-tree-baseline]
- 不涉及云函数或数据结构调整，与现有接口兼容。

## Dev Notes

- **Previous Story Insights**: 未在架构文档中找到与锚点导航直接相关的前置决策或限制。
- **Data Models**: 入住记录与患者基础信息分别来源于 `patients` 与 `patient_intake_records` 集合，导航需确保区块标识与数据加载顺序一致。[Source: architecture/data-model.md#集合设计]
- **Component Specifications**: 架构文档未提供详情页组件化规范，维持现有页面结构并使用原生组件。[No specific guidance found in architecture docs]
- **File Locations**: 页面代码位于 `wx-project/pages/patient-detail/`，样式与脚本同目录维护。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 项目要求 Jest 单元测试覆盖率 ≥80%，关键交互需通过组件或集成测试验证。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 小程序代码需遵循设计令牌、BEM 命名与性能优化原则，避免在模板中编写复杂逻辑。[Source: architecture/coding-standards.md#4-小程序代码规范]

## Definition of Done

- [ ] 验收标准全部满足并通过产品确认
- [ ] 导航与详情区块交互经手动回归验证，无回归缺陷
- [ ] 单元/集成测试更新并全部通过
- [ ] 文档或变更记录完成更新
- [ ] 代码符合 lint/样式规范并通过 CI

## Risk & Mitigation

- **风险**：滚动监听性能开销导致页面卡顿
  - **缓解**：使用节流/防抖并复用现有数据源，避免频繁 `setData`
- **风险**：弱网下导航触发空数据跳转
  - **缓解**：依赖页面加载状态禁用导航并提示用户
- **回滚策略**：保留原始详情页布局，若导航问题影响体验，可移除导航容器并恢复旧结构

## Testing

- 单元测试：锚点点击后调用 `page.scrollTo`、激活态更新逻辑、加载状态禁用提示
- 集成测试：模拟滚动交互，验证吸顶与激活态切换；弱网场景下导航禁用与提示
- 手工回归：与附件区懒加载、编辑模式切换等现有功能组合验证，确保无冲突

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX/UI 评估输出锚点导航增强故事草稿         | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
