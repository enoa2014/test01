# Story 1.18: patient-ui-feedback-accessibility

## Status

Approved

## Story

**As a** 产品与前端协作者,
**I want** 在小程序关键操作中统一反馈、命中区与无障碍表现,
**so that** 用户在提交、删除、错误场景下获得一致体验，降低误触并满足可访问要求。

## Story Context

- **Existing System Integration**: 适用于患者详情、列表、录入、附件等页面，涉及全局 `pm-button`、`pm-dialog`、`toast` 封装及自定义操作入口。
- **Technology Stack**: 微信小程序原生框架，复用现有组件与工具函数。
- **Follows Pattern**: 使用统一反馈组件（Loading、Toast、Modal），遵循设计令牌与无障碍规范。
- **Touch Points**: `wx-project/components/pm-button`、`pm-dialog`、`pm-toast`、公共工具 `wx-project/utils/feedback.js`（若存在）以及页面级操作逻辑。

## Acceptance Criteria

1. 统一操作反馈：提交/加载/删除等流程使用统一 Loading 指示与 Toast/Modal 反馈，危险操作（删除、退出）需通过 `pm-dialog` 二次确认并提供清晰文案；所有反馈函数集中管理，页面调用保持一致。
2. 调整按钮/图标交互区域，保证命中区≥44px；行内操作需替换为按钮组件或补充可访问描述，图标按钮添加 `aria-label`。
3. 为主要图标与按钮补充辅助文本或 `aria` 属性，确保读屏顺序与键盘焦点正确；空态/错误状态提供说明文本与操作建议。
4. 在至少详情页、列表页、录入页验证上述反馈与无障碍调整均生效，无功能回归；相关单元/集成测试覆盖反馈封装。

## Tasks / Subtasks

- [ ] 反馈组件统一（AC1）
  - [ ] 梳理现有 Loading/Toast/Modal 触发点，封装统一接口并替换分散实现。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 危险操作统一调用 `pm-dialog` 并提供结构化文案。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 命中区与可访问性调整（AC2、AC3）
  - [ ] 检查关键按钮/图标尺寸，必要时扩展触发区域或添加透明 padding。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 为图标按钮、空态组件增加 `aria-label`、描述文本与键盘焦点控制。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 页面验证与测试（AC4）
  - [ ] 在详情、列表、录入页调用统一反馈并验证交互；更新单元/集成测试覆盖反馈封装。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 编写无障碍验收清单，记录读屏/键盘测试结果。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 代码主要涉及 `wx-project/components/` 与若干页面逻辑，符合结构基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 不涉及后端改动。

## Dev Notes

- **Previous Story Insights**: 附件管理与内联编辑已使用 Loading/Toast，但存在样式差异；需确保向新封装迁移。
- **Data Models**: 无数据变更。[No specific guidance found in architecture docs]
- **API Specifications**: 反馈封装需处理服务端错误结构 `{ code, message }`。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- **Component Specifications**: 使用 `pm-button`、`pm-dialog`、`pm-toast` 并遵循设计令牌。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **Component Specifications**: 使用 `pm-button`、`pm-dialog`、`pm-toast` 并遵循设计令牌；反馈统一可集中到 `wx-project/utils/feedback.js`，危险操作复用 `pm-dialog` 确认，按钮保持 `size="large"` 或附加 padding 以满足 ≥44px 命中区。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 组件与工具位置见 `source-tree` 基线。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 更新 Jest/集成测试覆盖反馈封装、键盘焦点行为，保持 ≥80% 覆盖率。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 留意弱网场景与用户快速触发多次操作的节流。

## Definition of Done

- [ ] 验收标准全部满足并通过产品/UX/无障碍验收
- [ ] 关键页面反馈统一且真机读屏通过
- [ ] 新增/更新测试与 lint、CI 通过
- [ ] 文档记录新反馈模式与无障碍检查表
- [ ] 代码合并通过审核

## Risk & Mitigation

- **风险**：统一封装影响已有页面逻辑
  - **缓解**：逐步迁移并保持旧接口 fallback
- **风险**：键盘/读屏兼容性不足
  - **缓解**：与 QA/无障碍测试协作，提前验证
- **回滚策略**：保留旧反馈工具，必要时通过配置开关还原

## Testing

- 单元测试：反馈工具函数、命中区计算
- 集成测试：详情/列表/录入页面操作流程
- 手工测试：读屏（iOS/Android）、键盘操作、弱网与错误场景

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出反馈统一与可访问性增强故事草稿   | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
