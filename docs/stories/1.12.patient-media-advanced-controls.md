# Story 1.12: patient-media-advanced-controls

## Status

Approved

## Story

**As a** 后台护理/管理员用户,
**I want** 在患者详情页的资料管理区对附件进行排序、筛选与批量操作,
**so that** 可以迅速定位需要的文件、批量处理重复或过期资料，并保持界面体验一致。

## Story Context

- **Existing System Integration**: 住户详情页 `wx-project/pages/patient-detail/detail`，依赖现有 `mediaService` 读取 `patientMedia` 云函数返回的数据结构。
- **Technology Stack**: 微信小程序原生框架、云开发 `wx.cloud.callFunction`。
- **Follows Pattern**: 延续 `patient-media-management` 能力（Story 1.2）和 2025-09 的懒加载改造，复用 `pm-button`、`pm-card` 等业务组件与设计令牌体系。
- **Touch Points**: `detail.wxml/.wxss/.js`、`wx-project/components/pm-button`、`cloudfunctions/patientMedia` 排序与批量删除接口。

## Acceptance Criteria

1. 资料管理区新增排序控制，默认“按上传时间倒序”，可切换为“按大小倒序”“按文件类型 A→Z”；切换后列表按所选维度即时更新。
2. 提供筛选选项：图片、文档、仅可预览文件（TXT），支持组合选择；筛选标记清晰可见，可一键清除。
3. 支持批量选择文件（图片与文档），批量删除操作需二次确认，并在成功后刷新配额与列表；批量下载暂不在范围内但按钮需禁用并给出提示。
4. 空态与错误状态按照 UX 评估描述展示插画、文案与行动按钮（上传或重新加载），按钮样式统一使用 `pm-button` 并提供加载/禁用反馈。
5. 所有新控件满足可访问性：可通过键盘焦点操作、为重要图标添加 `aria-label`/提示文案，弱网/加载中状态禁用交互并提示“附件加载中”。
6. 新增能力不影响既有上传、单个删除、预览下载流程； `patientMedia` 云函数无需破坏性变更，若新增排序参数需向后兼容旧客户端。

## Tasks / Subtasks

- [ ] UI 构造与样式（AC1-AC4）
  - [ ] 在 `detail.wxml` 中添加排序、筛选和批量操作区域，复用 `pm-button` 与现有设计令牌样式。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 更新 `detail.wxss` 以支持新控件的吸顶、激活态与按钮风格，遵循 BEM 命名与设计令牌引用。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 排序/筛选逻辑与状态管理（AC1-AC3）
  - [ ] 在 `detail.js` 中扩展 `media` 数据结构及 `mediaService`，实现排序、筛选、批量选择状态与 `setData` 更新。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
  - [ ] 若需向云函数传参，确保调用沿用既有封装并处理向后兼容；旧参数缺失时保持默认排序。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- [ ] 批量删除与确认流程（AC3）
  - [ ] 在前端实现批量删除对话框与禁用逻辑，校验权限后调用既有删除接口；必要时在云函数新增批量入口（兼容单删）。[Source: architecture/tech-stack.md#3-云函数与后端协作]
  - [ ] 操作完成后刷新配额显示并复用现有提示/日志方案，确保无重复调用。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 空态/错误态与无障碍（AC4-AC5）
  - [ ] 为空态、权限不足、加载失败等场景提供文案与插画占位，引用统一组件或样式。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 补充 `aria-label`、键盘操作说明与加载禁用提示，遵循无障碍规范。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 测试与文档（AC1-AC6）
  - [ ] 新增/更新单元与集成测试覆盖排序、筛选、批量删除与状态提示，确保覆盖率达既定门槛。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 在 UX 落地或变更记录中补充新控件说明与操作指引。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 代码改动集中在 `wx-project/pages/patient-detail/` 与 `cloudfunctions/patientMedia/`（如需批量接口），符合源码结构基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 复用现有组件目录，无需新增顶级目录。

## Dev Notes

- **Previous Story Insights**: Story 1.2 已交付资料管理基础功能并引入配额控制与懒加载；需复用其 `mediaService` 封装与并发处理逻辑，避免重复实现。
- **Data Models**: 架构文档未定义 `patient_media` 结构；依赖既有 `patientMedia` 云函数中的元数据（count、size、category）。[No specific guidance found in architecture docs]
- **API Specifications**: 未在架构文档发现附件 API 规范；沿用当前 `callPatientMedia` 行为并在实现阶段补充接口文档。
- **Component Specifications**: 架构文档未提供资料管理专用组件说明，继续使用页面内组合与 `pm-button` 等基础组件。[No specific guidance found in architecture docs]
- **File Locations**: 前端逻辑位于 `wx-project/pages/patient-detail/detail.{js,wxml,wxss}`；若扩展服务层可放于 `wx-project/utils/` 对应文件。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 项目要求 Jest 单元测试与 Mpflow 集成测试，覆盖率 ≥80%，关键交互需模拟实际数据响应。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 小程序代码需遵循设计令牌、BEM 命名与性能优化要求，避免在模板中编写复杂表达式。[Source: architecture/coding-standards.md#4-小程序代码规范]

## Definition of Done

- [ ] 全部验收标准达成，并通过产品/QA 确认
- [ ] 排序、筛选、批量操作在真机体验验证无性能或交互问题
- [ ] 新增/更新测试全部通过并满足覆盖率
- [ ] 文档/变更记录更新完毕
- [ ] 代码通过 lint、格式化与 CI

## Risk & Mitigation

- **风险**：批量选择导致内存或状态同步异常
  - **缓解**：限制单次批量操作数量，并确保 `setData` 批量更新时进行节流
- **风险**：排序筛选与懒加载冲突
  - **缓解**：在本地维护已加载数据副本，切换时复用缓存；必要时请求增量数据
- **回滚策略**：保留原版控件与逻辑，出现问题可关闭高级控制并恢复基础版本

## Testing

- 单元测试：排序函数、筛选过滤器、批量状态管理、空态提示
- 集成测试：模拟多类型附件数据，覆盖筛选/批量删除场景；校验配额刷新
- 手工测试：弱网加载、权限拒绝、键盘操作、移动端长按误触等组合场景

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX/UI 评估编写资料管理高级控制故事草稿     | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
