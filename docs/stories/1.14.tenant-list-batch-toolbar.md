# Story 1.14: tenant-list-batch-toolbar

## Status

Approved

## Story

**As a** 社工或后台管理员,
**I want** 在住户列表页更清晰地查看核心信息并在批量模式下有吸顶工具栏,
**so that** 我可以快速确认住户状态、批量操作并在长列表中便捷回到顶部或筛选入口。

## Story Context

- **Existing System Integration**: 住户列表页面 `wx-project/pages/index/index`，使用现有列表卡片组件与悬浮筛选/搜索逻辑。
- **Technology Stack**: 微信小程序原生框架 + 设计令牌体系，复用动作面板与批量选择实现。
- **Follows Pattern**: 继续沿用 `patient-card` 组件结构与 ActionSheet 行为，扩展批量模式 UI。
- **Touch Points**: `wx-project/pages/index/index.wxml/.wxss/.js`、`wx-project/components/business/patient-card/`。

## Acceptance Criteria

1. 列表卡片信息层级优化：姓名/年龄/状态同行展示，最近入住时间与医院信息在次要行呈现，标签/次数等元信息弱化色显示；调整后保留既有响应式与可点击区域。
2. 批量模式启用后展示吸顶工具栏，包含“已选 N / 全选 / 反选 / 清空”操作，按钮遵循 `pm-button` 样式并支持键盘操作；工具栏滚动时保持吸顶且不遮挡筛选条。
3. 长列表新增悬浮按钮组：提供“返回顶部”和“回筛选”入口，按钮在滚动后显示，点击后分别滚动到页面顶部或打开筛选面板；按钮在加载/禁用状态时需提供相应提示。
4. 方案与现有筛选、搜索、单项操作兼容；批量模式中长按 ActionSheet 行为维持原逻辑；页面通过单元/集成测试覆盖新增操作。

## Tasks / Subtasks

- [ ] 列表卡片层级调整（AC1）
  - [ ] 更新 `patient-card` 模板与样式，重排主/次/元信息并应用设计令牌弱化色。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 回归验证点击、长按、触摸区域无回归并保持 BEM 命名规范。[Source: architecture/source-tree.md#source-tree-baseline]
- [ ] 批量工具栏实现（AC2）
  - [ ] 在 `index.wxml` 添加吸顶工具栏与批量操作按钮，复用 `pm-button` 并遵循语义命名。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 在 `index.js` 扩展批量状态与事件处理，保证 `setData` 更新性能并保持与 ActionSheet 同步。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 悬浮按钮与交互（AC3、AC4）
  - [ ] 新增悬浮按钮组件/容器，处理显示/隐藏逻辑与滚动监听，提供“回顶部”“回筛选”操作。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 补充键盘焦点、aria 属性与弱网禁用提示。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 测试与验证（AC4）
  - [ ] 增补单元/集成测试覆盖批量工具栏操作、悬浮按钮与回到顶部行为。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 手动回归筛选、排序、批量操作，记录触屏/键盘场景结果。

## Project Structure Notes

- 代码集中于 `wx-project/pages/index/` 与 `wx-project/components/business/patient-card/`，符合目录基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 不涉及后端或数据库改动。

## Dev Notes

- **Previous Story Insights**: Story 1.9 已对列表搜索、ActionSheet 等进行优化，本故事继续扩展批量工具栏与展示层级，需复用既有状态管理。
- **Data Models**: `patients` 集合提供 `latestAdmissionDate`、`admissionCount` 等字段，可直接复用。[Source: architecture/data-model.md#集合设计]
- **API Specifications**: 沿用现有列表数据接口，无新增 API。[No specific guidance found in architecture docs]
- **Component Specifications**: 继续使用 `patient-card` 组件并遵循设计系统令牌。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 页面与组件目录参考 `source-tree` 基线。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 确保 Jest/组件测试与 Mpflow E2E 涵盖新增交互，整体覆盖率 ≥80%。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 滚动监听需节流，避免频繁 `setData`；按钮遵循 44px 命中区规范。[Source: architecture/coding-standards.md#4-小程序代码规范]

## Definition of Done

- [ ] 验收标准全部达成并获产品确认
- [ ] 批量模式、悬浮按钮与卡片展示经真机回归通过
- [ ] 新增/更新测试全部通过
- [ ] 文档/变更记录更新完毕
- [ ] 代码通过 lint、格式化与 CI

## Risk & Mitigation

- **风险**：吸顶工具栏遮挡筛选区域
  - **缓解**：预留高度并与筛选条滚动联动
- **风险**：滚动监听导致性能问题
  - **缓解**：使用节流、防抖并限制 setData 频率
- **回滚策略**：保留原批量模式逻辑，可通过配置开关关闭新工具栏

## Testing

- 单元测试：批量状态管理、悬浮按钮显示逻辑
- 集成测试：批量选择操作流、回到顶部与筛选入口
- 手工测试：触屏、键盘操作、弱网场景、长列表性能

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出列表批量工具栏与滚动反馈故事草稿 | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
