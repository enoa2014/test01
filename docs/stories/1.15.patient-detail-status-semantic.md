# Story 1.15: patient-detail-status-semantic

## Status

Approved

## Story

**As a** 后台护理/管理员用户,
**I want** 在住户详情页看到统一的状态颜色与显著操作按钮,
**so that** 我能快速判断住户当前状态并安全地执行关键操作，减少误触和信息混淆。

## Story Context

- **Existing System Integration**: 住户详情页头部状态条、信息卡片以及操作按钮位于 `wx-project/pages/patient-detail/detail`。
- **Technology Stack**: 微信小程序原生框架，复用设计令牌与状态图标资产。
- **Follows Pattern**: 延续现有 `status` 渲染逻辑与按钮组件，补充语义映射与样式权重。
- **Touch Points**: `detail.wxml/.wxss/.js`、`wx-project/components/pm-button`、状态图标资源目录。

## Acceptance Criteria

1. 统一状态语义映射：在详情页头部与关键信息处使用 `success`（在住）、`warning`（待入住）、`default/neutral`（离开/其他）等颜色与对应图标；若出现未知状态给出 `info` 提示并记录日志。
2. 操作按钮（如“修改资料”“导出”“下载附件”）采用 `pm-button` 组件并提升视觉权重，提供加载/禁用态，危险操作采用 `danger` 样式与二次确认。
3. 状态标签、说明文案与图标在浅色/深色主题下对比充足，通过视觉巡检与无障碍校验（含 `aria-label`）。
4. 更新后的状态与按钮逻辑不影响现有数据加载、编辑、附件等功能；所有相关单元/集成测试通过。

## Tasks / Subtasks

- [ ] 状态映射实现（AC1）
  - [ ] 在 `detail.js` 中集中定义状态→颜色/图标映射并在渲染时引用，处理未知状态 fallback。[Source: architecture/coding-standards.md#1-通用约定]
  - [ ] 更新 `detail.wxml`、`detail.wxss` 使状态展示统一并应用设计令牌。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 操作按钮强化（AC2）
  - [ ] 将关键操作改为 `pm-button` 并补充加载/禁用态处理逻辑。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 为危险操作接入统一确认对话框，遵循现有 UX 指南。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 主题与可访问性验证（AC3、AC4）
  - [ ] 在浅/深色主题下调试状态标签与按钮对比度，补充 `aria-label` 与键盘焦点顺序。[Source: architecture/coding-standards.md#4-小程序代码规范]
  - [ ] 更新或新增单元/集成测试覆盖状态映射与按钮状态。[Source: architecture/tech-stack.md#4-测试体系]

## Project Structure Notes

- 改动集中在 `wx-project/pages/patient-detail/`，符合源码结构基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 无后端或数据结构调整。

## Dev Notes

- **Previous Story Insights**: 详情页内联编辑（Story 1.4）与附件管理（Story 1.2、1.12）已使用按钮组件，需保持一致并避免重复逻辑。
- **Data Models**: 状态字段来自 `patients.status`，取值范围需与后端确认。[Source: architecture/data-model.md#集合设计]
- **API Specifications**: 无新增 API 调整。[No specific guidance found in architecture docs]
- **Component Specifications**: 继续使用 `pm-button` 与状态标签样式组件。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 页面与组件位置参考 `source-tree` 基线。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 更新现有测试并确保覆盖率 ≥80%；需要人工视觉/无障碍确认。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 避免在模板中使用复杂条件，逻辑需在 JS 层处理；UI 需保持响应性能。[Source: architecture/coding-standards.md#4-小程序代码规范]

## Definition of Done

- [ ] 验收标准全部达成并经产品/UX 认可
- [ ] 状态映射与按钮样式真机验证通过
- [ ] 所有关联测试与 lint 通过
- [ ] 文档/变更记录更新
- [ ] 代码合并通过 CI

## Risk & Mitigation

- **风险**：状态枚举不完整导致显示异常
  - **缓解**：增加 fallback 与监控日志
- **风险**：按钮强化影响布局
  - **缓解**：与设计快速迭代调整间距
- **回滚策略**：保留旧样式快捷分支，可在问题时回退状态映射与按钮改动

## Testing

- 单元测试：状态映射函数、按钮禁用/加载逻辑
- 集成测试：状态切换展示、危险操作确认流程
- 手工测试：浅/深色主题、无障碍（读屏/键盘）、移动端视觉

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出详情页状态语义与按钮强化故事草稿 | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
