# Story 1.4: patient-detail-inline-edit

## Status

In Progress

## Story

**As a** 后台护理/管理员用户,
**I want** 在患者详情页直接切换到编辑模式并保存资料,
**so that** 我能快速修订患者基础信息与入住记录而无需跳转其他页面。

## Acceptance Criteria

1. 详情页展示“修改资料”按钮，点击后页面切换为编辑模式：原有只读字段按类型显示对应输入控件（文本、下拉、日期、电话等），页面顶部出现编辑提示条和“保存 / 取消”按钮。
2. 编辑模式中需根据字段类型提供实时校验（如必填、格式校验、长度限制、选项约束），未通过校验时保存按钮保持禁用并在字段旁显示错误提示。
3. 用户修改期间自动追踪变更差异：若无字段变更则“保存”保持禁用，取消或离开页面时提示是否放弃未保存修改。
4. 点击“保存”调用后端更新接口：提交含基础信息与入住记录的变更数据，成功后刷新详情页内容并给出成功提示，同时在操作日志区域新增一条记录；失败时保留编辑内容并展示错误信息。
5. 点击“取消”或关闭编辑提示条时，所有控件恢复为只读视图，临时修改被撤销，页面回到初始展示状态。
6. 后端需对更新时间戳 / 版本号进行并发控制，当存在他人更新导致版本冲突时，接口返回冲突提示，前端显示对话框引导用户刷新数据重试。
7. 成功保存后记录操作审计信息（操作人、时间、变更字段摘要），并在患者详情页的操作日志区域新增条目。

## Tasks / Subtasks

- [x] 前端详情页编辑模式（AC1-AC5）
  - [x] 在 `wx-project/pages/patient-detail/detail` 页面增加“修改资料”入口与编辑提示条组件。
  - [x] 将基础信息、联系人、入住记录等字段抽象为配置驱动的渲染器，支持只读/编辑两种状态。
  - [x] 实现表单状态管理与变更追踪，控制保存/取消按钮的可用状态，封装离开页面前的未保存警告。
- [x] 校验与用户体验（AC2-AC5）
  - [x] 追加字段级校验规则（必填、格式、最大长度、合法选项），统一错误提示样式。
  - [x] 保存前进行整体验证，提供加载状态与成功/失败反馈。
- [x] 后端接口与数据层（AC6-AC7）
  - [x] 在 `cloudfunctions/patientIntake` 或既有患者资料服务中新增/扩展更新接口，支持部分字段更新并复用现有后台角色校验。
  - [x] 实现乐观并发控制（版本号、更新时间戳），处理冲突返回标准化错误码。
  - [x] 写入审计日志（操作人 openid、时间、变更字段摘要），并在患者详情接口返回最新日志。
- [ ] 测试与文档
  - [x] 编写单元/集成/端到端测试覆盖保存成功、校验失败、冲突与取消场景。
  - [ ] 更新用户指南与培训材料，说明编辑模式的入口、校验反馈与冲突处理方式。

## Dev Agent Record

### Agent Model Used

gpt-5

### Debug Log References

- npx jest tests/service/patientIntake-update.spec.js --config tests/service/jest.config.cjs --runInBand
- npx jest tests/service/patientMedia.spec.js --config tests/service/jest.config.cjs --runInBand

### Completion Notes List

- 重构患者详情页 WXML/WXSS，实现配置驱动编辑表单、保存/取消控制以及操作日志展示。
- 扩展 `wx-project/pages/patient-detail/detail.js`：补齐字段校验、变更字段统计与保存流程文案。
- 后端 `cloudfunctions/patientIntake` 增补详情聚合、乐观锁更新及审计日志写入；`patientMedia` 补充授权校验。
- 新增共享 wx-server-sdk 模拟与 `patientIntake-update` 服务测试，回归患者附件接口用例。

### File List

- wx-project/pages/patient-detail/detail.wxml
- wx-project/pages/patient-detail/detail.wxss
- wx-project/pages/patient-detail/detail.js
- wx-project/config/patient-detail-fields.js
- cloudfunctions/patientIntake/index.js
- cloudfunctions/patientMedia/index.js
- tests/service/**mocks**/wx-server-sdk.js
- tests/service/patientIntake-update.spec.js
- tests/service/patientMedia.spec.js
- docs/stories/1.4.patient-detail-inline-edit.md

## Dev Notes

- 详情页现有实现位于 `wx-project/pages/patient-detail/detail.js`，需扩展为双状态渲染，可考虑提取字段描述配置到 `wx-project/config/patient-detail-fields.ts`。
- 状态管理可沿用小程序页面 `data` + 自定义隐式 store，需兼容已有的 `callPatientMedia` 等工具函数；建议新增 `wx-project/utils/patient-detail-edit.js` 承担差异追踪与校验逻辑。
- 后端可在 `cloudfunctions/patientIntake` 增加 `action: 'updatePatient'` 分支，复用既有集合 `patients`、`patient_intake_records`，并写入 `audit_logs` 集合或现有操作日志结构。
- 保存成功后需刷新详情数据（重新调用详情查询接口），确保前端视图与后端一致。
- 注意与 Excel 导入同步逻辑的冲突处理：当后端返回冲突码时，前端提示“资料已被其他人更新”，提供“刷新”操作。

## Testing

- 单元测试：字段配置渲染、校验函数、差异追踪与按钮状态切换。
- 集成测试：保存成功流程、保存失败（后端错误、冲突）、取消恢复只读视图、离开前提示。
- 端到端测试：
  - 进入详情页→点击修改→编辑基础信息→保存成功→日志新增。
  - 编辑时触发校验错误（如必填为空、手机号格式不符）验证错误提示及保存禁用。
  - 模拟并发：在保存前后台更改同一患者→校验前端收到冲突提示并可刷新后重试。
  - 取消操作确保还原初始数据且无多余日志。
- 非功能：确保保存接口响应时间 ≤2s（P95），并在弱网场景下提供重试/错误提示策略。

## Change Log

| Date       | Version | Description                            | Author |
| ---------- | ------- | -------------------------------------- | ------ |
| 2025-09-22 | v0.1    | 初版故事草稿（患者详情页内联编辑能力） | Sarah  |

## QA Results

- Gate: 未评估
- Rationale: 故事待 QA 评审
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A

### Review Date: 2025-09-22

### Reviewed By: Quinn (Test Architect)

**Summary**

- 验收标准覆盖编辑模式、校验、冲突处理与审计要求，整体具备可实现与可测试性。
- 任务拆解、Dev Notes 与 Testing 部分指向清晰，可直接指导开发与 QA 设计测试方案。

**Risk Level:** Low（主要关注弱网/并发场景的重试与提示实现）

**Findings**

1. 实现阶段需确认更新接口仅复用既有后台角色校验，无需新增权限模型，并在测试中覆盖“无权限用户无法进入编辑模式”的兜底验证。（Severity: Low、Owner: dev）

**Recommendations**

- 在测试计划中显式覆盖弱网保存重试、版本冲突、审计日志写入等高风险场景，避免遗漏。
- 开发阶段确认字段配置与校验逻辑可复用，减少重复维护成本。

**Gate Recommendation:** PASS（可进入开发阶段）
