# Story 1.19: patient-performance-optimizations

## Status

Approved

## Story

**As a** 前端性能负责人与开发者,
**I want** 优化住户列表及详情页的首屏加载策略,
**so that** 在弱网场景下也能快速呈现必要信息并降低无效渲染成本。

## Story Context

- **Existing System Integration**: 住户列表页 `miniprogram/pages/index/index` 与详情页 `miniprogram/pages/patient-detail/detail`，依赖 `patientProfile`、`patientIntake` 云函数。
- **Technology Stack**: 微信小程序原生框架，数据请求使用 `wx.cloud.callFunction`，状态通过 `setData` 管理。
- **Follows Pattern**: 延续现有骨架屏与懒加载逻辑，强化分页与分段渲染。
- **Touch Points**: 列表与详情页面 JS/WXML、骨架组件、云函数调用。

## Acceptance Criteria

1. 住户列表使用自适应高度骨架卡片并实现分页/预取：首屏仅加载第一页必要字段，滚动触底或通过分页控件加载更多；`setData` 仅包含展示必需字段。
2. 详情页对入院记录与附件保持并发请求，但使用分段 `setData`：首屏仅注入基础信息和最近记录，其余数据在后台更新；同时为入院记录启用分页或虚拟列表，减少一次性渲染数量。
3. 附件缩略图复用懒加载与失败重试策略，去重重复 `sort/map` 计算，确保同一数据集不会重复排序；为失败场景提供重试逻辑。
4. 性能优化后通过测速：详情页首屏可交互时间（TTI）≤2.5s（弱网场景 ≤4s），详情页首屏请求≤2个主接口；记录测试方法与结果。
5. 更新或新增单元/集成测试覆盖分页、懒加载、重试逻辑，并在文档中记录性能方案与调优参数。

## Tasks / Subtasks

- [ ] 列表分页与骨架（AC1）
  - [ ] 调整列表请求逻辑，初始仅请求必要字段并启用分页/预取机制。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
  - [ ] 更新骨架组件自适应屏高并结合设计令牌。[Source: architecture/coding-standards.md#4-小程序代码规范]
- [ ] 详情分段渲染（AC2）
  - [ ] 在 `detail.js` 中拆分 `setData` 操作，先写入基础信息，随后异步追加记录/附件；引入分页或虚拟列表来限制入院记录渲染数量。[Source: architecture/source-tree.md#source-tree-baseline]
  - [ ] 确保并发请求调度与错误处理一致，提供进度指示。[Source: architecture/tech-stack.md#1-客户端（微信小程序）]
- [ ] 附件优化（AC3）
  - [ ] 复用懒加载并加入失败重试，避免重复排序/映射；如需要新增缓存层，以常量/工具函数实现。[Source: architecture/coding-standards.md#1-通用约定]
- [ ] 性能验证与文档（AC4、AC5）
  - [ ] 编写性能测试脚本或手动测量流程，记录 TTI、请求数等指标。[Source: architecture/tech-stack.md#4-测试体系]
  - [ ] 更新文档说明策略、参数与测试结果，方便后续回归。[Source: architecture/source-tree.md#结构说明]

## Project Structure Notes

- 改动集中于列表/详情页面与附件逻辑，符合目录基线。[Source: architecture/source-tree.md#source-tree-baseline]
- 可能涉及云函数查询参数优化，需与后端沟通保持兼容。

## Dev Notes

- **Previous Story Insights**: 附件懒加载在最新提交中已实现，需在此基础上扩展分页与重试；住户列表现有搜索/筛选（Story 1.9）需与分页兼容。
- **Data Models**: `patients`、`patient_intake_records`、`patient_media` 数据结构详见数据模型文档，分页参数需匹配集合索引。[Source: architecture/data-model.md#集合设计]
- **API Specifications**: 若调整云函数参数（分页、字段裁剪），需更新接口默认值与文档。[Source: architecture/tech-stack.md#3-云函数与后端协作]
- **Component Specifications**: 骨架、虚拟列表与按钮需遵循设计令牌与性能规范。[Source: architecture/coding-standards.md#4-小程序代码规范]
- **File Locations**: 页面、组件与工具文件路径参考 `source-tree` 基线。[Source: architecture/source-tree.md#source-tree-baseline]
- **Testing Requirements**: 运行 Jest、集成测试与性能测量脚本，确保覆盖率与指标达标。[Source: architecture/tech-stack.md#4-测试体系]
- **Technical Constraints**: 分段 `setData` 需控制批次和频率，避免 UI 闪烁或阻塞；分页需处理并发请求与重复触发。

## Definition of Done

- [ ] 验收标准达成并记录性能测试结果
- [ ] 详情与列表性能在弱网环境验证通过
- [ ] 新增/更新测试通过且覆盖率≥80%
- [ ] 文档/变更记录更新
- [ ] 代码通过 lint、CI

## Risk & Mitigation

- **风险**：分页影响既有加载体验
  - **缓解**：提供“加载更多”或自动触底加载并提示状态
- **风险**：分段 `setData` 导致数据闪烁
  - **缓解**：控制批次合并更新，使用骨架或占位符
- **回滚策略**：保留原一次性加载流程，出现问题可回退

## Testing

- 单元测试：分页参数、懒加载重试函数
- 集成测试：列表滚动加载、详情入院记录分页
- 性能测试：记录 TTI、请求数、弱网场景手工测试

## Change Log

| Date       | Version | Description                                      | Author |
| ---------- | ------- | ------------------------------------------------ | ------ |
| 2025-09-23 | v0.1    | 基于 UX 评估输出列表与详情性能优化故事草稿       | Bob   |

## QA Results

- Gate: 未评估
- Rationale: 待 QA 审查
- Must-fix Follow-up: 待定
- Should-monitor: 待定
- Tests: 待定
- Decision: N/A
