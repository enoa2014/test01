# Story 1.1: automated-test-suite

## Status
Ready for Review

## Story
**As a** Developer,
**I want** to run an automated test suite that auto-generates and cleans key patient data after finishing a feature unit,
**so that** I can quickly verify core flows without manual data preparation or residue.

## Acceptance Criteria
1. 提供单一可执行入口（`npm run test:e2e:patients`），该命令调用 `scripts/e2e/run-patient-suite.js` 一键生成覆盖患者建档、入住记录创建、照片/文档上传的测试数据，并自动启动对应端到端脚本；执行期间不出现未捕获异常。
2. 测试执行结束后自动清理前述测试数据（含患者资料、入住记录、上传文件），运行完成时给出成功/失败提示；所有测试数据在生成时需统一使用专用标识（例如患者姓名前缀 `TEST_AUTOMATION_`、入住备注/标签标识），确保清理脚本仅影响测试数据。
3. 测试脚本若检测到业务断言失败或运行报错，会以非零退出码终止，并在日志中输出失败原因；成功路径下返回 0 并标记通过。
4. 在 `README.md` 与脚本输出中提供运行说明，明确开发者在完成功能单元后如何触发命令、需要设置的环境变量（如 `WX_DEVTOOLS_WS`）、常见故障排查步骤，并指向 `docs/e2e-debug-notes.md` 作为深入指南。
5. 清理流程具备幂等性：重复执行不会误删非测试数据，也不会因残留数据导致失败，必要时提供跳过已清理对象的提示。

## Tasks / Subtasks
- [x] 脚本入口设计（AC1，AC3）
  - [x] 在 `scripts/e2e/run-patient-suite.js` 统一封装数据生成、E2E 执行、数据清理子步骤
  - [x] 在 `package.json` 中新增 `test:e2e:patients` npm 脚本，处理执行状态与返回码
- [x] 数据生成实现（AC1）
  - [x] 构造患者基本信息、入住记录、样例文档/照片上传接口调用
  - [x] 为后续断言保留必要的标识字段（如患者 ID、入住记录 ID）
  - [x] 为测试数据添加统一标识（如姓名前缀 `TEST_AUTOMATION_`、入住备注标签、上传文件注释），便于后续清理过滤
- [x] 数据清理实现（AC2，AC5）
  - [x] 仅根据统一标识筛选并删除测试患者、入住记录及关联文件，防止误删正式数据
  - [x] 捕获清理异常并输出诊断信息（日志及终端提示）；对已不存在的测试数据需忽略并继续，保证幂等
- [x] 日志与说明完善（AC3，AC4）
  - [x] 记录成功/失败输出与调试日志路径
  - [x] 更新 `README.md` 与 `docs/e2e-debug-notes.md`，写明命令、所需环境变量及常见故障排查

## Dev Notes
- 参考 `docs/brainstorming-session-results.md` 中“测试数据生成与清理工具”优先级及 QA 规划建议，确保流程闭环。
- 统一入口脚本位于 `scripts/e2e/run-patient-suite.js`，需与 `tests/e2e/specs/` 中现有案例保持一致调用方式。
- 在 `package.json` 新增 `test:e2e:patients`，命令应串联数据生成→测试执行→数据清理流程。
- 所有测试数据需使用统一标识（如姓名前缀 `TEST_AUTOMATION_`、入住备注标签、文件命名后缀）并记录生成 ID 列表，清理时据此过滤，避免误删正式数据。
- 清理逻辑需确保幂等：对已不存在的资源返回成功信息而非报错，同时记录未能清理的残留数据以便人工排查。
- 开发完成后，更新 `README.md` 的测试章节与 `docs/e2e-debug-notes.md`，补充执行步骤、环境变量示例与常见故障处理。
- 现有端到端测试使用 `miniprogram-automator`，调试笔记见 `docs/e2e-debug-notes.md`，需按文档说明配置 `WX_DEVTOOLS_WS` 与 CLI 端口。
- 覆盖流程：患者创建 → 入住记录 → 文档/照片上传 → 数据清理。目标环境为微信小程序自动化；本故事不包含权限审核、日志记录、审计需求。

### Testing
- 端到端测试位于 `tests/e2e/specs/`，沿用 `jest` + `miniprogram-automator`。
- 新增/更新脚本需支持在 Windows PowerShell 与 CI 环境运行。
- 确保脚本可重复执行（先清理残留数据再生成）。

## Change Log
| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-09-21 | v0.1    | 初版故事草稿（自动化测试改造）               | Sarah  |
| 2025-09-21 | v0.2    | 明确脚本入口、npm 命令与运行说明更新范围     | Sarah  |
| 2025-09-21 | v0.3    | 增补测试数据标识与幂等清理策略，状态改为 Approved | Sarah  |

## Dev Agent Record
### Agent Model Used
gpt-5

### Debug Log References
- 无（未执行端到端测试，缺少云开发凭证）

### Completion Notes List
- 构建 `scripts/e2e/run-patient-suite.js`，串联测试数据生成、E2E 执行与幂等清理。
- 在 `package.json` 中新增 `test:e2e:patients` 脚本并同步依赖。
- 更新 `README.md` 与 `docs/e2e-debug-notes.md`，记录新命令及云开发凭证要求。
- 受限于环境凭证，未实测 `npm run test:e2e:patients`，建议在具备云开发密钥的环境执行验证。

### File List
- scripts/e2e/run-patient-suite.js
- package.json
- package-lock.json
- README.md
- docs/e2e-debug-notes.md
- docs/stories/1.1.automated-test-suite.md

## QA Results
