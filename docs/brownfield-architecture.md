# Test01 微信小程序患者管理系统 - Brownfield架构文档

## 简介

本文档记录了Test01微信小程序患者管理系统的**当前实际状态**，包括技术债务、变通方案和实际使用的模式。它作为AI开发代理在此系统上工作的参考文档。

### 文档范围

基于项目中的**头脑风暴结果**和**用户故事**，重点关注以下增强功能相关的领域：

- 患者详情页内联编辑功能（已实现）
- 引导式入住向导系统（已实现）
- 患者列表结构化展示和快捷筛选
- 测试数据生成和清理工具
- 多媒体文件管理系统

### 变更日志

| 日期       | 版本 | 描述               | 作者   |
| ---------- | ---- | ------------------ | ------ |
| 2025-09-21 | 1.0  | 初始brownfield分析 | Claude |

## 快速参考 - 关键文件和入口点

### 理解系统的关键文件

- **主入口**: `wx-project/app.js` - 微信小程序应用初始化
- **配置**: `wx-project/config/envList.js`（自动生成）, `.env` 文件
- **核心业务逻辑**: `cloudfunctions/` 下的各个云函数
- **前端页面**: `wx-project/pages/` - 首页、分析页、患者详情页
- **数据库模型**: 参见 `docs/architecture/data-model.md`
- **关键算法**: Excel解析和数据同步逻辑在 `cloudfunctions/readExcel/index.js`

### 增强功能影响区域

基于头脑风暴结果，以下模块将受到计划中增强功能的影响：

- **患者详情编辑**: `wx-project/pages/patient-detail/detail.js` + `cloudfunctions/patientIntake/index.js` ✅已实现
- **引导式向导**: `wx-project/pages/patient-intake/wizard/wizard.js` ✅已实现
- **列表结构化**: `wx-project/pages/index/index.js` 🚧待实现
- **测试数据工具**: `scripts/e2e/` + 权限控制 🚧部分实现

## 高层架构

### 技术概要

这是一个**真实的生产系统**，专为中国市场设计，具有以下特点：

- 中文用户界面和业务逻辑
- 符合微信生态系统要求
- 腾讯云基础设施集成
- 重视数据安全和用户隐私

### 实际技术栈（来自package.json）

| 类别     | 技术                         | 版本    | 备注                 |
| -------- | ---------------------------- | ------- | -------------------- |
| 运行时   | Node.js                      | 16.x+   | 微信云开发环境       |
| 前端框架 | 微信小程序原生               | 最新    | 使用微信开发者工具   |
| 后端服务 | wx-server-sdk                | 最新    | 腾讯云开发SDK        |
| 数据库   | 腾讯云开发数据库             | NoSQL   | MongoDB兼容          |
| 存储服务 | 腾讯云存储                   | 最新    | 文件上传和CDN        |
| 测试框架 | Jest + miniprogram-automator | 30.1.3  | E2E自动化测试        |
| 数据处理 | xlsx                         | ^0.18.5 | Excel文件解析        |
| 图像处理 | jimp                         | 最新    | 缩略图生成和图像处理 |

### 仓库结构真实情况

- 类型: 单仓库（Monorepo）
- 包管理器: npm
- 特殊情况: 微信小程序项目结构，需要微信开发者工具

## 源码树和模块组织

### 项目结构（实际）

```text
test01/
├── wx-project/                   # 前端微信小程序代码
│   ├── app.js                   # 应用入口点，云开发初始化
│   ├── config/
│   │   ├── envList.js           # 自动生成的环境配置
│   │   └── patient-detail-fields.js  # 患者详情字段配置（新增）
│   ├── pages/
│   │   ├── index/               # 患者列表页（主页）
│   │   ├── analysis/            # 数据分析页
│   │   ├── patient-detail/      # 患者详情页（支持内联编辑 ✅）
│   │   └── patient-intake/      # 患者入住向导系统 ✅
│   └── utils/                   # 工具函数
├── cloudfunctions/              # 后端云函数
│   ├── readExcel/              # Excel数据导入和解析
│   ├── patientMedia/           # 文件管理系统
│   ├── patientIntake/          # 患者入住和更新API
│   └── helloWorld/             # 示例函数
├── tests/                      # 测试基础设施
│   ├── e2e/                    # E2E测试（miniprogram-automator）
│   └── service/                # 云函数单元测试
├── scripts/                    # 构建和工具脚本
│   ├── sync-config.js          # 环境配置同步
│   └── e2e/                    # E2E测试数据管理
├── docs/                       # 项目文档
│   ├── stories/                # 用户故事文档
│   ├── architecture/           # 架构文档
│   └── qa/                     # QA门控文档
└── project.config.json         # 微信开发者工具配置（自动生成）
```

### 关键模块及其目的

- **用户管理**: `readExcel/index.js` - 处理Excel导入的患者数据，包含复杂的字段映射逻辑
- **患者入住**: `patientIntake/index.js` - 患者资料管理，支持CRUD操作和乐观锁机制 ✅
- **文件管理**: `patientMedia/index.js` - 多媒体文件上传，配额控制，缩略图生成
- **前端路由**: 微信小程序原生路由系统，基于页面文件夹结构

## 数据模型和API

### 数据模型

参考实际模型文件：

- **患者主表**: 参见 `docs/architecture/data-model.md`
- **入住记录**: 参见云函数中的集合定义
- **媒体文件**: 参见 `cloudfunctions/patientMedia/index.js` 中的配额和元数据管理

### API规范

- **Excel导入**: `readExcel` 云函数，action-based路由
- **患者管理**: `patientIntake` 云函数，支持getPatientDetail, updatePatient等操作 ✅
- **文件管理**: `patientMedia` 云函数，完整的文件生命周期管理
- **手工端点**: 微信小程序云函数调用模式，不是传统REST API

## 技术债务和已知问题

### 关键技术债务

1. **Excel解析服务**: `readExcel/index.js` 中的字段映射逻辑复杂，硬编码了很多业务规则
2. **环境配置**: 依赖 `.env` 文件和自动生成脚本，环境切换需要重新构建配置
3. **数据同步**: Excel数据到患者主表的同步逻辑，存在数据不一致的风险
4. **文件存储**: 文件配额管理依赖复杂的数据库事务，性能瓶颈点

### 变通方案和注意事项

- **环境变量**: 必须运行 `npm run sync-config` 来同步配置，否则微信开发者工具无法正确识别环境
- **数据库集合**: 云函数会自动创建不存在的集合，但这可能导致权限问题
- **测试数据**: 使用 `TEST_AUTOMATION_` 前缀标识测试数据，自动清理机制已部分实现 ✅
- **编码问题**: 项目中存在UTF-8 BOM编码问题，已有 `npm run fix-encoding` 修复脚本

## 集成点和外部依赖

### 外部服务

| 服务           | 用途         | 集成类型   | 关键文件                       |
| -------------- | ------------ | ---------- | ------------------------------ |
| 微信云开发     | 后端基础设施 | SDK        | `wx-project/app.js`            |
| 腾讯云存储     | 文件存储     | 云函数SDK  | `cloudfunctions/patientMedia/` |
| 微信开发者工具 | 开发环境     | CLI/自动化 | `tests/e2e/config/devtools.js` |

### 内部集成点

- **前后端通信**: 微信云函数调用，基于action参数路由
- **数据库操作**: wx-server-sdk，支持事务但有限制
- **文件处理**: 云存储 + 本地缩略图生成（Jimp库）

## 开发和部署

### 本地开发设置

实际可用的步骤（非理想步骤）：

1. **环境配置**:

   ```bash
   # 必须先配置环境变量
   cp .env.example .env
   # 编辑 .env 文件，设置必需变量
   npm run sync-config  # 生成微信开发者工具配置
   ```

2. **安装依赖**:

   ```bash
   npm install
   # 注意：云函数有独立的node_modules，微信开发者工具会自动处理
   ```

3. **微信开发者工具**: 必须使用微信开发者工具打开项目，VSCode等IDE无法直接运行

### 构建和部署过程

- **构建命令**: 无传统构建过程，微信开发者工具处理打包
- **部署**: 通过微信开发者工具上传代码到微信云开发环境
- **环境**: 开发、测试、生产环境通过腾讯云开发控制台管理

## 测试现状

### 当前测试覆盖

- **E2E测试**: 使用miniprogram-automator，自动化控制微信开发者工具
- **单元测试**: 云函数部分单元测试，覆盖率较低
- **集成测试**: 通过E2E测试覆盖
- **手工测试**: 主要QA方法，特别是UI/UX验证

### 运行测试

```bash
npm test                    # 运行E2E测试
npm run test:e2e:patients   # 患者模块完整测试流程（含数据管理）✅
npm run test:service        # 云函数单元测试
```

### 测试基础设施特点

- **数据管理**: 测试数据生成和清理已自动化 ✅
- **环境隔离**: 通过数据前缀而非独立环境
- **DevTools集成**: 需要配置微信开发者工具CLI路径

## 增强功能PRD - 影响分析

基于 `docs/brainstorming-session-results.md` 中的需求，以下是影响分析：

### 已实现的功能 ✅

#### 1. 患者详情页内联编辑

**实现状态**: ✅ 完成
**涉及文件**:

- `wx-project/pages/patient-detail/detail.js` - 前端编辑逻辑
- `wx-project/config/patient-detail-fields.js` - 字段配置系统
- `cloudfunctions/patientIntake/index.js` - 后端更新API，支持乐观锁
- **完整的表单验证和错误处理**
- **患者操作审计日志系统**

#### 2. 引导式患者入住向导

**实现状态**: ✅ 完成
**涉及文件**:

- `wx-project/pages/patient-intake/wizard/wizard.js` - 5步引导流程
- **草稿保存和恢复功能**
- **表单校验和必填项检查**

### 需要实现的功能 🚧

#### 3. 患者列表结构化展示

**需要修改的文件**:

- `wx-project/pages/index/index.js` - 添加标签/卡片展示
- 后端API可能需要返回额外字段
- **快捷筛选保存与调用功能**

#### 4. 测试数据生成工具

**需要新增的功能**:

- 在高级功能入口集成测试数据按钮
- 权限控制（仅测试账号可见）
- **部分实现**: 已有E2E测试数据管理脚本

### 集成考虑

- **必须遵循现有的云函数action路由模式**
- **前端状态管理使用微信小程序原生方式**
- **文件上传必须通过现有的patientMedia云函数**
- **权限检查必须与现有授权系统集成**

## 附录 - 有用的命令和脚本

### 常用命令

```bash
npm install                 # 安装依赖
npm run sync-config         # 同步环境配置到微信开发者工具
npm run fix-encoding        # 修复文件编码问题
npm test                    # 运行E2E测试
npm run test:e2e:patients   # 完整患者测试流程
```

### 调试和故障排除

- **日志**: 微信开发者工具控制台 + 腾讯云开发日志
- **调试模式**: 微信开发者工具内置调试器
- **常见问题**: 参见 `docs/e2e-debug-notes.md`
- **环境问题**: 检查 `.env` 文件和 `npm run sync-config` 输出

### 微信开发者工具特定操作

- **CLI控制**: 需要启用"命令行调用"和"自动化测试"
- **端口配置**: E2E测试依赖特定端口，参见测试配置
- **项目导入**: 必须导入根目录，而非子文件夹

## 开发约定和模式

### 云函数开发模式

- **Action路由**: 使用 `event.action` 参数区分不同操作
- **错误处理**: 统一的错误响应格式，包含错误码和详细信息
- **事务支持**: 使用 `db.runTransaction` 确保数据一致性
- **集合管理**: 自动创建不存在的集合，但要注意权限

### 前端开发模式

- **页面结构**: 遵循微信小程序页面生命周期
- **数据缓存**: 使用微信小程序本地存储，注意TTL管理
- **云函数调用**: 统一的错误处理和加载状态管理
- **用户体验**: 中文界面，符合中国用户习惯

### 测试开发模式

- **数据标识**: 测试数据使用 `TEST_AUTOMATION_` 前缀
- **自动清理**: 测试结束后自动清理测试数据
- **环境隔离**: 通过数据标识而非独立环境实现隔离
- **断言策略**: 基于实际UI元素和数据状态的断言

---

**重要提醒**: 这是一个活跃的生产系统，修改时必须考虑向后兼容性和数据安全性。所有变更都应该通过完整的测试流程验证。
