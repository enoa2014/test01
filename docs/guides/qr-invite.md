# 二维码邀请与注册（小程序码方案）

本文档说明如何用二维码（小程序码）完成新成员注册与权限开通，适用于社工/志愿者/家长三类角色。

## 总体思路
- 管理端为“邀请”生成对应的小程序码（不限量码），扫码后直达“邀请码激活页”。
- 参数携带方式：使用  的  携带 8 位邀请码，约定格式 。
- 前端页面自动解析  并完成“验证→激活”（已内置，见下）。

## 参数规范
- 码种：小程序“无限制小程序码”（getwxacodeunlimit）
- 路径：
- scene：最多 32 个字符，推荐 ，示例：
- 可扩展：如需绑定范围，可在 DB 侧通过  关联合法范围，避免在  中暴露信息。

## 云函数生成二维码（示例）
以 rbac 云函数为例新增 （仅管理员可调用）：

i:invite-qrcode/.png

> 说明： 返回 Buffer；上传到云存储后将  保存到邀请记录，管理端可展示与下载。

## 管理端集成（建议）
- “邀请管理”列表页新增“生成二维码”按钮，调用 。
- 支持复制下载/打印；批量生成（活动招募时）
- 展示二维码下方的使用次数、剩余天数、适用范围（院区/患者）。

## 前端自动解析与激活
- 页面： 已支持解析 / 参数并自动执行验证与激活：
  - 解析规则：
    - （推荐）
    -  或 
    - 纯 8 位码
  - 解析成功后自动触发 ，无需手动输入。

> 代码位置：（onLoad 解析逻辑）。

## 志愿者/家长注意点
- 志愿者：可为每个“活动/班次”生成独立邀请码/二维码；使用后即获得该活动范围内权限。
- 家长：二维码应在现场/定向发放；绑定患者范围在邀请记录中定义，避免在  直接暴露。

## 安全与并发
- 并发扣减： 已使用事务处理，确保  原子扣减（避免超发）。
- 有效期：过期码自动判无效；管理端可一键撤销并重新生成。
- 限速：短信验证码与邀请生成应限速；对外二维码不含敏感信息。

## 流程示例
1) 管理员在“邀请管理”创建志愿者邀请（活动 A）→ 生成二维码并张贴在活动入口。
2) 新志愿者用微信扫码 → 自动进入邀请激活页 → 验证手机 → 同意条款 → 成功激活“志愿者（活动 A）”。
3) 管理端“邀请管理”显示使用 +1， 递减；审计日志记录本次激活。

## 故障排除
- 扫码后无反应：确认二维码为小程序码（非普通二维码），并检查  是否存在。
- 激活失败：检查邀请码是否过期/次数用尽；或是否被撤销。
- 非微信内扫码：应引导用户在微信内长按识别小程序码。

