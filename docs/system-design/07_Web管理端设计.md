# Web 管理端设计（不编码方案）

本设计文档定义 Web 管理端（web-admin）的范围、信息架构、主要功能、接口契约、权限模型、审计与安全策略，以及迭代计划。目标是支撑用户与权限管理、导入/导出、审批与审计等运营场景；本版本仅为设计与分析，不涉及编码实现。

## 1. 目标与非目标

- 目标
  - 为管理员/社工提供安全、可审计的后台：用户与角色管理、审批流、邀请、导入/导出、审计查询。
  - 与现有云函数与数据模型直接对接，优先复用 CloudBase 自定义登录与数据库。
  - 与小程序分工：小程序承载家长/志愿者自助与日常业务；管理端承载高权限与批量/审批/导出类功能。
- 非目标（后续版本）
  - 复杂统计报表平台、可视化大屏。
  - 多机构/多租户分级权限（当前为单机构）。
  - 细粒度字段脱敏策略配置 UI（V1 以固定策略为主）。

## 2. 角色与权限

- 角色集合（与 V1 方案一致）：`admin`、`social_worker`、`volunteer`、`parent`、`guest`
- 管理端访问门槛：仅 `admin` 与 `social_worker` 能登录管理端；其中：
  - `admin`：全量功能（用户与角色、审批、导入导出、审计、设置）。
  - `social_worker`：用户审批、邀请、患者导出（本机构，单机构下等同于全部）、审计只读；不可管理管理员。
- 后续可扩展：为 `social_worker` 开启可选的“患者资料导入”能力开关（运营策略）。

## 3. 技术栈与运行方式

- 技术栈：Vite + React + TypeScript（已在 `web-admin` 中配置），CloudBase JS SDK + 自定义登录（auth 云函数 ticket）。
- 运行：本地 dev 由 Vite 启动，middleware 代理调用云函数（见 `web-admin/vite.config.ts`）。
- 环境变量：
  - `VITE_TCB_ENV_ID`（优先）/`TCB_ENV[_ID]`/`CLOUDBASE_ENV_ID`
  - `VITE_AUTH_FUNCTION_NAME`（默认 `auth`）
  - 云函数管理/调用凭证用于本地代理（`TENCENTCLOUD_SECRETID`、`TENCENTCLOUD_SECRETKEY`）。

## 4. 信息架构（IA）与路由

- 顶部导航/侧边导航：
  - 概览（Dashboard） `/`
  - 用户管理 `/users`
  - 角色绑定 `/roles`
  - 申请审批 `/approvals`
  - 邀请管理 `/invites`
  - 导入 Excel `/import`
  - 导出中心 `/export`
  - 审计日志 `/audit`
  - 系统设置 `/settings`
- 路由守卫：进入任意受限路由前，校验登录态与角色；无权限跳转到“无权页面/登录”。

## 5. 功能模块说明

- 概览（Dashboard）
  - 今日关键指标（待审批数、近 7 日导入条数、导出次数、异常日志计数）。
  - 快捷入口（去审批、创建邀请、导入 Excel、查看审计）。
- 用户管理（Users）
  - 列表：头像/姓名/手机号/最近登录/状态/角色概览。
  - 筛选：按角色、状态、关键字（openid/姓名/手机号）。
  - 操作：查看详情、禁用/启用、查看其角色绑定与申请记录（只读）。
- 角色绑定（Role Bindings）
  - 列表：用户、当前活跃角色、绑定时间、备注。
  - 操作：为用户授予/回收 `social_worker`/`volunteer`/`parent`，设置有效期（可选）。
  - 校验：禁止修改/移除 `admin`；操作写审计。
- 申请审批（Role Requests）
  - 场景：志愿者/家长升级申请、志愿者的“联系方式访问”申请（后续 V1.5）。
  - 流程：查看资料 → 通过/驳回（填写理由）→ 写入绑定或 access grant。
- 邀请管理（Invites）
  - 创建邀请：角色（志愿者/家长）、可用次数、有效期、关联患者（可选，用于家长）。
  - 列表：状态（未用/部分使用/已用尽/过期）、创建人、使用记录。
- 导入 Excel（Import）
  - 选择 Excel（或指定云存储 FileID）→ 解析预览（列映射、数据量）→ 执行导入 → 结果/错误导出。
  - 历史导入任务：时间、操作人、成功/失败条数、下载日志。
- 导出中心（Export）
  - 支持导出住户明细；社工导出带脱敏策略（可选开关）。
  - 导出记录留痕：导出人/时间/范围，文件名加水印标记。
- 审计日志（Audit）
  - 过滤：时间、操作者、动作（`patient.update`/`export.detail`/`role.approve` 等）、目标（患者/用户）。
  - 只读详情：变更摘要、来源 IP/UA（如有）。
- 系统设置（Settings）
  - 环境信息：envId、函数健康检查、存储可用量。
  - 安全：导出脱敏策略开关（仅管理员）、登录态刷新策略。

## 6. 界面与交互概述（关键页面）

- 登录页
  - 自定义登录：用户名/口令 → 调 `auth.login` 获取 ticket → CloudBase `customAuthProvider().signInWithTicket`。
  - 登录失败提示：账号不存在/已禁用/口令错误。
- 用户列表
  - 表格 + 筛选栏 + 右侧抽屉详情；分页 20/页；支持关键字搜索。
- 角色绑定
  - 选择用户 → 选择角色 → 设置有效期（可选）→ 确认弹窗（写审计）。
- 审批中心
  - 双列布局：左侧列表（状态过滤：pending/approved/rejected），右侧详情与操作。
- 导入 Excel
  - 三步：上传/选择 → 预览 → 执行与进度条 → 结果页（错误下载）。
- 导出中心
  - 筛选条件 → 预估条数与字段策略 → 确认导出 → 任务完成提示（含审计编号）。

## 7. 接口/云函数契约（建议）

说明：命名与 action 为建议，最终以实现为准。管理端优先经由云函数调用，而非直连数据库。

- `auth`（已有）
  - `seedAdmin`：创建首管（受环境变量保护）。
  - `login`：用户名/口令 → ticket + 用户信息。
- `rbac`（新增）
  - `getCurrentUser`：返回用户基本信息与角色集合。
  - `listUsers`：分页/筛选用户；支持关键字查询。
  - `listRoleBindings(userId?)`、`addRoleBinding`、`removeRoleBinding`。
  - `listRoleRequests`、`approveRoleRequest`、`rejectRoleRequest`。
  - `createInvite`、`revokeInvite`、`listInvites`。
- `patientProfile`（既有）
  - `list`/`detail`/`create`/`update`/`export`（受 V1 鉴权拦截）。
- `readExcel`（既有/增强）
  - `parse`：解析预览；`import`：执行导入；`listJobs`：历史任务；`getJob`：任务详情。
- `audit`（新增）
  - `listLogs`：分页检索审计日志；`getLog`：详情。

返回结构统一：`{ success: boolean, data?: any, error?: { code, message, details? } }`。

## 8. 数据模型映射

- 复用 V1 文档中的：`users`、`roleBindings`、`admins`、`auditLogs`、`invites`、`roleRequests`；
- 可选（V1.5）：`accessGrants`（志愿者联系方式访问授权，按患者维度、可过期）。

## 9. 权限校验与前端路由守卫

- 登录后拉取 `getCurrentUser`；若角色不在 `['admin','social_worker']`，则拒绝进入。
- 页面/按钮级显示控制仅作“体验优化”，所有写操作依赖后端校验。

## 10. 审计与安全

- 审计范围：角色授予/回收、审批结果、导入/导出、患者更新、附件删除。
- 审计内容：操作人、动作、目标、摘要、时间；可选 IP/UA。
- 导出水印：文件名/表头嵌入导出人与时间戳；社工导出默认脱敏（可在设置开关调整）。
- 风险操作二次确认：批量回收、删除、导入执行、导出执行。
- 会话安全：定期刷新登录态；登出清理本地状态。

## 11. 错误与空态

- 错误提示遵循统一格式：业务可读信息 + 错误码（用于排障），避免泄露内部细节。
- 空态：列表空、暂无申请、暂无审计记录，提供返回与引导操作。

## 12. 性能与可用性

- 列表分页/增量加载，服务端排序与过滤。
- 大型导入/导出采用“任务化”异步模型，前端轮询或 Webhook（可选）获取进度。
- 慢操作提供取消/重试与去重（幂等键）。

## 13. 测试策略

- 单测：权限判定与接口适配器（API 层）、数据映射与边界（空列表/错误）。
- E2E（Playwright 已就绪）：
  - 登录 → 访问守卫 → 用户列表可见性。
  - 角色授予/回收 → 再次拉取用户信息校验。
  - 审批通过/驳回 → 申请状态变更可见，审计记录存在。
  - 导入/导出流程跑通（小规模样例），导出文件名带水印。

## 14. 迭代计划（建议）

- 里程碑 M0（1 周）：
  - 登录页与路由守卫；概览占位；对接 `getCurrentUser`；用户列表只读。
- 里程碑 M1（1–2 周）：
  - 角色绑定、审批、邀请三大模块；审计检索只读；导出中心（最小版）。
- 里程碑 M2（1–2 周）：
  - 导入 Excel 全流程；导出策略水印；设置页开关；完善审计记录。
- 后续（V1.5–V2.0）：
  - `accessGrants`（联系方式访问审批）、活动/报名（guest）、字段级脱敏策略 UI、异常风控面板。

## 15. 开放问题

- 是否允许社工创建/回收志愿者与家长绑定，还是仅管理员可操作？（建议：社工可管理非管理员角色）
- 导出脱敏策略默认级别与开关可见范围？（建议：默认脱敏，管理员可调整）
- 导入 Excel 是否总是全量覆盖，还是“仅新增/仅更新/智能合并”可选？（建议：提供三种模式，默认“智能合并”）

---

本设计与 `docs/system-design/06_V1_登录与权限最小实现.md` 协同：管理端主要服务于 RBAC 管控、审批与审计，以及导入/导出等高权限操作；小程序端承载日常业务与自助。此设计不涉及代码变更，可作为后续实现的蓝图与验收基准。

