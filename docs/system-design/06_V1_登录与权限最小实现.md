# V1 登录与权限最小实现（RBAC 基础版）

本文档在核对现有系统设计（docs/system-design）与代码实现的基础上，给出一份“第一版（V1）最小可用”的登录与权限方案，用于尽快为当前小程序/云函数加上基础的访问控制。仅设计与分析，不涉及编码实现。

## 1. 背景与目标

- 背景：现有云函数（如 `patientProfile`、`patientIntake`、`patientMedia`、`readExcel`）对权限控制较弱或缺失，任意已登录用户可能越权访问或修改敏感数据。
- 目标：
  - 提供“登录识别 + 资源级授权拦截”的最小能力，使非授权用户无法访问患者档案/入退住/导入导出/媒体资料等敏感资源。
  - 体系与后续的完整 RBAC 兼容，便于迭代到字段级/审批流等更细粒度控制。
- 方法：基于微信云开发上下文（`OPENID`/自定义登录 `customUserId`）识别当前用户，按绑定角色进行资源级校验。

## 2. 范围（In/Out of Scope）

- In Scope（V1 落地）：
  - 资源级授权：`patientProfile`、`patientIntake`、`patientMedia`、`readExcel` 四大类云函数入口统一加拦截。
  - 默认角色：无绑定即为 `guest`，仅可进行非敏感操作（例如未来公开活动），对患者/导入导出/媒体一律拒绝。
  - 管理入口：沿用 `cloudfunctions/auth` 的管理员自定义登录（web-admin），管理员视为 `admin`。
  - 统一错误码/响应结构：`UNAUTHORIZED`、`FORBIDDEN`、`ROLE_REQUIRED` 等。
- Out of Scope（后续版本）：
  - 组织/站点分级、权限继承与字段级脱敏。
  - 志愿者查看联系方式的申请审批流、导出审批与水印策略。
  - 活动/报名与消息留痕（游客能力）。

## 3. 角色模型（V1 收敛）

- 角色集合：`admin`、`social_worker`、`volunteer`、`parent`、`guest`
  - `admin`：管理员（web-admin 自定义登录成功且存在于 `admins` 集合）
  - `social_worker`：社工（具备机构内敏感资源的增删改查）
  - `volunteer`：志愿者（V1 期间无患者资源权限）
  - `parent`：家长（V1 期间无患者资源权限）
  - `guest`：默认身份（无权限）

权限基线（V1）：

- `patient.*`（列表/详情/创建/更新/导出）：仅 `admin | social_worker`
- `intake.*`（入住/离开/条目维护）：仅 `admin | social_worker`
- `media.*`（患者资料上传/列表/删除/预览）：仅 `admin | social_worker`
- `readExcel.*`（导入/解析/同步）：仅 `admin | social_worker`
- 其余角色（`volunteer`、`parent`、`guest`）：上述资源一律拒绝

## 4. 数据模型与索引

为避免引入复杂度，V1 仅引入两张基础表，并兼容现有 `admins`：

- `users`
  - 字段：`_id`, `openid`(唯一), `unionid?`, `profile?`, `status`('active'), `createdAt`, `updatedAt`
  - 用途：首次调用云函数时落库（如未存在），便于后续角色绑定与审计。
  - 索引：`openid` 唯一。
- `roleBindings`
  - 字段：`_id`, `userOpenId`, `role`('admin'|'social_worker'|'volunteer'|'parent'|'guest'), `scopeType`('global'), `state`('active'), `createdAt`
  - 用途：按用户绑定角色，V1 仅 global 作用域。
  - 索引：`userOpenId` 普通索引（常查）。
- 兼容：`admins`（已用于 web-admin 自定义登录，在鉴权合并时识别为 `admin`）。

## 5. 身份识别与权限判定

- 身份来源：
  - 小程序：云函数上下文 `OPENID`（`cloud.getWXContext()`）
  - Web-Admin：自定义登录 `customUserId`（`auth` 函数签发 ticket 后由 JS SDK 注入）
- 角色解析：
  1) 根据 `OPENID/customUserId` 查询 `roleBindings`；
  2) 若命中 `admins`（web-admin 管理员），合并为 `admin`；
  3) 未命中则视为 `guest`。
- 判定规则（V1）：`hasAnyRole(user, ['admin','social_worker'])` 放行，否则 `FORBIDDEN`。
- 统一错误：
  - `UNAUTHORIZED`：无法解析登录上下文（正常调用云函数应能获取 OPENID，几乎只在异常环境出现）
  - `FORBIDDEN`：已识别用户但无对应资源权限
  - `ROLE_REQUIRED`：显式声明需要某角色（可选）

## 6. 云函数拦截点（按资源落点）

- 患者档案 `cloudfunctions/patientProfile/index.js`
  - 典型入口：
    - 列表：`handleGetPatientsList`（参考文件 patientProfile/index.js:2380）
    - 详情：`handleGetPatientDetail`（patientProfile/index.js:2680）
    - 创建：`handleCreatePatient`（patientProfile/index.js:2740 左右）
    - 更新：`handleUpdatePatient`（patientProfile/index.js:2860 左右）
    - 导出：`handleExportPatients`（patientProfile/index.js:2443）
  - 动作：每个入口调用前统一 `requireRole(['admin','social_worker'])`。

- 入退住 `cloudfunctions/patientIntake/index.js`
  - 典型入口：入住/离开与条目维护（示例使用 OPENID 的片段见 patientIntake/index.js:1775、2029、2076）。
  - 动作：各入口前统一 `requireRole(['admin','social_worker'])`。

- 媒体资料 `cloudfunctions/patientMedia/index.js`
  - 当前 `assertAuthorized` 返回“全开放”模式（patientMedia/index.js:200 左右），存在越权风险。
  - 动作：替换为 `requireRole(['admin','social_worker'])` 风格的强校验，应用在 `prepareUpload`、`confirmUpload`、`list`、`delete`、`previewText`、`cleanupIntakeFiles` 等动作。

- Excel 导入 `cloudfunctions/readExcel/index.js`
  - 当前未见鉴权（解析、合并、写入患者数据），需在主入口加 `requireRole(['admin','social_worker'])`。

- 组合服务 `cloudfunctions/patientService/index.js`
  - 透传至 `patientProfile`，无需重复实现，继承其校验。

> 注：以上“文件:行号”仅用于定位参考，具体实现按最终代码为准。

## 7. 统一响应结构

为便于前后端处理与测试，错误响应统一为：

```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "无权限",
    "details": null
  }
}
```

成功响应维持各函数既有格式，不做变更。

## 8. 前端（小程序）最小改造

- 会话注入：小程序调用云函数天然带入 `OPENID`，无需额外登录流程。
- UI 可见性（可选）：
  - 在首页及患者相关页面进入前检查一个轻量的“当前用户角色”接口（可复用后端 `requireRole` 的“探测式”调用或新增 `session.getCurrentUser`）。
  - 无权限则隐藏入口或展示“联系社工开通权限”提示；最终以后端拦截为准。

## 9. 初始化与配置

- 管理员初始化（web-admin）：
  - 使用 `cloudfunctions/auth` 的 `seedAdmin` 动作创建首个管理员；随后通过 `login` 获取 ticket 登录。
  - 文件参考：`cloudfunctions/auth/index.js`
- 社工绑定：
  - 通过控制台手动往 `roleBindings` 插入记录：`{ userOpenId: '<OPENID>', role: 'social_worker', scopeType: 'global', state: 'active' }`。
- 环境变量：
  - 确保小程序与云函数 `env` 一致；web-admin 自定义登录需设置私钥相关环境变量（`TCB_CUSTOM_LOGIN_PRIVATE_KEY_ID`、`TCB_CUSTOM_LOGIN_PRIVATE_KEY`）。

## 10. 安全与合规（V1）

- 最小权限：默认 `guest`；敏感资源仅 `admin|social_worker`。
- 审计（推荐）：优先记录高风险动作（创建/更新/导出/导入/删除媒体），即使先落库到简单的 `auditLogs` 也可，为后续留痕监管打基础（可在 V1+ 实施）。
- 错误提示：避免泄露内部信息；对外只提示“权限不足/请联系社工”。

## 11. 风险与限制

- 角色稀疏：V1 将 `volunteer/parent` 均视为无权访问敏感资源，短期可能影响测试体验（可通过临时绑定社工账号规避）。
- 兼容性：`patientMedia` 由“开放模式”改为“受限模式”，可能影响已有临时脚本或页面；需同步前端提示。
- 字段级脱敏与审批流未上线：联系方式等敏感字段暂不开放给志愿者/家长。

## 12. 测试与验收

- 服务侧（`npm run test:service` 可逐步补用例；V1 先以手测为主）：
  - 未绑定用户：调用 `patientProfile/list`、`patientIntake/*`、`patientMedia/*`、`readExcel/*` → 返回 `FORBIDDEN`。
  - 绑定社工：上述调用全部通过；导入 Excel 后可在 `patients`/`patient_intake_records` 看到变更。
  - 媒体：社工可上传/删除；未绑定用户均被拒绝。
- 小程序端（`npm run test:e2e:patients` 可后续补充）：
  - 非社工账号：入口隐藏/灰显；直接操作被后端拒绝并提示。
  - 社工账号：可访问与操作核心流程（列表/详情/编辑/入退住/附件）。

## 13. 迭代路线（V1 → V1.5/2.0）

- V1.5：
  - 补充字段级白名单（家长/志愿者可见字段）、导出脱敏策略。
  - 引入 `accessGrants` 支持志愿者按患者申请“联系方式访问”，并设置时效。
  - 活动/报名（`guest` 实用化）：`events`、`eventRegistrations` 与只读广播消息。
- V2.0：
  - 机构/站点分级、权限继承、审计后台与风控告警。

---

## 附：与现有文档的对齐关系

- 对齐项：
  - 最小权限原则、审计追踪原则（参考 02_角色权限设计.md）。
  - 采用云开发平台的认证能力（参考 04_技术架构设计.md）。
- 差异项：
  - 不实现多级组织/权限继承/JWT；改为“云函数上下文 + 简单角色绑定”的轻量方案（便于快速上线）。
  - 不上线字段级与导出审批；以后续版本实现。

