# 04_技术架构设计

## 技术架构概览

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    用户接入层 (Access Layer)                │
├─────────────────────────────────────────────────────────────┤
│  微信小程序  │  Web管理端  │  H5页面  │  第三方系统        │
├─────────────────────────────────────────────────────────────┤
│                    网关层 (Gateway Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  API网关  │  负载均衡  │  限流熔断  │  安全防护          │
├─────────────────────────────────────────────────────────────┤
│                    应用层 (Application Layer)              │
├─────────────────────────────────────────────────────────────┤
│  用户服务  │  住户服务  │  关怀服务  │  活动服务  │  系统服务│
├─────────────────────────────────────────────────────────────┤
│                    服务层 (Service Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  认证服务  │  权限服务  │  消息服务  │  文件服务  │  日志服务│
├─────────────────────────────────────────────────────────────┤
│                    数据层 (Data Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  云数据库  │  云存储  │  缓存系统  │  消息队列  │  日志系统 │
├─────────────────────────────────────────────────────────────┤
│                    基础设施层 (Infrastructure Layer)        │
├─────────────────────────────────────────────────────────────┤
│  微信云开发  │  CDN加速  │  监控告警  │  日志收集  │  备份恢复│
└─────────────────────────────────────────────────────────────┘
```

## 技术选型

### 前端技术栈

#### 微信小程序
- **框架**: 微信小程序原生框架
- **语言**: JavaScript/TypeScript
- **样式**: WXSS
- **状态管理**: 自定义状态管理
- **网络请求**: wx.request
- **数据存储**: wx.setStorageSync/wx.getStorageSync
- **地图服务**: 微信地图组件
- **支付服务**: 微信支付

#### Web管理端
- **框架**: Vue.js 3.x
- **UI组件库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **HTTP客户端**: Axios
- **构建工具**: Vite
- **代码规范**: ESLint + Prettier
- **CSS预处理器**: SCSS

#### H5页面
- **框架**: Vue.js 3.x
- **移动端适配**: Vant UI
- **响应式设计**: 媒体查询 + REM
- **触摸优化**: Touch事件处理
- **性能优化**: 懒加载 + 虚拟滚动

### 后端技术栈

#### 云开发平台
- **平台**: 微信云开发
- **数据库**: 云数据库 (MongoDB)
- **存储**: 云存储
- **函数**: 云函数 (Node.js)
- **网络**: HTTP API
- **认证**: 微信登录
- **监控**: 云开发监控

#### 开发语言
- **主要语言**: JavaScript/TypeScript
- **运行环境**: Node.js 16.x
- **包管理**: npm/yarn
- **模块系统**: CommonJS/ES6

#### 数据库
- **主数据库**: 云数据库 (MongoDB)
- **缓存**: 云开发内置缓存
- **文件存储**: 云存储
- **搜索**: 数据库全文搜索

### 开发工具链

#### 开发环境
- **IDE**: VS Code
- **小程序工具**: 微信开发者工具
- **版本控制**: Git
- **调试工具**: Chrome DevTools
- **API测试**: Postman

#### 构建部署
- **CI/CD**: GitHub Actions
- **代码检查**: ESLint
- **单元测试**: Jest
- **端到端测试**: Playwright
- **性能监控**: 微信云监控

## 微服务架构

### 服务划分

#### 1. 用户服务 (User Service)
**职责**:
- 用户认证和授权
- 用户信息管理
- 角色权限管理
- 登录注册管理

**技术实现**:
```javascript
// 用户服务云函数
const cloud = require('wx-server-sdk')
cloud.init()

exports.main = async (event, context) => {
  const { action, data } = event

  switch (action) {
    case 'login':
      return await login(data)
    case 'register':
      return await register(data)
    case 'getUserInfo':
      return await getUserInfo(data)
    default:
      throw new Error('Unknown action')
  }
}
```

#### 2. 住户服务 (Resident Service)
**职责**:
- 家庭信息管理
- 入住申请管理
- 住宿记录管理
- 关怀记录管理

**技术实现**:
```javascript
// 住户服务云函数
const cloud = require('wx-server-sdk')
cloud.init()

const db = cloud.database()

exports.main = async (event, context) => {
  const { action, data } = event

  switch (action) {
    case 'createFamily':
      return await createFamily(data)
    case 'updateFamily':
      return await updateFamily(data)
    case 'getFamilyList':
      return await getFamilyList(data)
    default:
      throw new Error('Unknown action')
  }
}
```

#### 3. 关怀服务 (Care Service)
**职责**:
- 关怀项目管理
- 服务记录管理
- 成长记录管理
- 服务统计分析

**技术实现**:
```javascript
// 关怀服务云函数
const cloud = require('wx-server-sdk')
cloud.init()

exports.main = async (event, context) => {
  const { action, data } = event

  switch (action) {
    case 'createCareProject':
      return await createCareProject(data)
    case 'getServiceRecords':
      return await getServiceRecords(data)
    default:
      throw new Error('Unknown action')
  }
}
```

#### 4. 活动服务 (Activity Service)
**职责**:
- 活动信息管理
- 活动报名管理
- 活动记录管理
- 活动统计分析

#### 5. 系统服务 (System Service)
**职责**:
- 系统配置管理
- 数据导入导出
- 日志管理
- 监控统计

#### 6. 消息服务 (Message Service)
**职责**:
- 消息推送
- 消息模板管理
- 通知管理
- 消息统计

### 服务间通信

#### API网关
```javascript
// API网关路由配置
const routes = {
  '/api/user/*': 'user-service',
  '/api/resident/*': 'resident-service',
  '/api/care/*': 'care-service',
  '/api/activity/*': 'activity-service',
  '/api/system/*': 'system-service',
  '/api/message/*': 'message-service'
}
```

#### 服务调用
```javascript
// 服务调用示例
const callService = async (serviceName, action, data) => {
  const result = await cloud.callFunction({
    name: serviceName,
    data: { action, data }
  })
  return result.result
}
```

## 数据库设计

### 数据库选择
- **主数据库**: 云数据库 (基于MongoDB)
- **优势**:
  - 自动扩容
  - 高可用性
  - 事务支持
  - 全文搜索
  - 地理位置查询

### 数据库分片
```javascript
// 数据库集合分片策略
const collections = {
  // 用户相关数据
  users: {
    shardKey: 'stationId', // 按小家分片
    indexes: ['openid', 'phone', 'roleId']
  },

  // 家庭相关数据
  families: {
    shardKey: 'stationId', // 按小家分片
    indexes: ['familyCode', 'childName', 'socialWorkerId']
  },

  // 活动相关数据
  activities: {
    shardKey: 'stationId', // 按小家分片
    indexes: ['type', 'startTime', 'status']
  },

  // 系统数据
  system_configs: {
    shardKey: 'configType',
    indexes: ['configKey']
  }
}
```

### 数据模型设计

#### 用户数据模型
```javascript
// 用户集合
{
  _id: ObjectId,
  openid: String,           // 微信openid
  unionid: String,          // 微信unionid
  userInfo: {
    nickname: String,       // 昵称
    avatar: String,         // 头像
    gender: Number,         // 性别
    country: String,        // 国家
    province: String,       // 省份
    city: String           // 城市
  },
  profile: {
    realName: String,       // 真实姓名
    phone: String,          // 手机号
    email: String,          // 邮箱
    idCard: String,         // 身份证号
    address: String,        // 地址
    birthday: Date          // 生日
  },
  role: {
    roleId: String,         // 角色ID
    roleName: String,       // 角色名称
    permissions: Array,     // 权限列表
    stationId: String       // 所属小家ID
  },
  status: {
    isActive: Boolean,      // 是否激活
    isVerified: Boolean,    // 是否实名认证
    lastLoginTime: Date,    // 最后登录时间
    loginCount: Number      // 登录次数
  },
  createTime: Date,
  updateTime: Date
}
```

#### 家庭数据模型
```javascript
// 家庭集合
{
  _id: ObjectId,
  familyCode: String,       // 家庭编码
  stationId: String,        // 小家ID

  // 儿童信息
  child: {
    name: String,           // 姓名
    gender: Number,         // 性别
    birthday: Date,         // 生日
    idCard: String,         // 身份证号
    diagnosis: String,       // 诊断结果
    treatmentPlan: String,   // 治疗方案
    hospital: String,        // 就医医院
    doctor: String,          // 主治医生
    admissionDate: Date     // 入院日期
  },

  // 家长信息
  parent: {
    name: String,           // 姓名
    relationship: String,   // 关系
    phone: String,          // 手机号
    wechat: String,         // 微信号
    idCard: String,         // 身份证号
    address: String,        // 地址
    occupation: String,     // 职业
    income: String          // 收入情况
  },

  // 家庭成员
  familyMembers: [{
    name: String,           // 姓名
    relationship: String,   // 关系
    phone: String,          // 手机号
    isCaretaker: Boolean    // 是否看护人
  }],

  // 住宿信息
  accommodation: {
    roomNumber: String,     // 房间号
    checkInTime: Date,      // 入住时间
    checkOutTime: Date,     // 退房时间
    deposit: Number,        // 押金
    monthlyFee: Number      // 月费
  },

  // 服务信息
  services: {
    socialWorkerId: String, // 负责社工ID
    volunteerIds: Array,    // 志愿者ID列表
    carePlan: Object,       // 关怀计划
    emergencyContact: Object // 紧急联系人
  },

  status: {
    applicationStatus: String, // 申请状态
    accommodationStatus: String, // 住宿状态
    serviceStatus: String     // 服务状态
  },

  createTime: Date,
  updateTime: Date
}
```

## 缓存架构

### 缓存策略
```javascript
// 缓存配置
const cacheConfig = {
  // 用户信息缓存
  userInfo: {
    key: 'user:{userId}',
    ttl: 3600, // 1小时
    strategy: 'LRU'
  },

  // 权限信息缓存
  permissions: {
    key: 'permissions:{userId}',
    ttl: 1800, // 30分钟
    strategy: 'LRU'
  },

  // 家庭信息缓存
  familyInfo: {
    key: 'family:{familyId}',
    ttl: 1800, // 30分钟
    strategy: 'LRU'
  },

  // 活动信息缓存
  activityInfo: {
    key: 'activity:{activityId}',
    ttl: 3600, // 1小时
    strategy: 'LRU'
  }
}
```

### 缓存实现
```javascript
// 缓存服务
class CacheService {
  constructor() {
    this.cache = new Map()
    this.ttl = new Map()
  }

  set(key, value, ttl = 3600) {
    this.cache.set(key, value)
    this.ttl.set(key, Date.now() + ttl * 1000)
  }

  get(key) {
    const expireTime = this.ttl.get(key)
    if (!expireTime || Date.now() > expireTime) {
      this.cache.delete(key)
      this.ttl.delete(key)
      return null
    }
    return this.cache.get(key)
  }

  delete(key) {
    this.cache.delete(key)
    this.ttl.delete(key)
  }

  clear() {
    this.cache.clear()
    this.ttl.clear()
  }
}
```

## 安全架构

### 身份认证
```javascript
// JWT Token生成
const generateToken = (user) => {
  const payload = {
    userId: user._id,
    roleId: user.role.roleId,
    stationId: user.role.stationId,
    permissions: user.role.permissions,
    iat: Date.now(),
    exp: Date.now() + 24 * 60 * 60 * 1000 // 24小时
  }

  return jwt.sign(payload, process.env.JWT_SECRET)
}
```

### 权限验证
```javascript
// 权限中间件
const authMiddleware = async (event, context) => {
  const token = event.headers.authorization

  if (!token) {
    throw new Error('Unauthorized')
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    const user = await getUserById(decoded.userId)

    if (!user || !user.status.isActive) {
      throw new Error('User not found or inactive')
    }

    return user
  } catch (error) {
    throw new Error('Invalid token')
  }
}
```

### 数据加密
```javascript
// 敏感数据加密
const encryptData = (data, key) => {
  const crypto = require('crypto')
  const algorithm = 'aes-256-gcm'
  const iv = crypto.randomBytes(16)

  const cipher = crypto.createCipher(algorithm, key, iv)

  let encrypted = cipher.update(data, 'utf8', 'hex')
  encrypted += cipher.final('hex')

  const tag = cipher.getAuthTag()

  return {
    encrypted,
    iv: iv.toString('hex'),
    tag: tag.toString('hex')
  }
}
```

## 性能优化

### 前端优化
```javascript
// 图片懒加载
const lazyLoadImages = () => {
  const images = document.querySelectorAll('img[data-src]')

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target
        img.src = img.dataset.src
        img.removeAttribute('data-src')
        observer.unobserve(img)
      }
    })
  })

  images.forEach(img => observer.observe(img))
}

// 虚拟滚动
const virtualScroll = {
  data() {
    return {
      visibleItems: [],
      startIndex: 0,
      endIndex: 20,
      itemHeight: 50
    }
  },

  methods: {
    updateVisibleItems() {
      const scrollTop = this.$refs.scrollTop
      this.startIndex = Math.floor(scrollTop / this.itemHeight)
      this.endIndex = this.startIndex + Math.ceil(window.innerHeight / this.itemHeight)

      this.visibleItems = this.items.slice(this.startIndex, this.endIndex)
    }
  }
}
```

### 后端优化
```javascript
// 数据库查询优化
const optimizedQuery = async (stationId, page, limit) => {
  const skip = (page - 1) * limit

  const result = await db.collection('families')
    .aggregate([
      { $match: { stationId } },
      { $sort: { createTime: -1 } },
      { $skip: skip },
      { $limit: limit },
      { $lookup: {
        from: 'users',
        localField: 'socialWorkerId',
        foreignField: '_id',
        as: 'socialWorker'
      }},
      { $project: {
        'child.name': 1,
        'child.gender': 1,
        'parent.name': 1,
        'parent.phone': 1,
        'accommodation.roomNumber': 1,
        'status': 1,
        'createTime': 1,
        'socialWorker.nickname': 1
      }}
    ])

  return result
}

// 批量操作优化
const batchUpdate = async (updates) => {
  const bulkOps = updates.map(update => ({
    updateOne: {
      filter: { _id: update.id },
      update: { $set: update.data },
      upsert: false
    }
  }))

  const result = await db.collection('families').bulkWrite(bulkOps)
  return result
}
```

## 监控与日志

### 系统监控
```javascript
// 性能监控
const performanceMonitor = {
  trackPageView(page) {
    wx.reportAnalytics('page_view', {
      page: page,
      timestamp: Date.now()
    })
  },

  trackUserAction(action, data) {
    wx.reportAnalytics('user_action', {
      action: action,
      data: JSON.stringify(data),
      timestamp: Date.now()
    })
  },

  trackError(error, context) {
    console.error('Error:', error, 'Context:', context)

    // 发送错误报告
    wx.reportAnalytics('error', {
      message: error.message,
      stack: error.stack,
      context: JSON.stringify(context),
      timestamp: Date.now()
    })
  }
}
```

### 日志系统
```javascript
// 日志服务
class Logger {
  constructor() {
    this.levels = {
      ERROR: 0,
      WARN: 1,
      INFO: 2,
      DEBUG: 3
    }

    this.currentLevel = this.levels.INFO
  }

  log(level, message, data = {}) {
    if (level > this.currentLevel) return

    const logEntry = {
      timestamp: new Date().toISOString(),
      level: Object.keys(this.levels)[level],
      message,
      data,
      userId: getCurrentUserId(),
      requestId: generateRequestId()
    }

    console.log(JSON.stringify(logEntry))

    // 发送到日志服务
    this.sendToLogService(logEntry)
  }

  error(message, data) {
    this.log(this.levels.ERROR, message, data)
  }

  warn(message, data) {
    this.log(this.levels.WARN, message, data)
  }

  info(message, data) {
    this.log(this.levels.INFO, message, data)
  }

  debug(message, data) {
    this.log(this.levels.DEBUG, message, data)
  }
}
```

## 部署架构

### 云开发部署
```javascript
// 云函数部署配置
const functions = [
  {
    name: 'user-service',
    memorySize: 256,
    timeout: 60,
    environment: {
      NODE_ENV: 'production',
      JWT_SECRET: process.env.JWT_SECRET
    }
  },
  {
    name: 'resident-service',
    memorySize: 512,
    timeout: 60,
    environment: {
      NODE_ENV: 'production',
      DB_CONNECTION: process.env.DB_CONNECTION
    }
  }
]

// 自动化部署脚本
const deployFunctions = async () => {
  for (const func of functions) {
    await cloud.deployFunction(func)
    console.log(`Function ${func.name} deployed successfully`)
  }
}
```

### CI/CD流程
```yaml
# GitHub Actions配置
name: Deploy to Cloud Base

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: npm install
      - name: Run tests
        run: npm test
      - name: Run linting
        run: npm run lint

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to Cloud Base
        run: |
          npm run build
          npm run deploy
        env:
          TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}
```

## 技术债务管理

### 代码质量
```javascript
// ESLint配置
module.exports = {
  extends: [
    'eslint:recommended',
    '@vue/typescript/recommended'
  ],
  rules: {
    'no-console': 'warn',
    'no-unused-vars': 'error',
    'prefer-const': 'error',
    'no-var': 'error'
  }
}

// 代码覆盖率配置
module.exports = {
  collectCoverage: true,
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
}
```

### 重构计划
1. **模块解耦**: 降低模块间耦合度
2. **代码复用**: 提取公共组件和工具
3. **性能优化**: 优化数据库查询和前端渲染
4. **安全加固**: 完善安全防护机制
5. **文档完善**: 补充技术文档和API文档

## 技术演进路线

### 短期目标 (3-6个月)
- 完成基础功能开发
- 建立完整的CI/CD流程
- 实现基本的监控和日志
- 优化核心业务流程

### 中期目标 (6-12个月)
- 实现微服务架构
- 完善安全防护机制
- 优化系统性能
- 建立数据分析平台

### 长期目标 (1-2年)
- 实现智能化服务
- 建立大数据平台
- 扩展第三方集成
- 构建开放生态

## 技术选型评估

### 选型标准
1. **成熟度**: 技术栈的成熟度和稳定性
2. **生态**: 社区支持和生态丰富度
3. **性能**: 系统性能和扩展性
4. **维护**: 代码维护和升级成本
5. **团队**: 团队技术栈匹配度

### 技术风险评估
1. **技术风险**: 新技术引入的风险
2. **兼容性风险**: 不同版本的兼容性问题
3. **性能风险**: 系统性能瓶颈
4. **安全风险**: 安全漏洞和威胁
5. **运维风险**: 系统运维复杂度

### 应对策略
1. **技术预研**: 提前进行技术调研和验证
2. **灰度发布**: 采用灰度发布降低风险
3. **监控告警**: 建立完善的监控告警体系
4. **备份方案**: 准备备用技术方案
5. **团队培训**: 加强团队技术培训