# 02_角色权限设计

## 设计原则

### 权限设计原则
1. **最小权限原则**: 用户只获得完成工作所需的最小权限
2. **职责分离原则**: 不同角色承担不同的职责，避免权限冲突
3. **权限继承原则**: 上级角色可以继承下级角色的权限
4. **动态授权原则**: 支持临时权限和动态权限调整
5. **审计追踪原则**: 所有权限操作都有完整的审计记录

### 数据安全原则
1. **数据分级保护**: 根据敏感程度对数据进行分级保护
2. **访问控制**: 基于角色和数据级别的访问控制
3. **数据脱敏**: 敏感数据显示时进行适当的脱敏处理
4. **操作审计**: 所有数据操作都有完整的操作记录
5. **隐私保护**: 特别保护儿童和家庭的隐私信息

## 角色体系设计

### 角色分类体系

#### 1. 管理类角色
**总部管理员 (Headquarters Admin)**
- **角色代码**: HQ_ADMIN
- **角色级别**: Level 5 (最高权限)
- **角色描述**: 全国性项目的最高管理者
- **直属上级**: 无
- **直属下级**: 小家站长、总部工作人员

**小家站长 (Station Manager)**
- **角色代码**: STATION_MANAGER
- **角色级别**: Level 4
- **角色描述**: 单个小家服务点的负责人
- **直属上级**: 总部管理员
- **直属下级**: 专职社工、本地志愿者

#### 2. 服务类角色
**专职社工 (Full-time Social Worker)**
- **角色代码**: FULLTIME_SOCIAL_WORKER
- **角色级别**: Level 3
- **角色描述**: 专业儿童关怀服务人员
- **直属上级**: 小家站长
- **直属下级**: 志愿者

**核心志愿者 (Core Volunteer)**
- **角色代码**: CORE_VOLUNTEER
- **角色级别**: Level 2.5
- **角色描述**: 经过专业培训的长期志愿者
- **直属上级**: 专职社工
- **直属下级**: 普通志愿者

**普通志愿者 (Volunteer)**
- **角色代码**: VOLUNTEER
- **角色级别**: Level 2
- **角色描述**: 参与服务的一般志愿者
- **直属上级**: 专职社工、核心志愿者
- **直属下级**: 无

#### 3. 用户类角色
**入住家长 (Resident Parent)**
- **角色代码**: RESIDENT_PARENT
- **角色级别**: Level 1.5
- **角色描述**: 正在小家居住的儿童家长
- **直属上级**: 专职社工
- **直属下级**: 无

**家长代表 (Parent Representative)**
- **角色代码**: PARENT_REPRESENTATIVE
- **角色级别**: Level 2
- **角色描述**: 家长群体中的代表，参与部分管理
- **直属上级**: 专职社工
- **直属下级**: 普通家长

#### 4. 外部合作类角色
**合作医院人员 (Hospital Partner)**
- **角色代码**: HOSPITAL_PARTNER
- **角色级别**: Level 2
- **角色描述**: 合作医院的工作人员
- **直属上级**: 无
- **直属下级**: 无

**捐赠者 (Donor)**
- **角色代码**: DONOR
- **角色级别**: Level 1
- **角色描述**: 提供资金或物资捐赠的个人或组织
- **直属上级**: 无
- **直属下级**: 无

#### 5. 公众类角色
**访客 (Visitor)**
- **角色代码**: VISITOR
- **角色级别**: Level 0.5
- **角色描述**: 浏览公开信息的访客
- **直属上级**: 无
- **直属下级**: 无

### 角色权限矩阵

#### 数据访问权限矩阵
| 权限类别 | 总部管理员 | 小家站长 | 专职社工 | 核心志愿者 | 普通志愿者 | 入住家长 | 合作医院 | 捐赠者 | 访客 |
|---------|-----------|----------|----------|-----------|-----------|----------|----------|--------|------|
| **基础数据访问** |
| 查看所有小家信息 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 查看本小家信息 | ✅ | ✅ | ✅ | ⚠️ | ⚠️ | ❌ | ❌ | ❌ | ❌ |
| 查看家庭基本信息 | ✅ | ✅ | ✅ | ⚠️ | ⚠️ | ✅ | ⚠️ | ❌ | ❌ |
| 查看敏感信息 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ⚠️ | ❌ | ❌ |
| **住户管理权限** |
| 家庭入住申请 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ✅ | ⚠️ | ❌ | ❌ |
| 入住审核 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 住宿分配 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 退房管理 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **关怀服务权限** |
| 关怀项目创建 | ✅ | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 关怀服务实施 | ✅ | ✅ | ✅ | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ |
| 服务记录查看 | ✅ | ✅ | ✅ | ⚠️ | ⚠️ | ⚠️ | ❌ | ❌ | ❌ |
| 效果评估 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **活动管理权限** |
| 活动策划 | ✅ | ✅ | ✅ | ⚠️ | ❌ | ⚠️ | ❌ | ❌ | ❌ |
| 活动组织 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 活动参与 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ⚠️ | ⚠️ |
| 活动统计 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **系统管理权限** |
| 用户管理 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 权限分配 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 系统配置 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 数据导入导出 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

*说明：✅ 完全权限，⚠️ 有限权限，❌ 无权限*

#### 功能操作权限矩阵
| 功能模块 | 总部管理员 | 小家站长 | 专职社工 | 核心志愿者 | 普通志愿者 | 入住家长 | 合作医院 | 捐赠者 | 访客 |
|---------|-----------|----------|----------|-----------|-----------|----------|----------|--------|------|
| **用户认证** |
| 用户注册 | ✅ | ⚠️ | ⚠️ | ❌ | ❌ | ❌ | ⚠️ | ⚠️ | ⚠️ |
| 登录认证 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 密码重置 | ✅ | ⚠️ | ⚠️ | ❌ | ❌ | ⚠️ | ⚠️ | ⚠️ | ⚠️ |
| **住户管理** |
| 家庭信息查看 | ✅ | ✅ | ✅ | ⚠️ | ⚠️ | ⚠️ | ⚠️ | ❌ | ❌ |
| 家庭信息编辑 | ✅ | ✅ | ✅ | ❌ | ❌ | ⚠️ | ❌ | ❌ | ❌ |
| 入住申请管理 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ✅ | ⚠️ | ❌ | ❌ |
| 住宿记录管理 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **关怀服务** |
| 关怀项目管理 | ✅ | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 服务记录管理 | ✅ | ✅ | ✅ | ✅ | ⚠️ | ⚠️ | ❌ | ❌ | ❌ |
| 服务评估 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **活动管理** |
| 活动创建 | ✅ | ✅ | ✅ | ⚠️ | ❌ | ⚠️ | ❌ | ❌ | ❌ |
| 活动管理 | ✅ | ✅ | ✅ | ✅ | ⚠️ | ✅ | ❌ | ⚠️ | ❌ |
| 活动参与 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ⚠️ | ⚠️ |
| **系统管理** |
| 权限管理 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 系统配置 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 数据统计 | ✅ | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 审计日志 | ✅ | ⚠️ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

## 权限控制机制

### 权限类型定义

#### 1. 功能权限 (Function Permission)
控制用户可以访问的功能模块和操作
```
权限格式: MODULE:ACTION
示例:
- USER:VIEW        # 查看用户信息
- USER:EDIT        # 编辑用户信息
- FAMILY:VIEW      # 查看家庭信息
- FAMILY:EDIT      # 编辑家庭信息
- ACTIVITY:CREATE  # 创建活动
- ACTIVITY:MANAGE  # 管理活动
```

#### 2. 数据权限 (Data Permission)
控制用户可以访问的数据范围
```
权限格式: SCOPE:RESOURCE:CONDITION
示例:
- ALL:FAMILY:*           # 所有家庭数据
- STATION:FAMILY:STATION # 本小家家庭数据
- SELF:FAMILY:SELF       # 自己家庭数据
- ASSIGNED:FAMILY:ASSIGNED # 分配给自己的家庭数据
```

#### 3. 字段权限 (Field Permission)
控制用户可以查看的数据字段
```
权限格式: ENTITY:FIELD:LEVEL
示例:
- FAMILY:ID_NUMBER:HIGH     # 家庭身份证号(高级别权限)
- FAMILY:PHONE:MEDIUM       # 家庭电话(中级别权限)
- FAMILY:NAME:LOW          # 家庭姓名(低级别权限)
- FAMILY:ADDRESS:HIGH      # 家庭地址(高级别权限)
```

### 权限验证流程

#### 1. 用户认证流程
```
1. 用户提交登录信息
2. 系统验证用户身份
3. 生成用户Token
4. 加载用户权限信息
5. 返回认证结果
```

#### 2. 权限验证流程
```
1. 解析用户Token，获取用户身份
2. 查询用户角色和权限列表
3. 验证功能权限 (是否有权限访问该功能)
4. 验证数据权限 (是否有权限访问该数据)
5. 验证字段权限 (是否有权限查看该字段)
6. 记录权限验证日志
7. 返回验证结果
```

#### 3. 数据过滤流程
```
1. 根据用户角色确定数据访问范围
2. 应用数据权限过滤条件
3. 应用字段权限过滤规则
4. 对敏感数据进行脱敏处理
5. 返回过滤后的数据
```

### 权限继承与委派

#### 权限继承规则
```
继承层级:
总部管理员 > 小家站长 > 专职社工 > 核心志愿者 > 普通志愿者
          > 家长代表 > 普通家长 > 合作医院 > 捐赠者 > 访客

继承原则:
1. 上级角色自动获得下级角色的所有权限
2. 上级角色可以给下级角色分配额外权限
3. 权限继承是单向的，下级不能继承上级权限
4. 权限继承可以跨越多个层级
```

#### 临时授权机制
```
临时授权类型:
1. 时间授权: 在指定时间段内获得特定权限
2. 任务授权: 为完成特定任务获得相关权限
3. 代理授权: 在指定人员不在时代理其权限
4. 紧急授权: 在紧急情况下获得的临时权限

授权特点:
- 有明确的生效时间
- 有明确的权限范围
- 有明确的授权原因
- 有完整的授权记录
- 权限到期自动失效
```

## 数据安全设计

### 数据分级保护

#### 敏感数据分级
```
Level 5 (最高级别):
- 儿童身份证号码
- 家庭银行账户信息
- 详细的医疗诊断记录
- 社会保障号码

Level 4 (高级别):
- 家庭联系方式
- 详细家庭住址
- 医疗治疗记录
- 财务信息

Level 3 (中级别):
- 儿童基本信息
- 就医医院信息
- 关怀服务记录
- 活动参与记录

Level 2 (低级别):
- 儿童昵称
- 基本年龄信息
- 活动照片
- 服务评价

Level 1 (公开级别):
- 项目介绍信息
- 公开活动信息
- 捐赠统计信息
- 组织基本信息
```

#### 数据访问控制
```
访问控制规则:
1. 不同级别数据需要不同权限级别
2. 数据查看记录完整保存
3. 敏感数据操作需要二次确认
4. 数据导出需要审批流程
5. 数据删除需要特殊授权
```

### 数据脱敏规则

#### 脱敏策略
```
手机号脱敏:
- 总部管理员: 138****1234 (显示部分)
- 小家站长: 138****1234 (显示部分)
- 专职社工: 138****5678 (显示部分)
- 志愿者: 138****0000 (隐藏全部)
- 家长: 138****1234 (显示自己的)

身份证号脱敏:
- 总部管理员: 110101********1234 (显示部分)
- 小家站长: 110101********0000 (隐藏全部)
- 其他角色: 完全隐藏

地址脱敏:
- 总部管理员: 北京市朝阳区***小区
- 小家站长: 北京市朝阳区***小区
- 专职社工: 北京市朝阳区***小区
- 其他角色: 北京市***
```

#### 脱敏实现
```
脱敏规则配置:
1. 基于角色的脱敏规则
2. 基于数据类型的脱敏规则
3. 基于数据级别的脱敏规则
4. 基于业务场景的脱敏规则
5. 支持自定义脱敏规则
```

## 权限管理界面设计

### 角色管理界面
```
功能列表:
- 角色列表展示
- 角色创建和编辑
- 权限分配界面
- 角色继承关系图
- 权限变更记录
- 角色使用统计
```

### 权限分配界面
```
功能列表:
- 用户角色分配
- 权限矩阵展示
- 权限批量操作
- 临时权限授权
- 权限变更审批
- 权限使用监控
```

### 审计日志界面
```
功能列表:
- 权限操作记录
- 数据访问记录
- 异常行为监控
- 权限使用统计
- 安全事件报告
- 合规性检查
```

## 权限配置示例

### 配置文件示例
```json
{
  "roles": {
    "HQ_ADMIN": {
      "name": "总部管理员",
      "level": 5,
      "permissions": [
        "USER:*",
        "FAMILY:*",
        "ACTIVITY:*",
        "SYSTEM:*",
        "DATA:*"
      ],
      "data_scope": "ALL",
      "field_level": "ALL"
    },
    "STATION_MANAGER": {
      "name": "小家站长",
      "level": 4,
      "permissions": [
        "USER:VIEW",
        "USER:EDIT:STATION",
        "FAMILY:*",
        "ACTIVITY:*",
        "SYSTEM:VIEW"
      ],
      "data_scope": "STATION",
      "field_level": "HIGH"
    },
    "FULLTIME_SOCIAL_WORKER": {
      "name": "专职社工",
      "level": 3,
      "permissions": [
        "FAMILY:*",
        "CARE:*",
        "ACTIVITY:*"
      ],
      "data_scope": "ASSIGNED",
      "field_level": "MEDIUM"
    }
  }
}
```

### 权限验证示例
```javascript
// 权限验证函数
function checkPermission(user, resource, action) {
  const userRole = getUserRole(user);
  const permissions = getRolePermissions(userRole);

  // 检查功能权限
  if (!hasPermission(permissions, `${resource}:${action}`)) {
    return false;
  }

  // 检查数据权限
  if (!hasDataAccess(user, resource)) {
    return false;
  }

  // 检查字段权限
  if (!hasFieldAccess(user, resource)) {
    return false;
  }

  return true;
}
```

## 权限测试方案

### 测试用例设计
```
测试场景:
1. 角色权限边界测试
2. 数据访问权限测试
3. 权限继承测试
4. 临时权限测试
5. 权限撤销测试
6. 异常权限测试
7. 性能压力测试
8. 安全渗透测试
```

### 测试数据准备
```
测试数据:
1. 多角色测试账号
2. 不同权限级别数据
3. 敏感数据样本
4. 权限变更记录
5. 异常操作记录
```

### 测试验证标准
```
验证标准:
1. 权限控制100%准确
2. 敏感数据100%保护
3. 权限变更实时生效
4. 异常权限及时告警
5. 权限日志完整记录
```

## 持续优化

### 权限优化策略
1. **权限粒度细化**: 根据业务发展细化权限控制
2. **权限自动化**: 实现权限的自动分配和回收
3. **权限监控**: 实时监控权限使用情况
4. **权限优化**: 定期优化权限配置
5. **安全加固**: 持续加强安全防护措施

### 用户体验优化
1. **权限简化**: 简化权限配置流程
2. **权限可视化**: 提供权限关系的可视化展示
3. **权限提示**: 提供权限不足的友好提示
4. **权限申请**: 提供权限申请的便捷通道
5. **权限帮助**: 提供权限使用的帮助文档