name: Performance Testing and Chrome DevTools E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # æ€§èƒ½æµ‹è¯•ä½œä¸š
  performance-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd web-admin
        npm ci

    - name: å®‰è£… Playwright æµè§ˆå™¨
      run: |
        cd web-admin
        npx playwright install chromium

    - name: å¯åŠ¨å¼€å‘æœåŠ¡å™¨
      run: |
        cd web-admin
        npm run dev:all &
        echo "ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."
        sleep 30
        curl -f http://localhost:4174 || exit 1

    - name: è¿è¡Œ Chrome DevTools ç®€åŒ–æµ‹è¯•
      run: |
        cd web-admin
        PW_BASE_URL=http://localhost:4174 npm run test:e2e chrome-devtools-simple.spec.ts --project chromium

    - name: è¿è¡Œ Core Web Vitals æµ‹è¯•
      run: |
        cd web-admin
        PW_BASE_URL=http://localhost:4174 npx playwright test chrome-devtools-simple.spec.ts --project chromium --grep "Core Web Vitals"

    - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        cd web-admin
        node scripts/generate-performance-report.js

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results-${{ matrix.node-version }}
        path: |
          web-admin/playwright-report/
          web-admin/test-results/
          web-admin/performance-reports/
        retention-days: 30

    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–çŽ‡
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-coverage-${{ matrix.node-version }}
        path: web-admin/coverage/
        retention-days: 30

    - name: æ€§èƒ½æ£€æŸ¥ï¼ˆå¤±è´¥é˜ˆå€¼ï¼‰
      run: |
        cd web-admin
        node scripts/performance-threshold-check.js

    - name: å‘é€æ€§èƒ½æŠ¥å‘Šåˆ°Slackï¼ˆå¯é€‰ï¼‰
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#performance-alerts'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # è·¨æµè§ˆå™¨æ€§èƒ½æµ‹è¯•
  cross-browser-tests:
    runs-on: ubuntu-latest
    needs: performance-tests

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd web-admin
        npm ci

    - name: å®‰è£… Playwright æµè§ˆå™¨
      run: |
        cd web-admin
        npx playwright install

    - name: è¿è¡Œè·¨æµè§ˆå™¨æµ‹è¯•
      run: |
        cd web-admin
        PW_BASE_URL=http://localhost:4174 npm run test:e2e chrome-devtools-simple.spec.ts

    - name: ç”Ÿæˆè·¨æµè§ˆå™¨æŠ¥å‘Š
      run: |
        cd web-admin
        node scripts/generate-cross-browser-report.js

    - name: ä¸Šä¼ è·¨æµè§ˆå™¨ç»“æžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cross-browser-results
        path: |
          web-admin/playwright-report/
          web-admin/cross-browser-reports/
        retention-days: 15

  # ç”Ÿäº§çŽ¯å¢ƒæ€§èƒ½ç›‘æŽ§
  production-monitoring:
    runs-on: ubuntu-latest
    needs: [performance-tests, cross-browser-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd web-admin
        npm ci

    - name: è¿è¡Œç”Ÿäº§çº§æ€§èƒ½æµ‹è¯•
      run: |
        cd web-admin
        PW_BASE_URL=https://your-production-url.com npm run test:e2e chrome-devtools-production.spec.ts --project chromium

    - name: æ€§èƒ½å›žå½’æ£€æµ‹
      run: |
        cd web-admin
        node scripts/performance-regression-check.js

    - name: æ›´æ–°æ€§èƒ½åŸºå‡†
      run: |
        cd web-admin
        node scripts/update-performance-baseline.js

    - name: éƒ¨ç½²æ€§èƒ½æŠ¥å‘Šåˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./web-admin/performance-reports
        destination_dir: performance-reports

  # æ€§èƒ½åŸºå‡†å’Œè¶‹åŠ¿åˆ†æž
  performance-analytics:
    runs-on: ubuntu-latest
    needs: [production-monitoring]
    if: always()

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: å®‰è£… Python ä¾èµ–
      run: |
        pip install pandas matplotlib seaborn

    - name: ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿åˆ†æž
      run: |
        cd scripts
        python generate-performance-trends.py

    - name: ä¸Šä¼ è¶‹åŠ¿åˆ†æžæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: performance-trends
        path: scripts/performance-trends/
        retention-days: 90

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¿è¡Œå®‰å…¨æ‰«æ
      run: |
        cd web-admin
        npm audit --audit-level moderate

    - name: ä»£ç å®‰å…¨åˆ†æž
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'

# å·¥ä½œæµæ€»ç»“
jobs-summary:
  runs-on: ubuntu-latest
  needs: [performance-tests, cross-browser-tests, production-monitoring]
  if: always()

  steps:
  - name: ç”Ÿæˆå·¥ä½œæµæ€»ç»“
    run: |
      echo "## Performance Testing Workflow Summary" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
      echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
      echo "| Performance Tests | ${{ needs.performance-tests.result }} | Chrome DevTools E2E tests |" >> $GITHUB_STEP_SUMMARY
      echo "| Cross-browser Tests | ${{ needs.cross-browser-tests.result }} | Multi-browser compatibility |" >> $GITHUB_STEP_SUMMARY
      echo "| Production Monitoring | ${{ needs.production-monitoring.result }} | Production performance checks |" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "ðŸ“Š **Performance Metrics**" >> $GITHUB_STEP_SUMMARY
      echo "- All test reports are available in the artifacts" >> $GITHUB_STEP_SUMMARY
      echo "- Performance trends are updated regularly" >> $GITHUB_STEP_SUMMARY
      echo "- Regression detection is active" >> $GITHUB_STEP_SUMMARY