<view class="theme-root analysis-container stack gap-4">
  <view wx:if="{{loading}}" class="panel-container">
    <!-- 摘要卡片骨架屏 -->
    <view class="analysis-header stack gap-4">
      <view class="skeleton-summary-grid">
        <view class="skeleton-panel skeleton-summary-card"></view>
        <view class="skeleton-panel skeleton-summary-card"></view>
        <view class="skeleton-panel skeleton-summary-card"></view>
        <view class="skeleton-panel skeleton-summary-card"></view>
      </view>
      <view class="summary-actions">
        <view class="skeleton-panel" style="width: 120rpx; height: 60rpx; border-radius: var(--radius-full)"></view>
      </view>
      <pm-card class="legend-card" variant="outlined" padding="var(--space-4)">
        <view class="skeleton-panel skeleton-panel-header"></view>
        <view class="legend-items">
          <view class="legend-item" wx:for="{{[1,2,3]}}" wx:key="*this">
            <view class="skeleton-panel" style="width: 20rpx; height: 20rpx; border-radius: 50%"></view>
            <view class="legend-copy">
              <view class="skeleton-panel" style="width: 120rpx; height: 20rpx; margin-bottom: 4rpx"></view>
              <view class="skeleton-panel" style="width: 180rpx; height: 16rpx"></view>
            </view>
          </view>
        </view>
      </pm-card>
    </view>

    <!-- 分析面板骨架屏 -->
    <view class="analysis-panel" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">
      <view class="panel-header">
        <view class="panel-title-group">
          <view class="skeleton-panel skeleton-panel-header"></view>
        </view>
        <view class="panel-mode-switch">
          <view class="skeleton-panel" style="width: 80rpx; height: 40rpx; border-radius: var(--radius-full)"></view>
          <view class="skeleton-panel" style="width: 80rpx; height: 40rpx; border-radius: var(--radius-full)"></view>
          <view class="skeleton-panel" style="width: 80rpx; height: 40rpx; border-radius: var(--radius-full)"></view>
        </view>
      </view>
      <scroll-view scroll-x enable-flex="true" enhanced="true" class="skeleton-stat-scroll">
        <view class="skeleton-panel skeleton-stat-card" wx:for="{{[1,2,3,4]}}" wx:key="*this"></view>
      </scroll-view>
    </view>
  </view>
  <view wx:elif="{{error}}" class="error">{{error}}</view>
  <scroll-view wx:else scroll-y enable-flex="true" enhanced="true" class="panel-container">
    <view class="analysis-header stack gap-4">
      <view class="summary-card-grid">
        <view
          wx:for="{{summaryCards}}"
          wx:key="id"
          class="summary-card {{item.isMax ? 'summary-card--highlight' : ''}} {{activeSummaryFilter === item.id ? 'summary-card--active' : ''}}"
          data-filter="{{item.id}}"
          hover-class="summary-card--hover"
          bindtap="onSummaryCardTap"
        >
          <text class="summary-card__value">{{item.value}}</text>
          <text class="summary-card__label">{{item.label}}</text>
          <text class="summary-card__desc">{{item.description}}</text>
        </view>
      </view>
      <view class="summary-actions">
        <pm-button
          class="summary-action-button"
          text="回列表"
          size="small"
          type="ghost"
          bindtap="onNavigateListAll"
        />
      </view>
      <pm-card class="legend-card" variant="outlined" padding="var(--space-4)">
        <view class="legend-header">
          <text class="legend-title">图例说明</text>
          <text class="legend-subtitle">理解颜色语义，快速识别异常</text>
        </view>
        <view class="legend-items">
          <view class="legend-item" wx:for="{{legendItems}}" wx:key="id">
            <view class="legend-dot legend-dot--{{item.status}}"></view>
            <view class="legend-copy">
              <text class="legend-label">{{item.label}}</text>
              <text class="legend-desc">{{item.description}}</text>
            </view>
          </view>
        </view>
      </pm-card>
    </view>

    <view
      class="section analysis-panel"
      wx:for="{{panels}}"
      wx:key="title"
      wx:for-index="panelIndex"
    >
      <view class="panel-header">
        <view class="panel-title-group">
          <text class="panel-title">{{item.title}}</text>
          <text wx:if="{{item.totalCount}}" class="panel-total">共 {{item.totalCount}} 人</text>
        </view>
        <view class="panel-mode-switch" wx:if="{{panelDisplayModes.length > 1}}">
          <view
            class="panel-mode-option {{(panelViewModes[item.panelKey] || 'cards') === mode.id ? 'panel-mode-option--active' : ''}}"
            wx:for="{{panelDisplayModes}}"
            wx:for-item="mode"
            wx:for-index="modeIndex"
            wx:key="id"
            data-panel-key="{{item.panelKey}}"
            data-mode="{{mode.id}}"
            bindtap="onPanelModeTap"
          >
            {{mode.label}}
          </view>
        </view>
      </view>
      <block wx:if="{{item.stats && item.stats.length}}">
        <block wx:if="{{(panelViewModes[item.panelKey] || 'cards') === 'cards'}}">
          <scroll-view scroll-x enable-flex="true" enhanced="true" class="stat-scroll">
            <pm-card
              wx:for="{{item.stats}}"
              wx:for-item="stat"
              wx:for-index="statIndex"
              wx:key="label"
              class="analysis-stat-card"
              variant="{{stat.variant || 'default'}}"
              status="{{stat.status || 'default'}}"
              padding="var(--space-4)"
              clickable="{{true}}"
              use-slot="{{true}}"
              data-panel-index="{{panelIndex}}"
              data-stat-index="{{statIndex}}"
              bindtap="onStatTap"
            >
              <view class="analysis-stat-card__content">
                <text class="analysis-stat-card__label">{{stat.label}}</text>
                <view class="analysis-stat-card__count">
                  <text class="analysis-stat-card__figure">{{stat.count}}</text>
                  <text class="analysis-stat-card__unit">人</text>
                </view>
                <text wx:if="{{stat.sampleNames}}" class="analysis-stat-card__samples"
                  >{{stat.sampleNames}}</text
                >
              </view>
            </pm-card>
          </scroll-view>
        </block>
        <block wx:elif="{{(panelViewModes[item.panelKey] || 'cards') === 'bars'}}">
          <view class="analysis-bars">
            <view
              class="analysis-bar"
              wx:for="{{item.stats}}"
              wx:for-item="stat"
              wx:for-index="statIndex"
              wx:key="label"
              data-panel-index="{{panelIndex}}"
              data-stat-index="{{statIndex}}"
              bindtap="onStatTap"
            >
              <view class="analysis-bar__header">
                <text class="analysis-bar__label">{{stat.label}}</text>
                <text class="analysis-bar__value">{{stat.count}} 人</text>
              </view>
              <view class="analysis-bar__track">
                <view
                  class="analysis-bar__fill"
                  style="width: {{stat.percentage}}%; background-color: {{stat.color}}"
                  data-percentage="{{stat.percentageLabel}}"
                ></view>
              </view>
              <text class="analysis-bar__percent">{{stat.percentageLabel}}</text>
            </view>
          </view>
        </block>
        <block wx:elif="{{(panelViewModes[item.panelKey] || 'cards') === 'pie'}}">
          <view class="analysis-pie">
            <canvas
              class="analysis-pie__canvas"
              type="2d"
              canvas-id="pie-{{item.panelKey}}"
              id="pie-{{item.panelKey}}"
              disable-scroll="true"
            ></canvas>
            <view class="analysis-pie__legend">
              <view
                class="analysis-pie__legend-item"
                wx:for="{{item.stats}}"
                wx:for-item="stat"
                wx:for-index="statIndex"
                wx:key="label"
                data-panel-index="{{panelIndex}}"
                data-stat-index="{{statIndex}}"
                bindtap="onStatTap"
              >
                <view class="analysis-pie__legend-dot" style="background-color: {{stat.color}}"></view>
                <view class="analysis-pie__legend-copy">
                  <text class="analysis-pie__legend-label">{{stat.label}}</text>
                  <text class="analysis-pie__legend-meta">
                    {{stat.count}} 人 · {{stat.percentageLabel}}
                  </text>
                </view>
              </view>
            </view>
          </view>
        </block>
      </block>
      <view wx:else class="panel-placeholder">{{item.emptyText || '暂无数据'}}</view>
    </view>
  </scroll-view>

  <view wx:if="{{selection.visible}}" class="selection-mask" bindtap="onSelectionClose">
    <view class="selection-panel" catchtap="noop" catchtouchmove="noop">
      <view class="selection-handle"></view>
      <view class="selection-header">
        <view class="selection-header__titles">
          <text class="selection-title">{{selection.title}}</text>
          <text class="selection-count" wx:if="{{selection.totalCount}}"
            >共 {{selection.totalCount}} 人</text
          >
        </view>
        <pm-button
          wx:if="{{selection.filterAvailable}}"
          class="selection-cta"
          text="在列表中查看"
          size="small"
          type="primary"
          bindtap="onSelectionApplyFilter"
        />
      </view>
      <text class="selection-hint" wx:if="{{selection.hint}}">{{selection.hint}}</text>
      <scroll-view scroll-y enhanced="true" show-scrollbar="true" class="selection-list">
        <view
          class="selection-item"
          wx:for="{{selection.items}}"
          wx:key="key"
          data-key="{{item.key}}"
          data-patient-key="{{item.patientKey || item.key}}"
          data-record-key="{{item.key}}"
          bindtap="onSelectionItemTap"
        >
          {{item.name}}
        </view>
      </scroll-view>
      <view class="selection-footer">
        <pm-button text="关闭" type="ghost" size="medium" bindtap="onSelectionClose" />
      </view>
    </view>
  </view>
</view>
