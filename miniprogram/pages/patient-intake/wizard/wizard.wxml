<!--ä½æˆ·å½•å…¥å‘å¯¼ç•Œé¢-->
<view class="theme-root wizard-container {{themeClass}}">
  <!-- é¡¶éƒ¨è¿›åº¦æŒ‡ç¤ºå™¨ -->
  <view class="progress-header">
    <view class="progress-steps">
      <view
        wx:for="{{visibleSteps}}"
        wx:key="originalIndex"
        class="step-item {{currentStep === item.originalIndex ? 'active' : ''}} {{currentStep > item.originalIndex ? 'completed' : ''}}"
        data-step="{{item.originalIndex}}"
        bindtap="onStepTap"
      >
        <view class="step-number">{{index + 1}}</view>
        <view class="step-label">{{item.title}}</view>
      </view>
    </view>
    <view class="progress-info">
      <text class="current-step">ç¬¬{{currentVisibleStepNumber}}æ­¥ / å…±{{totalVisibleSteps}}æ­¥</text>
      <text class="required-count" wx:if="{{requiredFieldsCount > 0}}"
        >å‰©ä½™å¿…å¡«é¡¹ï¼š{{requiredFieldsCount}}</text
      >
    </view>
  </view>

  <!-- å½“å‰æ­¥éª¤æ ‡é¢˜å’Œå¿…å¡«é¡¹æç¤º -->
  <view class="step-header">
    <view class="step-title">{{currentStepData.title}}</view>
    <view class="required-fields" wx:if="{{currentStepData.requiredFields.length > 0}}">
      <text class="required-label">æœ¬æ­¥å¿…å¡«é¡¹ï¼š</text>
      <text class="required-list">{{currentStepData.requiredFieldsText}}</text>
    </view>
  </view>

  <!-- æ­¥éª¤å†…å®¹ -->
  <scroll-view class="step-content" scroll-y>
    <!-- ç¬¬1æ­¥ï¼šåŸºç¡€èº«ä»½ -->
    <view wx:if="{{currentStepData && currentStepData.key === 'identity'}}" class="form-section">
      <view class="step-intro">
        <text class="intro-icon">ğŸ“</text>
        <text class="intro-text">è¯·å¡«å†™ä½æˆ·åŸºæœ¬èº«ä»½ä¿¡æ¯</text>
      </view>

      <view class="form-group">
        <pm-input
          label="å§“å"
          required="{{true}}"
          value="{{formData.patientName}}"
          placeholder="è¯·è¾“å…¥ä½æˆ·å§“å"
          data-field="patientName"
          bindinput="onInputChange"
          error="{{errors.patientName || ''}}"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group">
        <label class="form-label required">è¯ä»¶ç±»å‹</label>
        <picker
          class="form-picker {{errors.idType ? 'error' : ''}}"
          value="{{idTypeIndex}}"
          range="{{idTypes}}"
          data-field="idType"
          bindchange="onPickerChange"
        >
          <view class="picker-display">{{idTypes[idTypeIndex] || 'è¯·é€‰æ‹©è¯ä»¶ç±»å‹'}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.idType}}">{{errors.idType}}</text>
      </view>

      <view class="form-group">
        <pm-input
          label="è¯ä»¶å·ç "
          required="{{true}}"
          value="{{formData.idNumber}}"
          placeholder="è¯·è¾“å…¥è¯ä»¶å·ç "
          data-field="idNumber"
          bindinput="onInputChange"
          error="{{errors.idNumber || ''}}"
          hint="ç¤ºä¾‹ï¼šèº«ä»½è¯æ ¼å¼ä¸º18ä½æ•°å­—"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group">
        <pm-input
          label="è”ç³»ç”µè¯"
          value="{{formData.phone}}"
          placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ï¼ˆé€‰å¡«ï¼‰"
          type="number"
          data-field="phone"
          bindinput="onInputChange"
          error="{{errors.phone || ''}}"
          hint="ç¤ºä¾‹ï¼š13812345678"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="step-intro step-intro--secondary">
        <text class="intro-icon">âœ¨</text>
        <text class="intro-text">ç³»ç»Ÿå·²è‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹ä¿¡æ¯ï¼Œè¯·ç¡®è®¤</text>
      </view>

      <view class="form-group">
        <label class="form-label required">æ€§åˆ«</label>

        <!-- è‡ªåŠ¨è¯†åˆ«åæ˜¾ç¤ºåªè¯»çŠ¶æ€ -->
        <view wx:if="{{genderLocked}}" class="field-locked">
          <view class="locked-value">
            <text class="value-text">{{formData.gender}}</text>
            <view class="auto-fill-badge">ä»èº«ä»½è¯è‡ªåŠ¨è¯†åˆ«</view>
          </view>
          <button
            class="unlock-btn"
            data-field="gender"
            bindtap="unlockField"
          >æ‰‹åŠ¨ä¿®æ­£</button>
        </view>

        <!-- æœªé”å®šæ—¶æ­£å¸¸è¾“å…¥ -->
        <radio-group
          wx:else
          class="radio-group"
          data-field="gender"
          bindchange="onRadioChange"
        >
          <radio class="radio-item" value="ç”·" checked="{{formData.gender === 'ç”·'}}">ç”·</radio>
          <radio class="radio-item" value="å¥³" checked="{{formData.gender === 'å¥³'}}">å¥³</radio>
        </radio-group>

        <text class="error-text" wx:if="{{errors.gender}}">{{errors.gender}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">å‡ºç”Ÿæ—¥æœŸ</label>

        <!-- è‡ªåŠ¨è¯†åˆ«åæ˜¾ç¤ºåªè¯»çŠ¶æ€ -->
        <view wx:if="{{birthDateLocked}}" class="field-locked">
          <view class="locked-value">
            <text class="value-text">{{formData.birthDate}}</text>
            <view class="auto-fill-badge">ä»èº«ä»½è¯è‡ªåŠ¨è¯†åˆ«</view>
          </view>
          <button
            class="unlock-btn"
            data-field="birthDate"
            bindtap="unlockField"
          >æ‰‹åŠ¨ä¿®æ­£</button>
        </view>

        <!-- æœªé”å®šæ—¶æ­£å¸¸è¾“å…¥ -->
        <picker
          wx:else
          mode="date"
          class="form-picker {{errors.birthDate ? 'error' : ''}}"
          value="{{formData.birthDate}}"
          data-field="birthDate"
          bindchange="onDateChange"
          end="{{today}}"
        >
          <view class="picker-display">{{formData.birthDate || 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ'}}</view>
        </picker>

        <text class="error-text" wx:if="{{errors.birthDate}}">{{errors.birthDate}}</text>
      </view>
    </view>

    <!-- ç¬¬2æ­¥ï¼šå®¶åº­ä¸è”ç³»äºº -->
    <view wx:if="{{currentStepData && currentStepData.key === 'contact'}}" class="form-section">
      <view class="form-group">
        <pm-input
          label="å¸¸ä½åœ°å€"
          required="{{true}}"
          type="textarea"
          value="{{formData.address}}"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€"
          data-field="address"
          bindinput="onInputChange"
          error="{{errors.address || ''}}"
          maxlength="200"
          textarea-auto-height="{{true}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="contacts-section">
        <view class="contacts-header">
          <text class="contacts-title">è”ç³»äººä¿¡æ¯</text>
          <text class="contacts-subtitle">è‡³å°‘ 1 ä½ï¼Œæœ€å¤š 5 ä½</text>
        </view>

        <view
          class="contact-item"
          wx:for="{{formData.contacts}}"
          wx:key="index"
        >
          <view class="contact-item__header">
            <text class="contact-item__title">è”ç³»äºº{{index + 1}}</text>
            <text
              wx:if="{{formData.contacts.length > 1}}"
              class="contact-item__remove"
              data-index="{{index}}"
              bindtap="removeContact"
            >ç§»é™¤</text>
          </view>

          <view class="contact-grid">
            <pm-input
              label="å…³ç³»"
              required="{{true}}"
              value="{{item.relationship}}"
              placeholder="å¦‚ï¼šçˆ¶äº²ã€æ¯äº²ã€ç…§æŠ¤äºº"
              data-index="{{index}}"
              data-field="relationship"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].relationship || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>

            <pm-input
              label="å§“å"
              required="{{true}}"
              value="{{item.name}}"
              placeholder="è¯·è¾“å…¥å§“å"
              data-index="{{index}}"
              data-field="name"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].name || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>

            <pm-input
              label="è”ç³»ç”µè¯"
              required="{{true}}"
              value="{{item.phone}}"
              placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "
              type="number"
              data-index="{{index}}"
              data-field="phone"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].phone || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>
          </view>
        </view>

        <view
          class="contacts-add"
          wx:if="{{formData.contacts.length < 5}}"
        >
          <pm-button
            type="ghost"
            size="small"
            icon="ï¼‹"
            text="æ·»åŠ è”ç³»äºº"
            bindtap="addContact"
          ></pm-button>
        </view>
      </view>

      <view wx:if="{{false}}" class="legacy-emergency-inputs">
        <pm-input
          label="ç´§æ€¥è”ç³»äºº"
          value="{{formData.emergencyContact}}"
          placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººå§“å"
          data-field="emergencyContact"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="ç´§æ€¥è”ç³»äººç”µè¯"
          value="{{formData.emergencyPhone}}"
          placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººç”µè¯"
          data-field="emergencyPhone"
          type="number"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>
    </view>

    <!-- ç¬¬3æ­¥ï¼šæƒ…å†µè¯´æ˜ -->
    <view wx:if="{{currentStepData && currentStepData.key === 'situation'}}" class="form-section">
      <view class="form-group">
        <label class="form-label required">å…¥ä½æ—¶é—´</label>
        <picker
          class="form-picker {{errors.admissionDate ? 'error' : ''}}"
          mode="date"
          value="{{formData.admissionDate || today}}"
          start="2000-01-01"
          end="{{today}}"
          data-field="admissionDate"
          bindchange="onDateChange"
        >
          <view class="picker-display">{{formData.admissionDate || today}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.admissionDate}}">{{errors.admissionDate}}</text>
      </view>

      <view class="form-group">
        <view class="textarea-container">
          <pm-input
            label="å…¥ä½ç†ç”±è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"
            type="textarea"
            value="{{formData.situation}}"
            placeholder="è¯·è¯¦ç»†æè¿°å…¥ä½ç†ç”±å’Œä½æˆ·æƒ…å†µï¼ŒåŒ…å«æŠ¤ç†éœ€æ±‚æˆ–ç—‡çŠ¶ä¿¡æ¯"
            data-field="situation"
            bindinput="onInputChange"
            error="{{errors.situation || ''}}"
            maxlength="{{situationConfig.maxLength}}"
            textarea-auto-height="{{true}}"
            show-confirm-bar="{{false}}"
            clearable="{{false}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
          <view class="char-count">
            {{formData.situation.length}}/{{situationConfig.maxLength}}å­—
            <text class="min-hint" wx:if="{{situationConfig.minLength > 0}}"
              >(å»ºè®®ä¸å°‘äº{{situationConfig.minLength}}å­—)</text
            >
          </view>
        </view>
        <text class="error-text" wx:if="{{errors.situation}}">{{errors.situation}}</text>

        <view class="hint-section">
          <view class="hint-title">å‚è€ƒç¤ºä¾‹ï¼š</view>
          <view class="example-text">{{situationConfig.example}}</view>
        </view>
      </view>

      <view class="form-group medical-group">
        <view class="group-title">å°±è¯Šæƒ…å†µï¼ˆé€‰å¡«ï¼‰</view>
        <pm-input
          label="å°±è¯ŠåŒ»é™¢"
          value="{{formData.visitHospital}}"
          placeholder="è¯·è¾“å…¥æœ¬æ¬¡å°±è¯Šçš„åŒ»é™¢åç§°"
          data-field="visitHospital"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="åŒ»é™¢è¯Šæ–­"
          type="textarea"
          value="{{formData.hospitalDiagnosis}}"
          placeholder="è¯·è¾“å…¥åŒ»é™¢ç»™å‡ºçš„è¯Šæ–­ä¿¡æ¯"
          data-field="hospitalDiagnosis"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="åŒ»ç”Ÿå§“å"
          value="{{formData.attendingDoctor}}"
          placeholder="è¯·è¾“å…¥è´Ÿè´£è¯Šç–—çš„åŒ»ç”Ÿå§“å"
          data-field="attendingDoctor"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group medical-group">
        <view class="group-title">åŒ»ç–—æƒ…å†µï¼ˆé€‰å¡«ï¼‰</view>
        <pm-input
          label="ç—‡çŠ¶è¯¦æƒ…"
          type="textarea"
          value="{{formData.symptomDetail}}"
          placeholder="è¯·æè¿°ä½æˆ·å½“å‰ç—‡çŠ¶æˆ–è¡¨ç°"
          data-field="symptomDetail"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="åŒ»æ²»è¿‡ç¨‹"
          type="textarea"
          value="{{formData.treatmentProcess}}"
          placeholder="è¯·è®°å½•ä¸»è¦æ²»ç–—è¿‡ç¨‹æˆ–æªæ–½"
          data-field="treatmentProcess"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="åç»­æ²»ç–—å®‰æ’"
          type="textarea"
          value="{{formData.followUpPlan}}"
          placeholder="è¯·æè¿°åç»­éšè®¿æˆ–æ²»ç–—è®¡åˆ’"
          data-field="followUpPlan"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>
    </view>

    <!-- ç¬¬4æ­¥ï¼šæ ¸å¯¹ä¸æäº¤ -->
    <view wx:if="{{currentStepData && currentStepData.key === 'review'}}" class="form-section">
      <view class="review-section">
        <view class="review-title">è¯·æ ¸å¯¹ä»¥ä¸‹ä¿¡æ¯</view>

        <view class="review-group">
          <view class="group-title">åŸºç¡€ä¿¡æ¯</view>
          <view class="review-item">
            <text class="item-label">å§“åï¼š</text>
            <text class="item-value">{{formData.patientName}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">è¯ä»¶ï¼š</text>
            <text class="item-value">{{idTypes[idTypeIndex]}} {{formData.idNumber}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">æ€§åˆ«ï¼š</text>
            <text class="item-value">{{formData.gender}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">å‡ºç”Ÿæ—¥æœŸï¼š</text>
            <text class="item-value">{{formData.birthDate}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.phone}}">
            <text class="item-label">è”ç³»ç”µè¯ï¼š</text>
            <text class="item-value">{{formData.phone}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">è”ç³»ä¿¡æ¯</view>
          <view class="review-item">
            <text class="item-label">å¸¸ä½åœ°å€ï¼š</text>
            <text class="item-value">{{formData.address}}</text>
          </view>
          <view
            class="review-item"
            wx:for="{{formData.contacts}}"
            wx:key="index"
          >
            <text class="item-label">è”ç³»äºº{{index + 1}}ï¼š</text>
            <text class="item-value"
              >{{item.relationship}} {{item.name}} {{item.phone}}</text
            >
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">æƒ…å†µè¯´æ˜</view>
          <view class="review-item">
            <text class="item-value situation">{{formData.situation}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">å…¥ä½ä¿¡æ¯</view>
          <view class="review-item">
            <text class="item-label">å…¥ä½æ—¶é—´ï¼š</text>
            <text class="item-value">{{formData.admissionDate}}</text>
          </view>
        </view>

        <view
          class="review-group"
          wx:if="{{formData.visitHospital || formData.hospitalDiagnosis || formData.attendingDoctor}}"
        >
          <view class="group-title">å°±è¯Šæƒ…å†µ</view>
          <view class="review-item" wx:if="{{formData.visitHospital}}">
            <text class="item-label">å°±è¯ŠåŒ»é™¢ï¼š</text>
            <text class="item-value">{{formData.visitHospital}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.hospitalDiagnosis}}">
            <text class="item-label">åŒ»é™¢è¯Šæ–­ï¼š</text>
            <text class="item-value">{{formData.hospitalDiagnosis}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.attendingDoctor}}">
            <text class="item-label">åŒ»ç”Ÿå§“åï¼š</text>
            <text class="item-value">{{formData.attendingDoctor}}</text>
          </view>
        </view>

        <view
          class="review-group"
          wx:if="{{formData.symptomDetail || formData.treatmentProcess || formData.followUpPlan}}"
        >
          <view class="group-title">åŒ»ç–—æƒ…å†µ</view>
          <view class="review-item" wx:if="{{formData.symptomDetail}}">
            <text class="item-label">ç—‡çŠ¶è¯¦æƒ…ï¼š</text>
            <text class="item-value">{{formData.symptomDetail}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.treatmentProcess}}">
            <text class="item-label">åŒ»æ²»è¿‡ç¨‹ï¼š</text>
            <text class="item-value">{{formData.treatmentProcess}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.followUpPlan}}">
            <text class="item-label">åç»­æ²»ç–—å®‰æ’ï¼š</text>
            <text class="item-value">{{formData.followUpPlan}}</text>
          </view>
        </view>

        <view class="completion-status">
          <view class="status-item {{allRequiredCompleted ? 'completed' : 'incomplete'}}">
            <text class="status-icon">{{allRequiredCompleted ? 'âœ…' : 'âš ï¸'}}</text>
            <text class="status-text">å¿…å¡«é¡¹{{allRequiredCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="action-bar">
    <view class="action-buttons">
      <pm-button
        wx:if="{{hasPrevStep}}"
        type="default"
        block="{{true}}"
        bindtap="onPrevStep"
        class="btn btn-secondary"
        text="ä¸Šä¸€æ­¥"
      ></pm-button>

      <pm-button
        wx:if="{{hasNextStep}}"
        type="primary"
        block="{{true}}"
        disabled="{{!canProceedToNext}}"
        bindtap="onNextStep"
        class="btn btn-primary"
        text="ä¸‹ä¸€æ­¥"
      ></pm-button>

      <pm-button
        wx:if="{{!hasNextStep}}"
        type="primary"
        block="{{true}}"
        disabled="{{!allRequiredCompleted || submitting}}"
        loading="{{submitting}}"
        bindtap="onSubmit"
        class="btn btn-success"
        text="{{submitting ? 'æäº¤ä¸­...' : 'å®Œæˆå…¥ä½'}}"
      ></pm-button>
    </view>
  </view>

  <!-- è‡ªåŠ¨å¡«å……æˆåŠŸæç¤º Toast -->
  <view class="auto-fill-toast" wx:if="{{showAutoFillTip}}">
    <icon type="success_no_circle" size="20" color="#52c41a"/>
    <text>å·²è‡ªåŠ¨è¯†åˆ«æ€§åˆ«å’Œå‡ºç”Ÿæ—¥æœŸ</text>
  </view>
</view>
