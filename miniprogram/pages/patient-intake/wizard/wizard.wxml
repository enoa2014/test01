<!--æ‚£è€…å½•å…¥å‘å¯¼ç•Œé¢-->
<view class="theme-root wizard-container">
  <!-- é¡¶éƒ¨è¿›åº¦æŒ‡ç¤ºå™¨ -->
  <view class="progress-header">
    <view class="progress-steps">
      <view
        wx:for="{{visibleSteps}}"
        wx:key="originalIndex"
        class="step-item {{currentStep === item.originalIndex ? 'active' : ''}} {{currentStep > item.originalIndex ? 'completed' : ''}}"
        data-step="{{item.originalIndex}}"
        bindtap="onStepTap"
      >
        <view class="step-number">{{index + 1}}</view>
        <view class="step-label">{{item.title}}</view>
      </view>
    </view>
    <view class="progress-info">
      <text class="current-step">ç¬¬{{currentVisibleStepNumber}}æ­¥ / å…±{{totalVisibleSteps}}æ­¥</text>
      <text class="required-count" wx:if="{{requiredFieldsCount > 0}}">å‰©ä½™å¿…å¡«é¡¹ï¼š{{requiredFieldsCount}}</text>
    </view>
  </view>

  <!-- å½“å‰æ­¥éª¤æ ‡é¢˜å’Œå¿…å¡«é¡¹æç¤º -->
  <view class="step-header">
    <view class="step-title">{{currentStepData.title}}</view>
    <view class="required-fields" wx:if="{{currentStepData.requiredFields.length > 0}}">
      <text class="required-label">æœ¬æ­¥å¿…å¡«é¡¹ï¼š</text>
      <text class="required-list">{{currentStepData.requiredFieldsText}}</text>
    </view>
  </view>

  <!-- æ­¥éª¤å†…å®¹ -->
  <scroll-view class="step-content" scroll-y>
    <!-- ç¬¬1æ­¥ï¼šæ‚£è€…åŸºç¡€ä¿¡æ¯ -->
    <view wx:if="{{currentStep === 0}}" class="form-section">
      <view class="form-group">
        <label class="form-label required">å§“å</label>
        <input
          class="form-input {{errors.patientName ? 'error' : ''}}"
          value="{{formData.patientName}}"
          data-field="patientName"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥æ‚£è€…å§“å"
        />
        <text class="error-text" wx:if="{{errors.patientName}}">{{errors.patientName}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">è¯ä»¶ç±»å‹</label>
        <picker
          class="form-picker {{errors.idType ? 'error' : ''}}"
          value="{{idTypeIndex}}"
          range="{{idTypes}}"
          data-field="idType"
          bindchange="onPickerChange"
        >
          <view class="picker-display">{{idTypes[idTypeIndex] || 'è¯·é€‰æ‹©è¯ä»¶ç±»å‹'}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.idType}}">{{errors.idType}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">è¯ä»¶å·ç </label>
        <input
          class="form-input {{errors.idNumber ? 'error' : ''}}"
          value="{{formData.idNumber}}"
          data-field="idNumber"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥è¯ä»¶å·ç "
        />
        <text class="hint-text">ç¤ºä¾‹ï¼šèº«ä»½è¯æ ¼å¼ä¸º18ä½æ•°å­—</text>
        <text class="error-text" wx:if="{{errors.idNumber}}">{{errors.idNumber}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">æ€§åˆ«</label>
        <radio-group class="radio-group" data-field="gender" bindchange="onRadioChange">
          <radio class="radio-item" value="ç”·" checked="{{formData.gender === 'ç”·'}}">ç”·</radio>
          <radio class="radio-item" value="å¥³" checked="{{formData.gender === 'å¥³'}}">å¥³</radio>
        </radio-group>
        <text class="error-text" wx:if="{{errors.gender}}">{{errors.gender}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">å‡ºç”Ÿæ—¥æœŸ</label>
        <picker
          mode="date"
          class="form-picker {{errors.birthDate ? 'error' : ''}}"
          value="{{formData.birthDate}}"
          data-field="birthDate"
          bindchange="onDateChange"
          end="{{today}}"
        >
          <view class="picker-display">{{formData.birthDate || 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ'}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.birthDate}}">{{errors.birthDate}}</text>
      </view>

      <view class="form-group">
        <label class="form-label">è”ç³»ç”µè¯</label>
        <input
          class="form-input {{errors.phone ? 'error' : ''}}"
          value="{{formData.phone}}"
          data-field="phone"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "
          type="number"
        />
        <text class="hint-text">ç¤ºä¾‹ï¼š13812345678</text>
        <text class="error-text" wx:if="{{errors.phone}}">{{errors.phone}}</text>
      </view>
    </view>

    <!-- ç¬¬2æ­¥ï¼šå®¶åº­ä¸è”ç³»äºº -->
    <view wx:if="{{currentStep === 1}}" class="form-section">
      <view class="form-group">
        <label class="form-label required">å¸¸ä½åœ°å€</label>
        <textarea
          class="form-textarea {{errors.address ? 'error' : ''}}"
          value="{{formData.address}}"
          data-field="address"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€"
          maxlength="200"
        />
        <text class="error-text" wx:if="{{errors.address}}">{{errors.address}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">ç´§æ€¥è”ç³»äºº</label>
        <input
          class="form-input {{errors.emergencyContact ? 'error' : ''}}"
          value="{{formData.emergencyContact}}"
          data-field="emergencyContact"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººå§“å"
        />
        <text class="error-text" wx:if="{{errors.emergencyContact}}">{{errors.emergencyContact}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">ç´§æ€¥è”ç³»äººç”µè¯</label>
        <input
          class="form-input {{errors.emergencyPhone ? 'error' : ''}}"
          value="{{formData.emergencyPhone}}"
          data-field="emergencyPhone"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "
          type="number"
        />
        <text class="error-text" wx:if="{{errors.emergencyPhone}}">{{errors.emergencyPhone}}</text>
      </view>

      <view class="form-group">
        <label class="form-label">å¤‡ç”¨è”ç³»äºº</label>
        <input
          class="form-input {{errors.backupContact ? 'error' : ''}}"
          value="{{formData.backupContact}}"
          data-field="backupContact"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥å¤‡ç”¨è”ç³»äººå§“åï¼ˆé€‰å¡«ï¼‰"
        />
        <text class="error-text" wx:if="{{errors.backupContact}}">{{errors.backupContact}}</text>
      </view>

      <view class="form-group">
        <label class="form-label">å¤‡ç”¨è”ç³»äººç”µè¯</label>
        <input
          class="form-input {{errors.backupPhone ? 'error' : ''}}"
          value="{{formData.backupPhone}}"
          data-field="backupPhone"
          bindinput="onInputChange"
          placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ï¼ˆé€‰å¡«ï¼‰"
          type="number"
        />
        <text class="error-text" wx:if="{{errors.backupPhone}}">{{errors.backupPhone}}</text>
      </view>
    </view>

    <!-- ç¬¬3æ­¥ï¼šæƒ…å†µè¯´æ˜ -->
    <view wx:if="{{currentStep === 2}}" class="form-section">
      <view class="form-group">
        <label class="form-label required">å…¥ä½ç†ç”±è¯´æ˜</label>
        <view class="textarea-container">
          <textarea
            class="form-textarea large {{errors.situation ? 'error' : ''}}"
            value="{{formData.situation}}"
            data-field="situation"
            bindinput="onInputChange"
            placeholder="è¯·è¯¦ç»†æè¿°å…¥ä½ç†ç”±å’Œæ‚£è€…æƒ…å†µï¼ŒåŒ…å«æŠ¤ç†éœ€æ±‚æˆ–ç—‡çŠ¶ä¿¡æ¯"
            maxlength="{{situationConfig.maxLength}}"
            show-confirm-bar="{{false}}"
          />
          <view class="char-count">
            {{formData.situation.length}}/{{situationConfig.maxLength}}å­—
            <text class="min-hint">(æœ€å°‘{{situationConfig.minLength}}å­—)</text>
          </view>
        </view>
        <text class="error-text" wx:if="{{errors.situation}}">{{errors.situation}}</text>

        <view class="hint-section">
          <view class="hint-title">å‚è€ƒç¤ºä¾‹ï¼š</view>
          <view class="example-text">{{situationConfig.example}}</view>
        </view>
      </view>
    </view>

    <!-- ç¬¬4æ­¥ï¼šé™„ä»¶ä¸Šä¼  -->
    <view wx:if="{{currentStep === 3}}" class="form-section">
      <view class="upload-section">
        <view class="upload-header">
          <view class="upload-title">é™„ä»¶ä¸Šä¼ ï¼ˆé€‰å¡«ï¼‰</view>
          <view class="upload-desc">æ”¯æŒèº«ä»½è¯ã€è¯Šæ–­è¯æ˜ã€çŸ¥æƒ…åŒæ„ä¹¦ç­‰æ–‡ä»¶</view>
        </view>

        <view class="upload-rules">
          <view class="rule-item">â€¢ å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ {{uploadConfig.maxFileSize}}MB</view>
          <view class="rule-item">â€¢ æ”¯æŒæ ¼å¼ï¼š{{uploadConfig.allowedTypes}}</view>
          <view class="rule-item">â€¢ æœ€å¤šä¸Šä¼  {{uploadConfig.maxCount}} ä¸ªæ–‡ä»¶</view>
        </view>

        <view class="upload-area" bindtap="chooseFile">
          <view class="upload-icon">ğŸ“</view>
          <view class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</view>
        </view>

        <view class="upload-list" wx:if="{{uploadedFiles.length > 0}}">
          <view
            wx:for="{{uploadedFiles}}"
            wx:key="id"
            class="file-item"
          >
            <view class="file-info">
              <view class="file-name">{{item.displayName}}</view>
              <view class="file-size">{{item.sizeText}}</view>
            </view>
            <view class="file-actions">
              <text class="action-btn" data-id="{{item.id}}" bindtap="previewFile">é¢„è§ˆ</text>
              <text class="action-btn delete" data-id="{{item.id}}" bindtap="deleteFile">åˆ é™¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¬¬5æ­¥ï¼šæ ¸å¯¹ä¸æäº¤ -->
    <view wx:if="{{currentStep === 4}}" class="form-section">
      <view class="review-section">
        <view class="review-title">è¯·æ ¸å¯¹ä»¥ä¸‹ä¿¡æ¯</view>

        <view class="review-group">
          <view class="group-title">åŸºç¡€ä¿¡æ¯</view>
          <view class="review-item">
            <text class="item-label">å§“åï¼š</text>
            <text class="item-value">{{formData.patientName}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">è¯ä»¶ï¼š</text>
            <text class="item-value">{{idTypes[idTypeIndex]}} {{formData.idNumber}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">æ€§åˆ«ï¼š</text>
            <text class="item-value">{{formData.gender}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">å‡ºç”Ÿæ—¥æœŸï¼š</text>
            <text class="item-value">{{formData.birthDate}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.phone}}">
            <text class="item-label">è”ç³»ç”µè¯ï¼š</text>
            <text class="item-value">{{formData.phone}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">è”ç³»ä¿¡æ¯</view>
          <view class="review-item">
            <text class="item-label">å¸¸ä½åœ°å€ï¼š</text>
            <text class="item-value">{{formData.address}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">ç´§æ€¥è”ç³»äººï¼š</text>
            <text class="item-value">{{formData.emergencyContact}} {{formData.emergencyPhone}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.backupContact}}">
            <text class="item-label">å¤‡ç”¨è”ç³»äººï¼š</text>
            <text class="item-value">{{formData.backupContact}} {{formData.backupPhone}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">æƒ…å†µè¯´æ˜</view>
          <view class="review-item">
            <text class="item-value situation">{{formData.situation}}</text>
          </view>
        </view>

        <view class="review-group" wx:if="{{uploadedFiles.length > 0}}">
          <view class="group-title">é™„ä»¶ ({{uploadedFiles.length}})</view>
          <view wx:for="{{uploadedFiles}}" wx:key="id" class="review-item">
            <text class="item-value">{{item.displayName}}</text>
          </view>
        </view>

        <view class="completion-status">
          <view class="status-item {{allRequiredCompleted ? 'completed' : 'incomplete'}}">
            <text class="status-icon">{{allRequiredCompleted ? 'âœ…' : 'âš ï¸'}}</text>
            <text class="status-text">å¿…å¡«é¡¹{{allRequiredCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="action-bar">
    <view class="action-buttons">
      <button
        class="btn btn-secondary"
        wx:if="{{hasPrevStep}}"
        bindtap="onPrevStep"
      >
        ä¸Šä¸€æ­¥
      </button>

      <button
        class="btn btn-primary"
        wx:if="{{hasNextStep}}"
        disabled="{{!canProceedToNext}}"
        bindtap="onNextStep"
      >
        ä¸‹ä¸€æ­¥
      </button>

      <button
        class="btn btn-success"
        wx:if="{{!hasNextStep}}"
        disabled="{{!allRequiredCompleted || submitting}}"
        bindtap="onSubmit"
        loading="{{submitting}}"
      >
        {{submitting ? 'æäº¤ä¸­...' : 'å®Œæˆå…¥ä½'}}
      </button>
    </view>

    <view class="draft-info" wx:if="{{draftSaved}}">
      <text class="draft-text">âœ… è‰ç¨¿å·²ä¿å­˜</text>
    </view>
  </view>
</view>

<!-- è‰ç¨¿æ¢å¤æç¤º -->
<view class="draft-modal" wx:if="{{showDraftModal}}">
  <view class="modal-content">
    <view class="modal-title">å‘ç°æœªå®Œæˆçš„è‰ç¨¿</view>
    <view class="modal-text">æ‚¨ä¸Šæ¬¡æœ‰æœªå®Œæˆçš„å…¥ä½æµç¨‹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</view>
    <view class="modal-actions">
      <button class="modal-btn secondary" bindtap="discardDraft">é‡æ–°å¼€å§‹</button>
      <button class="modal-btn primary" bindtap="restoreDraft">ç»§ç»­è‰ç¨¿</button>
    </view>
  </view>
</view>
