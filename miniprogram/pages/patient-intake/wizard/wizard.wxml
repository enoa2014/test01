<!--住户录入向导界面-->
<view class="theme-root wizard-container {{themeClass}}">
  <!-- 顶部进度指示器 -->
  <view class="progress-header">
    <view class="progress-steps">
      <view
        wx:for="{{visibleSteps}}"
        wx:key="originalIndex"
        class="step-item {{currentStep === item.originalIndex ? 'active' : ''}} {{currentStep > item.originalIndex ? 'completed' : ''}}"
        data-step="{{item.originalIndex}}"
        bindtap="onStepTap"
      >
        <view class="step-number">{{index + 1}}</view>
        <view class="step-label">{{item.title}}</view>
      </view>
    </view>
    <view class="progress-info">
      <text class="current-step">第{{currentVisibleStepNumber}}步 / 共{{totalVisibleSteps}}步</text>
      <text class="required-count" wx:if="{{requiredFieldsCount > 0}}"
        >剩余必填项：{{requiredFieldsCount}}</text
      >
    </view>
  </view>

  <!-- 当前步骤标题和必填项提示 -->
  <view class="step-header">
    <view class="step-title">{{currentStepData.title}}</view>
    <view class="required-fields" wx:if="{{currentStepData.requiredFields.length > 0}}">
      <text class="required-label">本步必填项：</text>
      <text class="required-list">{{currentStepData.requiredFieldsText}}</text>
    </view>
  </view>

  <!-- 步骤内容 -->
  <scroll-view class="step-content" scroll-y>
    <!-- 第1步：基础身份 -->
    <view wx:if="{{currentStepData && currentStepData.key === 'identity'}}" class="form-section">
      <view class="step-intro">
        <text class="intro-icon">📝</text>
        <text class="intro-text">请填写住户基本身份信息</text>
      </view>

      <view class="form-group">
        <pm-input
          label="姓名"
          required="{{true}}"
          value="{{formData.patientName}}"
          placeholder="请输入住户姓名"
          data-field="patientName"
          bindinput="onInputChange"
          error="{{errors.patientName || ''}}"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group">
        <label class="form-label required">证件类型</label>
        <picker
          class="form-picker {{errors.idType ? 'error' : ''}}"
          value="{{idTypeIndex}}"
          range="{{idTypes}}"
          data-field="idType"
          bindchange="onPickerChange"
        >
          <view class="picker-display">{{idTypes[idTypeIndex] || '请选择证件类型'}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.idType}}">{{errors.idType}}</text>
      </view>

      <view class="form-group">
        <pm-input
          label="证件号码"
          required="{{true}}"
          value="{{formData.idNumber}}"
          placeholder="请输入证件号码"
          data-field="idNumber"
          bindinput="onInputChange"
          error="{{errors.idNumber || ''}}"
          hint="示例：身份证格式为18位数字"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group">
        <pm-input
          label="联系电话"
          value="{{formData.phone}}"
          placeholder="请输入11位手机号码（选填）"
          type="number"
          data-field="phone"
          bindinput="onInputChange"
          error="{{errors.phone || ''}}"
          hint="示例：13812345678"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="step-intro step-intro--secondary">
        <text class="intro-icon">✨</text>
        <text class="intro-text">系统已自动识别以下信息，请确认</text>
      </view>

      <view class="form-group">
        <label class="form-label required">性别</label>

        <!-- 自动识别后显示只读状态 -->
        <view wx:if="{{genderLocked}}" class="field-locked">
          <view class="locked-value">
            <text class="value-text">{{formData.gender}}</text>
            <view class="auto-fill-badge">从身份证自动识别</view>
          </view>
          <button
            class="unlock-btn"
            data-field="gender"
            bindtap="unlockField"
          >手动修正</button>
        </view>

        <!-- 未锁定时正常输入 -->
        <radio-group
          wx:else
          class="radio-group"
          data-field="gender"
          bindchange="onRadioChange"
        >
          <radio class="radio-item" value="男" checked="{{formData.gender === '男'}}">男</radio>
          <radio class="radio-item" value="女" checked="{{formData.gender === '女'}}">女</radio>
        </radio-group>

        <text class="error-text" wx:if="{{errors.gender}}">{{errors.gender}}</text>
      </view>

      <view class="form-group">
        <label class="form-label required">出生日期</label>

        <!-- 自动识别后显示只读状态 -->
        <view wx:if="{{birthDateLocked}}" class="field-locked">
          <view class="locked-value">
            <text class="value-text">{{formData.birthDate}}</text>
            <view class="auto-fill-badge">从身份证自动识别</view>
          </view>
          <button
            class="unlock-btn"
            data-field="birthDate"
            bindtap="unlockField"
          >手动修正</button>
        </view>

        <!-- 未锁定时正常输入 -->
        <picker
          wx:else
          mode="date"
          class="form-picker {{errors.birthDate ? 'error' : ''}}"
          value="{{formData.birthDate}}"
          data-field="birthDate"
          bindchange="onDateChange"
          end="{{today}}"
        >
          <view class="picker-display">{{formData.birthDate || '请选择出生日期'}}</view>
        </picker>

        <text class="error-text" wx:if="{{errors.birthDate}}">{{errors.birthDate}}</text>
      </view>
    </view>

    <!-- 第2步：家庭与联系人 -->
    <view wx:if="{{currentStepData && currentStepData.key === 'contact'}}" class="form-section">
      <view class="form-group">
        <pm-input
          label="常住地址"
          required="{{true}}"
          type="textarea"
          value="{{formData.address}}"
          placeholder="请输入详细地址"
          data-field="address"
          bindinput="onInputChange"
          error="{{errors.address || ''}}"
          maxlength="200"
          textarea-auto-height="{{true}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="contacts-section">
        <view class="contacts-header">
          <text class="contacts-title">联系人信息</text>
          <text class="contacts-subtitle">至少 1 位，最多 5 位</text>
        </view>

        <view
          class="contact-item"
          wx:for="{{formData.contacts}}"
          wx:key="index"
        >
          <view class="contact-item__header">
            <text class="contact-item__title">联系人{{index + 1}}</text>
            <text
              wx:if="{{formData.contacts.length > 1}}"
              class="contact-item__remove"
              data-index="{{index}}"
              bindtap="removeContact"
            >移除</text>
          </view>

          <view class="contact-grid">
            <pm-input
              label="关系"
              required="{{true}}"
              value="{{item.relationship}}"
              placeholder="如：父亲、母亲、照护人"
              data-index="{{index}}"
              data-field="relationship"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].relationship || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>

            <pm-input
              label="姓名"
              required="{{true}}"
              value="{{item.name}}"
              placeholder="请输入姓名"
              data-index="{{index}}"
              data-field="name"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].name || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>

            <pm-input
              label="联系电话"
              required="{{true}}"
              value="{{item.phone}}"
              placeholder="请输入11位手机号码"
              type="number"
              data-index="{{index}}"
              data-field="phone"
              bindinput="onContactFieldInput"
              error="{{contactErrors[index] ? contactErrors[index].phone || '' : ''}}"
              clearable="{{true}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>
          </view>
        </view>

        <view
          class="contacts-add"
          wx:if="{{formData.contacts.length < 5}}"
        >
          <pm-button
            type="ghost"
            size="small"
            icon="＋"
            text="添加联系人"
            bindtap="addContact"
          ></pm-button>
        </view>
      </view>

      <view wx:if="{{false}}" class="legacy-emergency-inputs">
        <pm-input
          label="紧急联系人"
          value="{{formData.emergencyContact}}"
          placeholder="请输入紧急联系人姓名"
          data-field="emergencyContact"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="紧急联系人电话"
          value="{{formData.emergencyPhone}}"
          placeholder="请输入紧急联系人电话"
          data-field="emergencyPhone"
          type="number"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>
    </view>

    <!-- 第3步：情况说明 -->
    <view wx:if="{{currentStepData && currentStepData.key === 'situation'}}" class="form-section">
      <view class="form-group">
        <label class="form-label required">入住时间</label>
        <picker
          class="form-picker {{errors.admissionDate ? 'error' : ''}}"
          mode="date"
          value="{{formData.admissionDate || today}}"
          start="2000-01-01"
          end="{{today}}"
          data-field="admissionDate"
          bindchange="onDateChange"
        >
          <view class="picker-display">{{formData.admissionDate || today}}</view>
        </picker>
        <text class="error-text" wx:if="{{errors.admissionDate}}">{{errors.admissionDate}}</text>
      </view>

      <view class="form-group">
        <view class="textarea-container">
          <pm-input
            label="入住理由说明（选填）"
            type="textarea"
            value="{{formData.situation}}"
            placeholder="请详细描述入住理由和住户情况，包含护理需求或症状信息"
            data-field="situation"
            bindinput="onInputChange"
            error="{{errors.situation || ''}}"
            maxlength="{{situationConfig.maxLength}}"
            textarea-auto-height="{{true}}"
            show-confirm-bar="{{false}}"
            clearable="{{false}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
          <view class="char-count">
            {{formData.situation.length}}/{{situationConfig.maxLength}}字
            <text class="min-hint" wx:if="{{situationConfig.minLength > 0}}"
              >(建议不少于{{situationConfig.minLength}}字)</text
            >
          </view>
        </view>
        <text class="error-text" wx:if="{{errors.situation}}">{{errors.situation}}</text>

        <view class="hint-section">
          <view class="hint-title">参考示例：</view>
          <view class="example-text">{{situationConfig.example}}</view>
        </view>
      </view>

      <view class="form-group medical-group">
        <view class="group-title">就诊情况（选填）</view>
        <pm-input
          label="就诊医院"
          value="{{formData.visitHospital}}"
          placeholder="请输入本次就诊的医院名称"
          data-field="visitHospital"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="医院诊断"
          type="textarea"
          value="{{formData.hospitalDiagnosis}}"
          placeholder="请输入医院给出的诊断信息"
          data-field="hospitalDiagnosis"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="医生姓名"
          value="{{formData.attendingDoctor}}"
          placeholder="请输入负责诊疗的医生姓名"
          data-field="attendingDoctor"
          bindinput="onInputChange"
          clearable="{{true}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>

      <view class="form-group medical-group">
        <view class="group-title">医疗情况（选填）</view>
        <pm-input
          label="症状详情"
          type="textarea"
          value="{{formData.symptomDetail}}"
          placeholder="请描述住户当前症状或表现"
          data-field="symptomDetail"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="医治过程"
          type="textarea"
          value="{{formData.treatmentProcess}}"
          placeholder="请记录主要治疗过程或措施"
          data-field="treatmentProcess"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
        <pm-input
          label="后续治疗安排"
          type="textarea"
          value="{{formData.followUpPlan}}"
          placeholder="请描述后续随访或治疗计划"
          data-field="followUpPlan"
          bindinput="onInputChange"
          textarea-auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          clearable="{{false}}"
          label-position="top"
          block="{{true}}"
        ></pm-input>
      </view>
    </view>

    <!-- 第4步：核对与提交 -->
    <view wx:if="{{currentStepData && currentStepData.key === 'review'}}" class="form-section">
      <view class="review-section">
        <view class="review-title">请核对以下信息</view>

        <view class="review-group">
          <view class="group-title">基础信息</view>
          <view class="review-item">
            <text class="item-label">姓名：</text>
            <text class="item-value">{{formData.patientName}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">证件：</text>
            <text class="item-value">{{idTypes[idTypeIndex]}} {{formData.idNumber}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">性别：</text>
            <text class="item-value">{{formData.gender}}</text>
          </view>
          <view class="review-item">
            <text class="item-label">出生日期：</text>
            <text class="item-value">{{formData.birthDate}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.phone}}">
            <text class="item-label">联系电话：</text>
            <text class="item-value">{{formData.phone}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">联系信息</view>
          <view class="review-item">
            <text class="item-label">常住地址：</text>
            <text class="item-value">{{formData.address}}</text>
          </view>
          <view
            class="review-item"
            wx:for="{{formData.contacts}}"
            wx:key="index"
          >
            <text class="item-label">联系人{{index + 1}}：</text>
            <text class="item-value"
              >{{item.relationship}} {{item.name}} {{item.phone}}</text
            >
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">情况说明</view>
          <view class="review-item">
            <text class="item-value situation">{{formData.situation}}</text>
          </view>
        </view>

        <view class="review-group">
          <view class="group-title">入住信息</view>
          <view class="review-item">
            <text class="item-label">入住时间：</text>
            <text class="item-value">{{formData.admissionDate}}</text>
          </view>
        </view>

        <view
          class="review-group"
          wx:if="{{formData.visitHospital || formData.hospitalDiagnosis || formData.attendingDoctor}}"
        >
          <view class="group-title">就诊情况</view>
          <view class="review-item" wx:if="{{formData.visitHospital}}">
            <text class="item-label">就诊医院：</text>
            <text class="item-value">{{formData.visitHospital}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.hospitalDiagnosis}}">
            <text class="item-label">医院诊断：</text>
            <text class="item-value">{{formData.hospitalDiagnosis}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.attendingDoctor}}">
            <text class="item-label">医生姓名：</text>
            <text class="item-value">{{formData.attendingDoctor}}</text>
          </view>
        </view>

        <view
          class="review-group"
          wx:if="{{formData.symptomDetail || formData.treatmentProcess || formData.followUpPlan}}"
        >
          <view class="group-title">医疗情况</view>
          <view class="review-item" wx:if="{{formData.symptomDetail}}">
            <text class="item-label">症状详情：</text>
            <text class="item-value">{{formData.symptomDetail}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.treatmentProcess}}">
            <text class="item-label">医治过程：</text>
            <text class="item-value">{{formData.treatmentProcess}}</text>
          </view>
          <view class="review-item" wx:if="{{formData.followUpPlan}}">
            <text class="item-label">后续治疗安排：</text>
            <text class="item-value">{{formData.followUpPlan}}</text>
          </view>
        </view>

        <view class="completion-status">
          <view class="status-item {{allRequiredCompleted ? 'completed' : 'incomplete'}}">
            <text class="status-icon">{{allRequiredCompleted ? '✅' : '⚠️'}}</text>
            <text class="status-text">必填项{{allRequiredCompleted ? '已完成' : '未完成'}}</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部操作区 -->
  <view class="action-bar">
    <view class="action-buttons">
      <pm-button
        wx:if="{{hasPrevStep}}"
        type="default"
        block="{{true}}"
        bindtap="onPrevStep"
        class="btn btn-secondary"
        text="上一步"
      ></pm-button>

      <pm-button
        wx:if="{{hasNextStep}}"
        type="primary"
        block="{{true}}"
        disabled="{{!canProceedToNext}}"
        bindtap="onNextStep"
        class="btn btn-primary"
        text="下一步"
      ></pm-button>

      <pm-button
        wx:if="{{!hasNextStep}}"
        type="primary"
        block="{{true}}"
        disabled="{{!allRequiredCompleted || submitting}}"
        loading="{{submitting}}"
        bindtap="onSubmit"
        class="btn btn-success"
        text="{{submitting ? '提交中...' : '完成入住'}}"
      ></pm-button>
    </view>
  </view>

  <!-- 自动填充成功提示 Toast -->
  <view class="auto-fill-toast" wx:if="{{showAutoFillTip}}">
    <icon type="success_no_circle" size="20" color="#52c41a"/>
    <text>已自动识别性别和出生日期</text>
  </view>
</view>
