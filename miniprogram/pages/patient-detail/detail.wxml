<view class="theme-root detail-container">
  <view wx:if="{{loading}}" class="placeholder">正在加载住户信息…</view>
  <view wx:elif="{{error}}" class="error">{{error}}</view>
  <scroll-view wx:else scroll-y enable-flex class="detail-scroll">
    <view class="patient-header">
      <view class="patient-header-row">
        <view class="patient-name-section">
          <text class="patient-detail-name"
            >{{editMode ? editForm.patientName : (patient.patientName || '')}}</text
          >
          <!-- 运营关键指标 -->
          <view wx:if="{{!editMode && patient}}" class="patient-metrics">
            <view
              wx:if="{{patient.status}}"
              class="metric-badge status-{{patient.statusClass || 'unknown'}}"
            >
              {{patient.statusDisplay || patient.status}}
            </view>
            <view wx:if="{{patient.admissionCount}}" class="metric-item">
              <text class="metric-label">入住</text>
              <text class="metric-value">{{patient.admissionCount}}次</text>
            </view>
            <view wx:if="{{patient.lastAdmissionTime}}" class="metric-item">
              <text class="metric-label">最近</text>
              <text class="metric-value">{{patient.lastAdmissionTimeDisplay}}</text>
            </view>
          </view>
        </view>
        <view class="edit-toolbar">
          <view wx:if="{{!editMode}}" class="edit-button" bindtap="onEditStart">编辑资料</view>
          <block wx:else>
            <view class="edit-button plain" bindtap="onEditCancel">取消</view>
            <view
              class="edit-button secondary {{!editDirty ? 'disabled' : ''}}"
              bindtap="onSaveDraft"
            >
              暂存
            </view>
            <view
              class="edit-button primary {{(!editCanSave || saving) ? 'disabled' : ''}}"
              bindtap="onSaveTap"
            >
              {{saving ? '保存中…' : '保存'}}
            </view>
          </block>
        </view>
      </view>
      <view wx:if="{{editMode}}" class="edit-mode-banner">
        <text class="edit-mode-icon">✏️</text>
        <text class="edit-mode-text">编辑模式：修改后请点击"保存"按钮</text>
      </view>
    </view>

    <view wx:if="{{editMode}}" class="form-section">
      <text class="form-section-title">基本信息</text>
      <block wx:for="{{patientFieldConfig}}" wx:key="key">
        <block wx:if="{{item.type === 'picker'}}">
          <view class="form-field">
            <text class="field-label">{{item.label}}</text>
            <picker
              mode="selector"
              range="{{item.options}}"
              value="{{editPickerIndex[item.key] || 0}}"
              data-key="{{item.key}}"
              data-options="{{item.options}}"
              bindchange="onPickerChange"
            >
              <view class="picker-value"
                >{{editForm[item.key] || item.options[0] || '请选择'}}</view
              >
            </picker>
            <text wx:if="{{editErrors[item.key]}}" class="field-error"
              >{{editErrors[item.key]}}</text
            >
          </view>
        </block>
        <block wx:elif="{{item.type === 'date'}}">
          <view class="form-field">
            <text class="field-label">{{item.label}}</text>
            <picker
              mode="date"
              value="{{editForm[item.key]}}"
              data-key="{{item.key}}"
              bindchange="onDatePickerChange"
            >
              <view class="picker-value">{{editForm[item.key] || '请选择日期'}}</view>
            </picker>
            <text wx:if="{{editErrors[item.key]}}" class="field-error"
              >{{editErrors[item.key]}}</text
            >
          </view>
        </block>
        <block wx:elif="{{item.type === 'textarea'}}">
          <pm-input
            label="{{item.label}}"
            type="textarea"
            value="{{editForm[item.key]}}"
            placeholder="请输入{{item.label}}"
            data-key="{{item.key}}"
            bindinput="onEditFieldInput"
            error="{{editErrors[item.key] || ''}}"
            clearable="{{false}}"
            textarea-auto-height="{{item.autoHeight}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
        </block>
        <block wx:else>
          <pm-input
            label="{{item.label}}"
            value="{{editForm[item.key]}}"
            placeholder="请输入{{item.label}}"
            type="{{item.keyboard === 'number' ? 'number' : 'text'}}"
            data-key="{{item.key}}"
            bindinput="onEditFieldInput"
            error="{{editErrors[item.key] || ''}}"
            clearable="{{true}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
        </block>
      </block>

      <text class="form-section-title">联系与紧急联系人</text>
      <block wx:for="{{contactFieldConfig}}" wx:key="key">
        <block wx:if="{{item.type === 'textarea'}}">
          <pm-input
            label="{{item.label}}"
            type="textarea"
            value="{{editForm[item.key]}}"
            placeholder="请输入{{item.label}}"
            data-key="{{item.key}}"
            bindinput="onEditFieldInput"
            error="{{editErrors[item.key] || ''}}"
            clearable="{{false}}"
            textarea-auto-height="{{item.autoHeight}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
        </block>
        <block wx:else>
          <pm-input
            label="{{item.label}}"
            value="{{editForm[item.key]}}"
            placeholder="请输入{{item.label}}"
            type="{{item.keyboard === 'number' ? 'number' : 'text'}}"
            data-key="{{item.key}}"
            bindinput="onEditFieldInput"
            error="{{editErrors[item.key] || ''}}"
            clearable="{{true}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
        </block>
      </block>

      <text class="form-section-title">入住补充信息</text>
      <block wx:for="{{intakeFieldConfig}}" wx:key="key">
        <block wx:if="{{item.type === 'date'}}">
          <view class="form-field">
            <text class="field-label">{{item.label}}</text>
            <picker
              mode="date"
              value="{{editForm[item.key]}}"
              data-key="{{item.key}}"
              bindchange="onDatePickerChange"
            >
              <view class="picker-value">{{editForm[item.key] || '请选择日期'}}</view>
            </picker>
            <text wx:if="{{editErrors[item.key]}}" class="field-error"
              >{{editErrors[item.key]}}</text
            >
          </view>
        </block>
        <block wx:elif="{{item.type === 'textarea'}}">
          <block wx:if="{{item.key === 'narrative'}}">
            <pm-input
              label="{{item.label}}"
              type="textarea"
              value="{{editForm[item.key]}}"
              placeholder="请输入{{item.label}}"
              data-key="{{item.key}}"
              bindinput="onNarrativeInput"
              error="{{editErrors[item.key] || ''}}"
              clearable="{{false}}"
              textarea-auto-height="{{item.autoHeight}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>
          </block>
          <block wx:else>
            <pm-input
              label="{{item.label}}"
              type="textarea"
              value="{{editForm[item.key]}}"
              placeholder="请输入{{item.label}}"
              data-key="{{item.key}}"
              bindinput="onEditFieldInput"
              error="{{editErrors[item.key] || ''}}"
              clearable="{{false}}"
              textarea-auto-height="{{item.autoHeight}}"
              label-position="top"
              block="{{true}}"
            ></pm-input>
          </block>
        </block>
        <block wx:else>
          <pm-input
            label="{{item.label}}"
            value="{{editForm[item.key]}}"
            placeholder="请输入{{item.label}}"
            data-key="{{item.key}}"
            bindinput="onEditFieldInput"
            error="{{editErrors[item.key] || ''}}"
            clearable="{{true}}"
            label-position="top"
            block="{{true}}"
          ></pm-input>
        </block>
      </block>
    </view>

    <block wx:if="{{!editMode}}">
      <view wx:if="{{basicInfo.length}}" class="info-section">
        <text class="section-title">住户基本信息</text>
        <view class="info-row" wx:for="{{basicInfo}}" wx:key="label">
          <text class="label">{{item.label}}</text>
          <text class="value">{{item.value}}</text>
        </view>
      </view>

      <view wx:if="{{familyInfo.length}}" class="info-section">
        <text class="section-title">联系信息</text>
        <view class="info-row" wx:for="{{familyInfo}}" wx:key="label">
          <text class="label">{{item.label}}</text>
          <text class="value">{{item.value}}</text>
        </view>
      </view>

      <view wx:if="{{economicInfo.length}}" class="info-section">
        <text class="section-title">经济情况</text>
        <view class="info-row" wx:for="{{economicInfo}}" wx:key="label">
          <text class="label">{{item.label}}</text>
          <text class="value">{{item.value}}</text>
        </view>
      </view>
    </block>

    <!-- 所有入住记录 -->
    <view class="intake-records-section" wx:if="{{allIntakeRecords.length}}">
      <view class="section-header">
        <text class="section-title">入住记录历史（{{allIntakeRecords.length}}条）</text>
        <view
          class="sort-button {{recordsSortOrder === 'desc' ? 'desc' : 'asc'}}"
          bindtap="onToggleRecordsSort"
        >
          <text class="sort-icon">{{recordsSortOrder === 'desc' ? '▼' : '▲'}}</text>
          <text class="sort-text">{{recordsSortOrder === 'desc' ? '最新在前' : '最早在前'}}</text>
        </view>
      </view>
      <view class="intake-record-item" wx:for="{{allIntakeRecords}}" wx:key="intakeId">
        <view class="record-header">
          <text class="record-time">{{item.displayTime || '未记录时间'}}</text>
          <text
            class="record-status"
            wx:if="{{item.statusDisplay && item.statusDisplay !== '已提交'}}"
            >{{item.statusDisplay}}</text
          >
        </view>

        <!-- 就诊情况 -->
        <view
          class="record-section"
          wx:if="{{item.hospitalDisplay || item.diagnosisDisplay || item.doctorDisplay}}"
        >
          <text class="record-section-title">就诊情况</text>
          <view class="record-field" wx:if="{{item.hospitalDisplay}}">
            <text class="field-label">就诊医院：</text>
            <text class="field-value">{{item.hospitalDisplay}}</text>
          </view>
          <view class="record-field" wx:if="{{item.diagnosisDisplay}}">
            <text class="field-label">医院诊断：</text>
            <text class="field-value">{{item.diagnosisDisplay}}</text>
          </view>
          <view class="record-field" wx:if="{{item.doctorDisplay}}">
            <text class="field-label">医生姓名：</text>
            <text class="field-value">{{item.doctorDisplay}}</text>
          </view>
        </view>

        <!-- 医疗情况 -->
        <view
          class="record-section"
          wx:if="{{item.symptomDetailDisplay || item.treatmentProcessDisplay || item.followUpPlanDisplay}}"
        >
          <text class="record-section-title">医疗情况</text>
          <view class="record-field" wx:if="{{item.symptomDetailDisplay}}">
            <text class="field-label">症状详情：</text>
            <text class="field-value">{{item.symptomDetailDisplay}}</text>
          </view>
          <view class="record-field" wx:if="{{item.treatmentProcessDisplay}}">
            <text class="field-label">医治过程：</text>
            <text class="field-value">{{item.treatmentProcessDisplay}}</text>
          </view>
          <view class="record-field" wx:if="{{item.followUpPlanDisplay}}">
            <text class="field-label">后续治疗安排：</text>
            <text class="field-value">{{item.followUpPlanDisplay}}</text>
          </view>
        </view>
      </view>
    </view>

    <view class="operation-log-section" wx:if="{{operationLogs.length}}">
      <text class="section-title">操作日志</text>
      <view class="operation-log-item" wx:for="{{operationLogs}}" wx:key="index">
        <view class="log-header">
          <text class="log-time">{{item.timeText || ''}}</text>
          <text class="log-operator">{{item.operatorName || '未知操作人'}}</text>
        </view>
        <text class="log-message">{{item.message || '更新住户资料'}}</text>
      </view>
    </view>

    <view class="media-section">
      <text class="section-title">资料管理</text>
      <view wx:if="{{media.loading && !media.accessChecked}}" class="placeholder"
        >正在检查权限…</view
      >
      <view wx:elif="{{media.loading}}" class="placeholder">正在加载附件…</view>
      <view wx:elif="{{media.error}}" class="error">
        {{media.error}}
        <view class="media-retry" bindtap="onMediaRetry">重新加载</view>
      </view>
      <view wx:elif="{{media.accessChecked && !media.allowed}}" class="placeholder"
        >当前账号暂无权限查看附件。</view
      >
      <view wx:else>
        <view class="media-header">
          <view class="media-quota">
            <view class="quota-item">
              <view class="quota-header">
                <text class="quota-label">文件数量</text>
                <text class="quota-value"
                  >{{media.quota.totalCount}} / {{media.quota.maxCount}}</text
                >
              </view>
              <view class="quota-progress">
                <view
                  class="quota-progress-bar {{media.quota.countPercent >= 90 ? 'danger' : (media.quota.countPercent >= 70 ? 'warning' : 'success')}}"
                  style="width: {{media.quota.countPercent}}%"
                ></view>
              </view>
            </view>
            <view class="quota-item">
              <view class="quota-header">
                <text class="quota-label">存储容量</text>
                <text class="quota-value"
                  >{{media.quota.totalBytesText}} / {{media.quota.maxBytesText}}</text
                >
              </view>
              <view class="quota-progress">
                <view
                  class="quota-progress-bar {{media.quota.sizePercent >= 90 ? 'danger' : (media.quota.sizePercent >= 70 ? 'warning' : 'success')}}"
                  style="width: {{media.quota.sizePercent}}%"
                ></view>
              </view>
            </view>
          </view>
          <view class="media-tabs">
            <view
              class="media-tab-button {{media.tab === 'images' ? 'active' : ''}}"
              data-tab="images"
              bindtap="onMediaTabChange"
              >照片墙</view
            >
            <view
              class="media-tab-button {{media.tab === 'documents' ? 'active' : ''}}"
              data-tab="documents"
              bindtap="onMediaTabChange"
              >文档列表</view
            >
          </view>
        </view>

        <view wx:if="{{media.uploading}}" class="media-status">正在上传，请稍候…</view>

        <view class="media-actions">
          <view
            wx:if="{{media.tab === 'images'}}"
            class="media-action-button {{media.uploading ? 'disabled' : ''}}"
            bindtap="onUploadImagesTap"
            >上传图片</view
          >
          <view
            wx:elif="{{media.tab === 'documents'}}"
            class="media-action-button {{media.uploading ? 'disabled' : ''}}"
            bindtap="onUploadDocumentsTap"
            >上传文档</view
          >
        </view>

        <view wx:if="{{media.tab === 'images'}}">
          <view class="media-upload-hint">单次最多 5 个，支持 JPG/PNG/WebP，单个文件 ≤ 10MB。</view>
          <view wx:if="{{media.images.length}}" class="media-grid">
            <view class="media-card-item" wx:for="{{media.images}}" wx:key="id">
              <pm-card
                variant="outlined"
                clickable="{{true}}"
                padding="0"
                use-slot="{{true}}"
                use-header-slot="{{true}}"
                use-footer-slot="{{true}}"
                class="media-card__card"
                bind:tap="onImagePreviewTap"
                data-index="{{index}}"
              >
                <view slot="header" class="media-card__image">
                  <image src="{{item.thumbnailUrl}}" mode="aspectFill"></image>
                </view>
                <view class="media-card__content">
                  <text class="media-card__name">{{item.displayName}}</text>
                  <text class="media-card__meta">{{item.sizeText}} · {{item.uploadedAtText}}</text>
                  <text class="media-card__meta">上传人：{{item.uploaderDisplay}}</text>
                </view>
                <view slot="footer" class="media-card__footer">
                  <view
                    class="media-card__button {{item.downloading ? 'loading' : ''}}"
                    data-id="{{item.id}}"
                    data-index="{{index}}"
                    catchtap="onImageDownloadTap"
                  >
                    {{item.downloading ? '下载中…' : '下载'}}
                  </view>
                  <view
                    class="media-card__button danger {{item.deleting ? 'loading' : ''}}"
                    data-id="{{item.id}}"
                    data-index="{{index}}"
                    data-category="image"
                    catchtap="onDeleteMediaTap"
                  >
                    {{item.deleting ? '处理中…' : '删除'}}
                  </view>
                </view>
              </pm-card>
            </view>
          </view>
          <view wx:if="{{!media.images.length}}" class="placeholder">暂无图片资料</view>
        </view>

        <view wx:elif="{{media.tab === 'documents'}}">
          <view class="media-upload-hint"
            >支持 TXT / PDF / Word / Excel，单次最多 5 个，单个文件 ≤ 10MB。</view
          >
          <view wx:if="{{media.documents.length}}" class="media-table">
            <view class="media-table-header">
              <view class="media-cell name">文件名</view>
              <view class="media-cell type">类型</view>
              <view class="media-cell size">大小</view>
              <view class="media-cell time">上传时间</view>
              <view class="media-cell uploader">上传人</view>
              <view class="media-cell actions">操作</view>
            </view>
            <view class="media-table-row" wx:for="{{media.documents}}" wx:key="id">
              <view class="media-cell name">
                <text
                  class="doc-name {{item.isText ? 'interactive' : 'disabled'}}"
                  data-id="{{item.id}}"
                  data-index="{{index}}"
                  bindtap="onDocumentNameTap"
                >
                  {{item.displayName}}
                </text>
                <text wx:if="{{item.isText}}" class="doc-preview-hint"
                  >{{item.previewLoading ? '预览中…' : '支持在线预览'}}</text
                >
              </view>
              <view class="media-cell type">{{item.typeText}}</view>
              <view class="media-cell size">{{item.sizeText}}</view>
              <view class="media-cell time">{{item.uploadedAtText}}</view>
              <view class="media-cell uploader">{{item.uploaderDisplay}}</view>
              <view class="media-cell actions">
                <view
                  class="doc-action-button {{item.downloading ? 'loading' : ''}}"
                  data-id="{{item.id}}"
                  data-index="{{index}}"
                  catchtap="onDocumentDownloadTap"
                >
                  {{item.downloading ? '下载中…' : '下载'}}
                </view>
                <view
                  class="doc-action-button danger {{item.deleting ? 'loading' : ''}}"
                  data-id="{{item.id}}"
                  data-index="{{index}}"
                  data-category="document"
                  catchtap="onDeleteMediaTap"
                >
                  {{item.deleting ? '处理中…' : '删除'}}
                </view>
              </view>
            </view>
          </view>
          <view wx:if="{{!media.documents.length}}" class="placeholder">暂无文档资料</view>
        </view>
      </view>
    </view>
  </scroll-view>

  <view wx:if="{{textPreview.visible}}" class="text-preview-mask" catchtouchmove="noop">
    <view class="text-preview-dialog">
      <view class="text-preview-header">
        <text class="text-preview-title">{{textPreview.title}}</text>
        <view class="text-preview-close" bindtap="onTextPreviewClose">关闭</view>
      </view>
      <scroll-view scroll-y enable-flex class="text-preview-content">
        <text>{{textPreview.content}}</text>
      </scroll-view>
    </view>
  </view>
</view>
