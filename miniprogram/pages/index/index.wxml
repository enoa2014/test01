<view class="container">
  <view class="hero">
    <text class="title">患者档案</text>
    <text class="subtitle">汇总每位患者的住院记录</text>
  </view>

  <view class="toolbar">
    <view class="search-box">
      <icon type="search" size="16" color="#9ca3af" />
      <input
        class="search-input"
        placeholder="搜索姓名、诊断或医院"
        placeholder-class="search-placeholder"
        confirm-type="search"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <view wx:if="{{searchKeyword}}" class="search-clear" bindtap="onSearchClear">清除</view>
    </view>
    <picker
      class="sort-picker-wrapper"
      mode="selector"
      range="{{sortOptions}}"
      range-key="label"
      value="{{sortIndex}}"
      bindchange="onSortChange"
    >
      <view class="sort-picker">
        <text class="sort-text">{{sortOptions[sortIndex].label}}</text>
        <text class="sort-icon">▾</text>
      </view>
    </picker>
    <view class="action-row">
      <view class="analysis-link" bindtap="onAnalysisTap">查看分析</view>
      <view class="intake-link" bindtap="onIntakeTap">患者入住</view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="placeholder">正在加载患者列表…</view>
  <view wx:elif="{{error}}" class="error">{{error}}</view>
  <scroll-view wx:else scroll-y class="patient-list">
    <view
      class="patient-item"
      wx:for="{{displayPatients}}"
      wx:key="key"
      data-key="{{item.key}}"
      data-patient-key="{{item.patientKey || item.key}}"
      data-record-key="{{item.key}}"
      bindtap="onPatientTap"
    >
      <view class="patient-header">
        <text class="patient-name">{{item.patientName || '-'}}</text>
        <text class="patient-count">共入住 {{item.admissionCount || 0}} 次</text>
      </view>

      <view class="quick-info">
        <view class="quick-item">
          <text class="quick-label">性别</text>
          <text class="quick-value">{{item.gender || '未知'}}</text>
        </view>
        <view class="quick-item">
          <text class="quick-label">年龄</text>
          <text class="quick-value">{{item.ageText || '-'}}</text>
        </view>
        <view class="quick-item" wx:if="{{item.latestAdmissionDateFormatted}}">
          <text class="quick-label">最近入住</text>
          <text class="quick-value">{{item.latestAdmissionDateFormatted}}</text>
        </view>
      </view>

      <view class="patient-meta">
        <view class="meta-row">
          <text class="meta-label">首次诊断</text>
          <text class="meta-value">{{item.firstDiagnosis || '-'}}</text>
        </view>
      </view>
    </view>
    <view wx:if="{{!displayPatients.length}}" class="placeholder">未找到匹配的患者</view>
  </scroll-view>
</view>

