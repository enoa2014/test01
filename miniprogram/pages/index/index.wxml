<view class="theme-root container stack gap-4">
  <view class="hero">
    <text class="title">患者档案</text>
    <text class="hero-subtitle">汇总每位患者的住院记录</text>
  </view>

  <view class="toolbar">
    <view class="search-box">
      <text class="search-icon">🔍</text>
      <input
        class="search-input"
        placeholder="搜索姓名、诊断或医院"
        placeholder-class="search-placeholder"
        confirm-type="search"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <view wx:if="{{searchKeyword}}" class="search-clear" bindtap="onSearchClear">清除</view>
    </view>
    <picker
      class="sort-picker-wrapper"
      mode="selector"
      range="{{sortOptions}}"
      range-key="label"
      value="{{sortIndex}}"
      bindchange="onSortChange"
    >
      <view class="sort-picker">
        <text class="sort-text">{{sortOptions[sortIndex].label}}</text>
        <text class="sort-icon">▾</text>
      </view>
    </picker>
    <view class="action-row">
      <pm-button
        class="action-button"
        text="查看分析"
        size="small"
        type="primary"
        ghost="{{true}}"
        bindtap="onAnalysisTap"
      />
      <pm-button
        class="action-button"
        text="患者入住"
        size="small"
        type="primary"
        bindtap="onIntakeTap"
      />
    </view>
  </view>

  <view wx:if="{{loading}}" class="skeleton-list">
    <view class="skeleton-item" wx:for="{{skeletonPlaceholders}}" wx:key="*this">
      <view class="skeleton-avatar"></view>
      <view class="skeleton-body">
        <view class="skeleton-line skeleton-line--title"></view>
        <view class="skeleton-badges">
          <view class="skeleton-badge" wx:for="{{[0,1]}}" wx:key="*this"></view>
        </view>
        <view class="skeleton-grid">
          <view class="skeleton-chip" wx:for="{{[0,1,2]}}" wx:key="*this"></view>
        </view>
        <view class="skeleton-line"></view>
      </view>
    </view>
  </view>
  <view wx:elif="{{error}}" class="error">{{error}}</view>
  <pm-card
    wx:if="{{!loading && !error && !displayPatients.length}}"
    class="empty-state-card"
    title="暂无患者档案"
    useFooterSlot="{{true}}"
  >
    <view class="empty-state">
      <image class="empty-illustration" src="../../assets/images/empty-patients.svg" mode="aspectFit" />
      <text class="empty-description">点击右下角按钮添加第一位患者</text>
    </view>
    <view slot="footer" class="empty-actions">
      <pm-button text="立即添加" type="primary" size="medium" bindtap="onIntakeTap" />
    </view>
  </pm-card>
  <scroll-view wx:else scroll-y class="patient-list">
    <pm-card
      wx:for="{{displayPatients}}"
      wx:key="patientKey"
      class="patient-card"
      clickable="{{true}}"
      padding="var(--space-4)"
      status="{{item.cardStatus}}"
      useSlot="{{true}}"
      useHeaderSlot="{{true}}"
      data-key="{{item.key}}"
      data-patient-key="{{item.patientKey || item.key}}"
      data-record-key="{{item.key}}"
      bind:tap="onPatientTap"
    >
      <view slot="header" class="patient-header">
        <text class="patient-name">{{item.patientName || '-'}}</text>
        <pm-badge
          wx:if="{{item.admissionBadge}}"
          class="patient-count-badge"
          text="{{item.admissionBadge}}"
          type="{{item.badgeType}}"
          size="small"
        />
      </view>

      <view class="patient-card-body">
        <view class="quick-info">
          <view class="quick-item">
            <text class="quick-label">性别</text>
            <text class="quick-value">{{item.gender || '未知'}}</text>
          </view>
          <view class="quick-item">
            <text class="quick-label">年龄</text>
            <text class="quick-value">{{item.ageText || '-'}}</text>
          </view>
          <view class="quick-item" wx:if="{{item.latestAdmissionDateFormatted}}">
            <text class="quick-label">最近入住</text>
            <text class="quick-value">{{item.latestAdmissionDateFormatted}}</text>
          </view>
        </view>

        <view class="patient-meta">
          <view class="meta-row">
            <text class="meta-label">首次诊断</text>
            <text class="meta-value">{{item.firstDiagnosis || '-'}}</text>
          </view>
        </view>
      </view>
    </pm-card>
  </scroll-view>
  <view class="fab-container">
    <pm-button
      class="fab-button"
      type="primary"
      size="large"
      icon="＋"
      icon-only="{{true}}"
      elevated="{{true}}"
      aria-label="添加患者"
      bindtap="onIntakeTap"
    />
  </view>
</view>
