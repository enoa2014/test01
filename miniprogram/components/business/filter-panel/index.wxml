<view wx:if="{{visible}}" class="filter-panel-backdrop" catchtouchmove="noop" bindtap="onMaskTap"></view>
<view wx:if="{{visible}}" class="filter-panel-drawer" catchtouchmove="noop" catchtap="noop">
  <view class="filter-panel__header">
    <view class="filter-panel__title">高级筛选</view>
    <view class="filter-panel__subtitle">组合条件快速锁定目标住户</view>
    <view class="filter-panel__close" bindtap="handleCloseTap">×</view>
  </view>

  <scroll-view scroll-y class="filter-panel__body">
    <view wx:if="{{schemes.length}}" class="filter-section filter-section--schemes">
      <view class="filter-section__title">已保存方案</view>
      <view class="filter-schemes">
        <view
          wx:for="{{schemes}}"
          wx:key="id"
          class="filter-schemes__item"
        >
          <view class="filter-schemes__info">
            <text class="filter-schemes__name">{{item.name}}</text>
            <text class="filter-schemes__summary">{{item.summary}}</text>
          </view>
          <view class="filter-schemes__actions">
            <pm-button
              size="small"
              type="ghost"
              text="重命名"
              data-id="{{item.id}}"
              bindtap="onRenameSchemeTap"
            />
            <pm-button
              size="small"
              type="ghost"
              text="应用"
              data-id="{{item.id}}"
              bindtap="onApplySchemeTap"
            />
            <pm-button
              size="small"
              type="default"
              text="删除"
              data-id="{{item.id}}"
              ghost="{{true}}"
              bindtap="onDeleteSchemeTap"
            />
          </view>
        </view>
      </view>
    </view>

    <view class="filter-section filter-section--logic">
      <view class="filter-section__title">条件关系</view>
      <view class="filter-chips">
        <view
          class="filter-chip filter-chip--ghost {{logicMode === 'AND' ? 'filter-chip--active' : ''}}"
          data-mode="AND"
          bindtap="onLogicModeToggle"
        >
          满足全部
        </view>
        <view
          class="filter-chip filter-chip--ghost {{logicMode === 'OR' ? 'filter-chip--active' : ''}}"
          data-mode="OR"
          bindtap="onLogicModeToggle"
        >
          满足任一
        </view>
      </view>
      <text class="filter-panel__logic-tip">AND 表示必须同时满足，OR 表示任意条件即可</text>
    </view>

    <view class="filter-section">
      <view class="filter-section__title">住户状态</view>
      <view class="filter-chips">
        <view
          wx:for="{{statusOptions}}"
          wx:key="id"
          class="filter-chip {{item.active ? 'filter-chip--active' : ''}}"
          data-id="{{item.id}}"
          bindtap="onStatusToggle"
        >
          {{item.label}}
        </view>
      </view>
    </view>

    <view class="filter-section">
      <view class="filter-section__title">入住时间范围</view>
      <view class="filter-dates">
        <picker mode="date" value="{{dateRange.start}}" bindchange="onStartDateChange">
          <view class="filter-date__item">
            <text class="filter-date__label">开始日期</text>
            <text class="filter-date__value">{{dateRange.start || '请选择'}}</text>
          </view>
        </picker>
        <view class="filter-date__divider">—</view>
        <picker mode="date" value="{{dateRange.end}}" bindchange="onEndDateChange">
          <view class="filter-date__item">
            <text class="filter-date__label">结束日期</text>
            <text class="filter-date__value">{{dateRange.end || '请选择'}}</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="filter-section">
      <view class="filter-section__title">风险等级</view>
      <view class="filter-chips">
        <view
          wx:for="{{riskOptions}}"
          wx:key="id"
          class="filter-chip {{item.active ? 'filter-chip--active' : ''}}"
          data-id="{{item.id}}"
          bindtap="onRiskToggle"
        >
          {{item.label}}
        </view>
      </view>
    </view>

    <view class="filter-section">
      <view class="filter-section__title">诊断类型</view>
      <view class="filter-diagnosis">
        <pm-input
          value="{{searchTerm}}"
          placeholder="搜索诊断关键字"
          clearable="{{true}}"
          bind:input="onDiagnosisInput"
        />
        <view wx:if="{{availableDiagnosis.length}}" class="filter-diagnosis__suggestions">
          <view class="filter-diagnosis__label">常用诊断</view>
          <view class="filter-chips">
            <view
              wx:for="{{availableDiagnosis}}"
              wx:key="id"
              class="filter-chip filter-chip--ghost"
              data-id="{{item.id}}"
              data-label="{{item.label}}"
              bindtap="onDiagnosisSelect"
            >
              {{item.label}}
            </view>
          </view>
        </view>
        <view wx:if="{{selectedDiagnosis.length}}" class="filter-diagnosis__selected">
          <view class="filter-diagnosis__label">已选诊断</view>
          <view class="filter-tags">
            <view
              wx:for="{{selectedDiagnosis}}"
              wx:key="id"
              class="filter-tag"
            >
              <text class="filter-tag__text">{{item.label}}</text>
              <view class="filter-tag__remove" data-id="{{item.id}}" bindtap="onDiagnosisTagRemove">×</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="filter-section">
      <view class="filter-section__title">医院筛选</view>
      <view class="filter-grid">
        <view
          wx:for="{{hospitalList}}"
          wx:key="id"
          class="filter-grid__item {{item.active ? 'filter-grid__item--active' : ''}}"
          data-id="{{item.id}}"
          bindtap="onHospitalToggle"
        >
          {{item.label}}
        </view>
      </view>
    </view>
  </scroll-view>

  <view class="filter-panel__footer">
    <view class="filter-panel__preview">
      <text class="filter-panel__preview-count">
        {{previewLoading ? '计算中…' : (previewCount >= 0 ? previewCount : '--')}}
      </text>
      <text class="filter-panel__preview-label">{{previewLabel}}</text>
    </view>
    <pm-button class="filter-panel__btn" type="default" text="保存方案" bindtap="onSaveSchemeTap" />
    <pm-button class="filter-panel__btn" type="ghost" text="重置" bindtap="onReset" />
    <pm-button class="filter-panel__btn" type="primary" text="应用筛选" bindtap="onApply" />
  </view>
</view>
