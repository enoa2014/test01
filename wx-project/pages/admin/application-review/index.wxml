<!-- pages/admin/application-review/index.wxml -->
<view class="admin-review">
  <!-- éª¨æ¶å± -->
  <skeleton-screen show="{{showSkeleton}}" type="page,stats,search,filters,list" rows="5"></skeleton-screen>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header" wx:if="{{!showSkeleton}}">
    <view class="header-content">
      <text class="header-title">ç”³è¯·å®¡æ ¸</text>
      <text class="header-subtitle">å®¡æ ¸ç”¨æˆ·çš„è§’è‰²ç”³è¯·</text>
    </view>
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{stats.pendingCount}}</text>
        <text class="stat-label">å¾…å®¡æ ¸</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.todayCount}}</text>
        <text class="stat-label">ä»Šæ—¥æ–°å¢</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.totalCount}}</text>
        <text class="stat-label">æ€»ç”³è¯·æ•°</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view
        class="filter-tab {{activeTab === 'all' ? 'filter-tab--active' : ''}}"
        bindtap="switchTab"
        data-tab="all"
      >
        å…¨éƒ¨ç”³è¯·
      </view>
      <view
        class="filter-tab {{activeTab === 'pending' ? 'filter-tab--active' : ''}}"
        bindtap="switchTab"
        data-tab="pending"
      >
        å¾…å®¡æ ¸
      </view>
      <view
        class="filter-tab {{activeTab === 'approved' ? 'filter-tab--active' : ''}}"
        bindtap="switchTab"
        data-tab="approved"
      >
        å·²é€šè¿‡
      </view>
      <view
        class="filter-tab {{activeTab === 'rejected' ? 'filter-tab--active' : ''}}"
        bindtap="switchTab"
        data-tab="rejected"
      >
        å·²æ‹’ç»
      </view>
    </view>

    <!-- æœç´¢æ  -->
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢ç”³è¯·äººã€æ‰‹æœºå·æˆ–é‚®ç®±"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">Ã—</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">è§’è‰²</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{roleOptions}}"
          range-key="label"
          value="{{selectedRoleIndex}}"
          bindchange="onRoleChange"
        >
          <view class="picker-display">
            {{roleOptions[selectedRoleIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ—¶é—´</text>
        <picker
          class="filter-picker"
          mode="date"
          value="{{selectedDate}}"
          bindchange="onDateChange"
        >
          <view class="picker-display">
            {{selectedDate || 'å…¨éƒ¨æ—¶é—´'}}
          </view>
        </picker>
      </view>
    </view>

    <!-- æ‰¹é‡æ“ä½œ -->
    <view class="batch-actions" wx:if="{{activeTab === 'pending' && applications.length > 0}}">
      <button class="batch-btn batch-btn--approve" bindtap="batchApprove">
        æ‰¹é‡é€šè¿‡
      </button>
      <button class="batch-btn batch-btn--reject" bindtap="batchReject">
        æ‰¹é‡æ‹’ç»
      </button>
    </view>
  </view>

  <view class="application-list" wx:if="{{applications.length > 0}}">
    <!-- ç”³è¯·åˆ—è¡¨ -->
    <view
      class="application-item"
      wx:for="{{applications}}"
      wx:key="id"
      bindtap="viewApplicationDetail"
      data-id="{{item.id}}"
    >
      <view class="item-header">
        <view class="applicant-info">
          <view class="applicant-avatar">
            <image
              class="avatar-image"
              src="{{item.avatar || '/assets/default-avatar.png'}}"
              mode="aspectFill"
            ></image>
          </view>
          <view class="applicant-details">
            <text class="applicant-name">{{item.displayName}}</text>
            <text class="applicant-contact">{{item.phone || item.email}}</text>
            <text class="apply-time">{{item.createTime}}</text>
          </view>
        </view>
        <view class="application-status">
          <view class="status-badge status-badge--{{item.state}}">
            {{item.statusText}}
          </view>
        </view>
      </view>

      <view class="item-content">
        <view class="role-info">
          <text class="role-label">ç”³è¯·è§’è‰²ï¼š</text>
          <role-badge role="{{item.role}}" size="small"></role-badge>
        </view>

        <view class="reason-preview" wx:if="{{item.reason}}">
          <text class="reason-label">ç”³è¯·ç†ç”±ï¼š</text>
          <text class="reason-text">{{item.reason}}</text>
        </view>

        <view class="attachment-preview" wx:if="{{item.attachments.length > 0}}">
          <text class="attachment-label">é™„ä»¶ï¼š</text>
          <text class="attachment-count">{{item.attachments.length}}ä¸ªæ–‡ä»¶</text>
        </view>

        <view class="review-info" wx:if="{{item.reviewedAt}}">
          <text class="review-label">å®¡æ ¸æ—¶é—´ï¼š</text>
          <text class="review-time">{{item.reviewedAt}}</text>
          <text class="reviewer">å®¡æ ¸äººï¼š{{item.reviewerName || 'ç®¡ç†å‘˜'}}</text>
        </view>
      </view>

      <view class="item-actions" wx:if="{{item.state === 'pending'}}">
        <button
          class="action-btn action-btn--approve"
          bindtap="approveApplication"
          data-id="{{item.id}}"
          catchtap="true"
        >
          é€šè¿‡
        </button>
        <button
          class="action-btn action-btn--reject"
          bindtap="rejectApplication"
          data-id="{{item.id}}"
          catchtap="true"
        >
          æ‹’ç»
        </button>
        <button
          class="action-btn action-btn--detail"
          bindtap="viewApplicationDetail"
          data-id="{{item.id}}"
          catchtap="true"
        >
          è¯¦æƒ…
        </button>
      </view>
    </view>
  </view>
  <view class="empty-state" wx:else>
    <!-- ç©ºçŠ¶æ€ -->
    <text class="empty-icon">ğŸ“‹</text>
    <text class="empty-text">æš‚æ— {{activeTab === 'all' ? 'ç”³è¯·' : activeTab === 'pending' ? 'å¾…å®¡æ ¸' : activeTab === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»'}}çš„ç”³è¯·</text>
    <text class="empty-desc">{{emptyDesc}}</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨ç»Ÿè®¡ -->
  <view class="bottom-stats" wx:if="{{applications.length > 0}}">
    <text class="stats-text">å…± {{total}} æ¡ç”³è¯·</text>
    <view class="stats-divider">|</view>
    <text class="stats-text">{{currentPage}}/{{totalPages}} é¡µ</text>
  </view>

  <!-- ç”³è¯·è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{selectedApplication}}">
        <!-- ç”³è¯·äººä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">ç”³è¯·äººä¿¡æ¯</text>
          <view class="applicant-detail">
            <image
              class="detail-avatar"
              src="{{selectedApplication.avatar || '/assets/default-avatar.png'}}"
              mode="aspectFill"
            ></image>
            <view class="detail-info">
              <text class="detail-name">{{selectedApplication.displayName}}</text>
              <text class="detail-contact">{{selectedApplication.phone}}</text>
              <text class="detail-contact">{{selectedApplication.email}}</text>
              <text class="detail-time">ç”³è¯·æ—¶é—´ï¼š{{selectedApplication.createTime}}</text>
            </view>
          </view>
        </view>

        <!-- ç”³è¯·è§’è‰² -->
        <view class="detail-section">
          <text class="section-title">ç”³è¯·è§’è‰²</text>
          <view class="role-detail">
            <role-badge role="{{selectedApplication.role}}"></role-badge>
            <text class="role-desc">{{getRoleDescription(selectedApplication.role)}}</text>
          </view>
        </view>

        <!-- ç”³è¯·ç†ç”± -->
        <view class="detail-section" wx:if="{{selectedApplication.reason}}">
          <text class="section-title">ç”³è¯·ç†ç”±</text>
          <text class="reason-detail">{{selectedApplication.reason}}</text>
        </view>

        <!-- é™„ä»¶ -->
        <view class="detail-section" wx:if="{{selectedApplication.attachments.length > 0}}">
          <text class="section-title">é™„ä»¶ææ–™</text>
          <view class="attachments-detail">
            <view
              class="attachment-item"
              wx:for="{{selectedApplication.attachments}}"
              wx:key="index"
              wx:for-item="attachment"
            >
              <text class="attachment-icon">ğŸ“„</text>
              <text class="attachment-name">{{attachment.name}}</text>
              <text class="attachment-size">{{attachment.size}}</text>
            </view>
          </view>
        </view>

        <!-- å®¡æ ¸çŠ¶æ€ -->
        <view class="detail-section" wx:if="{{selectedApplication.reviewedAt}}">
          <text class="section-title">å®¡æ ¸çŠ¶æ€</text>
          <view class="review-detail">
            <view class="review-status status-badge--{{selectedApplication.state}}">
              {{selectedApplication.statusText}}
            </view>
            <text class="reviewer-info">å®¡æ ¸äººï¼š{{selectedApplication.reviewerName || 'ç®¡ç†å‘˜'}}</text>
            <text class="review-time-info">å®¡æ ¸æ—¶é—´ï¼š{{selectedApplication.reviewedAt}}</text>
            <text class="review-reason" wx:if="{{selectedApplication.reviewReason}}">
              å®¡æ ¸ç†ç”±ï¼š{{selectedApplication.reviewReason}}
            </text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--approve"
          wx:if="{{selectedApplication.state === 'pending'}}"
          bindtap="approveApplication"
          data-id="{{selectedApplication.id}}"
        >
          é€šè¿‡ç”³è¯·
        </button>
        <button
          class="modal-btn modal-btn--reject"
          wx:if="{{selectedApplication.state === 'pending'}}"
          bindtap="rejectApplication"
          data-id="{{selectedApplication.id}}"
        >
          æ‹’ç»ç”³è¯·
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>

  <!-- å®¡æ ¸ç†ç”±å¼¹çª— -->
  <view class="reason-modal" wx:if="{{showReasonModal}}">
    <view class="modal-mask" bindtap="closeReasonModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{reasonModalTitle}}</text>
        <text class="modal-close" bindtap="closeReasonModal">Ã—</text>
      </view>

      <view class="modal-body">
        <textarea
          class="reason-input"
          placeholder="è¯·è¾“å…¥å®¡æ ¸ç†ç”±..."
          value="{{reviewReason}}"
          bindinput="onReasonInput"
          maxlength="200"
          auto-height
        ></textarea>
        <text class="input-counter">{{reviewReason.length}}/200</text>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--confirm"
          bindtap="confirmReview"
          disabled="{{!reviewReason.trim()}}"
        >
          ç¡®è®¤{{reasonModalType === 'approve' ? 'é€šè¿‡' : 'æ‹’ç»'}}
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeReasonModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>
</view>
