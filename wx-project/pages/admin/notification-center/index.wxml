<!-- pages/admin/notification-center/index.wxml -->
<view class="notification-center">
  <!-- éª¨æ¶å± -->
  <skeleton-screen show="{{showSkeleton}}" type="page,stats,search,filters,list" rows="5"></skeleton-screen>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <text class="header-title">æ¶ˆæ¯é€šçŸ¥ä¸­å¿ƒ</text>
      <text class="header-subtitle">ç®¡ç†å’Œå‘é€ç³»ç»Ÿé€šçŸ¥</text>
    </view>
    <view class="header-actions">
      <button class="create-btn" bindtap="showCreateModal">
        <text class="btn-icon">ğŸ“¢</text>
        <text class="btn-text">å‘é€é€šçŸ¥</text>
      </button>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <text class="stat-number">{{stats.totalNotifications}}</text>
        <text class="stat-label">æ€»é€šçŸ¥æ•°</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.unreadCount}}</text>
        <text class="stat-label">æœªè¯»é€šçŸ¥</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.todaySent}}</text>
        <text class="stat-label">ä»Šæ—¥å‘é€</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.systemNotifications}}</text>
        <text class="stat-label">ç³»ç»Ÿé€šçŸ¥</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæœç´¢ -->
  <view class="filter-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢é€šçŸ¥æ ‡é¢˜æˆ–å†…å®¹"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">Ã—</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">ç±»å‹</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{typeOptions}}"
          range-key="label"
          value="{{selectedTypeIndex}}"
          bindchange="onTypeChange"
        >
          <view class="picker-display">
            {{typeOptions[selectedTypeIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">çŠ¶æ€</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{statusOptions}}"
          range-key="label"
          value="{{selectedStatusIndex}}"
          bindchange="onStatusChange"
        >
          <view class="picker-display">
            {{statusOptions[selectedStatusIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ—¶é—´èŒƒå›´</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{timeRangeOptions}}"
          range-key="label"
          value="{{selectedTimeRangeIndex}}"
          bindchange="onTimeRangeChange"
        >
          <view class="picker-display">
            {{timeRangeOptions[selectedTimeRangeIndex].label}}
          </view>
        </picker>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <button class="action-btn action-btn--batch" bindtap="showBatchSendModal">
        æ‰¹é‡å‘é€
      </button>
      <button class="action-btn action-btn--template" bindtap="showTemplateModal">
        é€šçŸ¥æ¨¡æ¿
      </button>
      <button class="action-btn action-btn--export" bindtap="exportNotifications">
        å¯¼å‡ºæ•°æ®
      </button>
    </view>
  </view>

  <!-- é€šçŸ¥åˆ—è¡¨ -->
  <view class="notification-list" wx:if="{{notifications.length > 0}}">
    <view
      class="notification-item"
      wx:for="{{notifications}}"
      wx:key="id"
      bindtap="viewNotificationDetail"
      data-id="{{item.id}}"
    >
      <view class="item-header">
        <view class="notification-info">
          <view class="notification-title">
            <text class="title-text">{{item.title}}</text>
            <view class="notification-type">
              <view class="type-badge type-badge--{{item.type}}">
                {{item.typeText}}
              </view>
            </view>
          </view>
          <view class="notification-meta">
            <text class="sender-info">å‘é€è€…ï¼š{{item.senderName}}</text>
            <text class="send-time">{{item.sendTime}}</text>
          </view>
        </view>
        <view class="notification-status">
          <view class="status-badge status-badge--{{item.status}}">
            {{item.statusText}}
          </view>
        </view>
      </view>

      <view class="item-content">
        <view class="content-preview">
          <text class="preview-text">{{item.contentPreview}}</text>
          <text class="preview-hint" wx:if="{{item.contentLength > 100}}">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹</text>
        </view>

        <view class="target-info" wx:if="{{item.targetInfo}}">
          <text class="target-label">å‘é€å¯¹è±¡ï¼š</text>
          <text class="target-text">{{item.targetInfo}}</text>
        </view>

        <view class="stats-info">
          <view class="stat-item">
            <text class="stat-label">ç›®æ ‡ç”¨æˆ·ï¼š</text>
            <text class="stat-value">{{item.targetCount}}äºº</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">å·²è¯»ï¼š</text>
            <text class="stat-value">{{item.readCount}}äºº</text>
          </view>
          <view class="stat-item" wx:if="{{item.clickCount}}">
            <text class="stat-label">ç‚¹å‡»ï¼š</text>
            <text class="stat-value">{{item.clickCount}}äºº</text>
          </view>
        </view>
      </view>

      <view class="item-actions">
        <button
          class="action-btn action-btn--view"
          bindtap="viewNotificationDetail"
          data-id="{{item.id}}"
          catchtap="true"
        >
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button
          class="action-btn action-btn--resend"
          bindtap="resendNotification"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.status === 'sent' && item.readCount < item.targetCount}}"
        >
          é‡æ–°å‘é€
        </button>
        <button
          class="action-btn action-btn--recall"
          bindtap="recallNotification"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.status === 'sent'}}"
        >
          æ’¤å›
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ“¬</text>
    <text class="empty-text">æš‚æ— é€šçŸ¥</text>
    <text class="empty-desc">ç‚¹å‡»ä¸Šæ–¹"å‘é€é€šçŸ¥"æŒ‰é’®å¼€å§‹åˆ›å»º</text>
    <button class="create-empty-btn" bindtap="showCreateModal">
      å‘é€ç¬¬ä¸€ä¸ªé€šçŸ¥
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨åˆ†é¡µ -->
  <view class="bottom-pagination" wx:if="{{notifications.length > 0}}">
    <text class="pagination-info">å…± {{total}} ä¸ªé€šçŸ¥</text>
    <view class="pagination-controls">
      <button
        class="page-btn {{currentPage <= 1 ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage <= 1}}"
        bindtap="prevPage"
      >
        ä¸Šä¸€é¡µ
      </button>
      <text class="page-info">{{currentPage}}/{{totalPages}}</text>
      <button
        class="page-btn {{currentPage >= totalPages ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage >= totalPages}}"
        bindtap="nextPage"
      >
        ä¸‹ä¸€é¡µ
      </button>
    </view>
  </view>

  <!-- å‘é€é€šçŸ¥å¼¹çª— -->
  <view class="create-modal" wx:if="{{showCreateModal}}">
    <view class="modal-mask" bindtap="closeCreateModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å‘é€é€šçŸ¥</text>
        <text class="modal-close" bindtap="closeCreateModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="form-item">
            <text class="form-label">é€šçŸ¥ç±»å‹ *</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{notificationTypes}}"
              range-key="label"
              value="{{formTypeIndex}}"
              bindchange="onFormTypeChange"
            >
              <view class="picker-display">
                {{notificationTypes[formTypeIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">é€šçŸ¥æ ‡é¢˜ *</text>
            <input
              class="form-input"
              type="text"
              placeholder="è¯·è¾“å…¥é€šçŸ¥æ ‡é¢˜"
              value="{{formTitle}}"
              bindinput="onFormTitleInput"
              maxlength="100"
            />
            <text class="input-counter">{{formTitle.length}}/100</text>
          </view>

          <view class="form-item">
            <text class="form-label">é€šçŸ¥å†…å®¹ *</text>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹"
              value="{{formContent}}"
              bindinput="onFormContentInput"
              maxlength="500"
              auto-height
            ></textarea>
            <text class="input-counter">{{formContent.length}}/500</text>
          </view>
        </view>

        <view class="form-section">
          <text class="section-title">å‘é€è®¾ç½®</text>
          <view class="form-item">
            <text class="form-label">å‘é€å¯¹è±¡ *</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{targetOptions}}"
              range-key="label"
              value="{{formTargetIndex}}"
              bindchange="onFormTargetChange"
            >
              <view class="picker-display">
                {{targetOptions[formTargetIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item" wx:if="{{formTargetIndex === 2}}">
            <text class="form-label">é€‰æ‹©è§’è‰²</text>
            <checkbox-group bindchange="onRoleChange">
              <label class="checkbox-item" wx:for="{{roleOptions}}" wx:key="value">
                <checkbox value="{{item.value}}" checked="{{formSelectedRoles.indexOf(item.value) > -1}}"/>
                <text class="checkbox-text">{{item.label}}</text>
              </label>
            </checkbox-group>
          </view>

          <view class="form-item">
            <checkbox-group bindchange="onImmediateChange">
              <label class="checkbox-item">
                <checkbox value="immediate" checked="{{formImmediate}}"/>
                <text class="checkbox-text">ç«‹å³å‘é€</text>
              </label>
              <label class="checkbox-item">
                <checkbox value="scheduled" checked="{{formScheduled}}"/>
                <text class="checkbox-text">å®šæ—¶å‘é€</text>
              </label>
            </checkbox-group>
          </view>

          <view class="form-item" wx:if="{{formScheduled}}">
            <text class="form-label">å‘é€æ—¶é—´</text>
            <picker
              class="form-picker"
              mode="date"
              value="{{formSendDate}}"
              bindchange="onFormSendDateChange"
            >
              <view class="picker-display">
                {{formSendDate || 'è¯·é€‰æ‹©å‘é€æ—¥æœŸ'}}
              </view>
            </picker>
          </view>
        </view>

        <view class="form-section">
          <text class="section-title">é«˜çº§è®¾ç½®</text>
          <view class="form-item">
            <checkbox-group bindchange="onAdvancedChange">
              <label class="checkbox-item">
                <checkbox value="requireRead" checked="{{formRequireRead}}"/>
                <text class="checkbox-text">è¦æ±‚å·²è¯»ç¡®è®¤</text>
              </label>
              <label class="checkbox-item">
                <checkbox value="allowPush" checked="{{formAllowPush}}"/>
                <text class="checkbox-text">å…è®¸æ¨é€é€šçŸ¥</text>
              </label>
              <label class="checkbox-item">
                <checkbox value="saveTemplate" checked="{{formSaveTemplate}}"/>
                <text class="checkbox-text">ä¿å­˜ä¸ºæ¨¡æ¿</text>
              </label>
            </checkbox-group>
          </view>

          <view class="form-item" wx:if="{{formSaveTemplate}}">
            <text class="form-label">æ¨¡æ¿åç§°</text>
            <input
              class="form-input"
              type="text"
              placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°"
              value="{{formTemplateName}}"
              bindinput="onFormTemplateNameInput"
            />
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--send"
          bindtap="confirmSendNotification"
          disabled="{{!isFormValid}}"
        >
          å‘é€é€šçŸ¥
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeCreateModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡å‘é€å¼¹çª— -->
  <view class="batch-modal" wx:if="{{showBatchModal}}">
    <view class="modal-mask" bindtap="closeBatchModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">æ‰¹é‡å‘é€é€šçŸ¥</text>
        <text class="modal-close" bindtap="closeBatchModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-section">
          <text class="section-title">æ‰¹é‡è®¾ç½®</text>
          <view class="form-item">
            <text class="form-label">é€‰æ‹©æ¨¡æ¿</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{templateOptions}}"
              range-key="label"
              value="{{batchTemplateIndex}}"
              bindchange="onBatchTemplateChange"
            >
              <view class="picker-display">
                {{templateOptions[batchTemplateIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">å‘é€å¯¹è±¡ *</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{targetOptions}}"
              range-key="label"
              value="{{batchTargetIndex}}"
              bindchange="onBatchTargetChange"
            >
              <view class="picker-display">
                {{targetOptions[batchTargetIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">å‘é€é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</text>
            <input
              class="form-input"
              type="number"
              placeholder="è¯·è¾“å…¥å‘é€é—´éš”ï¼ˆ0ä¸ºç«‹å³å‘é€ï¼‰"
              value="{{batchInterval}}"
              bindinput="onBatchIntervalInput"
            />
          </view>
        </view>

        <view class="form-section">
          <text class="section-title">é¢„è§ˆ</text>
          <view class="preview-section">
            <text class="preview-title">å°†å‘é€é€šçŸ¥åˆ° {{targetOptions[batchTargetIndex].label}}</text>
            <text class="preview-info" wx:if="{{selectedTemplate}}">æ¨¡æ¿ï¼š{{selectedTemplate.name}}</text>
            <text class="preview-info" wx:if="{{selectedTemplate}}">æ ‡é¢˜ï¼š{{selectedTemplate.title}}</text>
            <text class="preview-info">é—´éš”ï¼š{{batchInterval || 0}} åˆ†é’Ÿ</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--send"
          bindtap="confirmBatchSend"
          disabled="{{!isBatchFormValid}}"
        >
          æ‰¹é‡å‘é€
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeBatchModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>

  <!-- é€šçŸ¥æ¨¡æ¿å¼¹çª— -->
  <view class="template-modal" wx:if="{{showTemplateModal}}">
    <view class="modal-mask" bindtap="closeTemplateModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">é€šçŸ¥æ¨¡æ¿</text>
        <text class="modal-close" bindtap="closeTemplateModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="template-list">
          <view
            class="template-item"
            wx:for="{{templates}}"
            wx:key="id"
            bindtap="selectTemplate"
            data-id="{{item.id}}"
          >
            <view class="template-header">
              <text class="template-name">{{item.name}}</text>
              <view class="template-type">
                <view class="type-badge type-badge--{{item.type}}">
                  {{item.typeText}}
                </view>
              </view>
            </view>
            <view class="template-content">
              <text class="template-title">{{item.title}}</text>
              <text class="template-preview">{{item.contentPreview}}</text>
            </view>
            <view class="template-meta">
              <text class="create-time">åˆ›å»ºäº {{item.createTime}}</text>
              <text class="use-count">ä½¿ç”¨ {{item.useCount}} æ¬¡</text>
            </view>
          </view>
        </view>

        <view class="empty-templates" wx:if="{{templates.length === 0}}">
          <text class="empty-text">æš‚æ— æ¨¡æ¿</text>
          <text class="empty-desc">å‘é€é€šçŸ¥æ—¶å¯ä»¥ä¿å­˜ä¸ºæ¨¡æ¿</text>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn modal-btn--close" bindtap="closeTemplateModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>

  <!-- é€šçŸ¥è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é€šçŸ¥è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{selectedNotification}}">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">æ ‡é¢˜ï¼š</text>
            <text class="detail-value">{{selectedNotification.title}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç±»å‹ï¼š</text>
            <view class="type-badge type-badge--{{selectedNotification.type}}">
              {{selectedNotification.typeText}}
            </view>
          </view>
          <view class="detail-item">
            <text class="detail-label">çŠ¶æ€ï¼š</text>
            <view class="status-badge status-badge--{{selectedNotification.status}}">
              {{selectedNotification.statusText}}
            </view>
          </view>
        </view>

        <!-- å‘é€ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">å‘é€ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">å‘é€è€…ï¼š</text>
            <text class="detail-value">{{selectedNotification.senderName}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å‘é€æ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedNotification.sendTime}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å‘é€å¯¹è±¡ï¼š</text>
            <text class="detail-value">{{selectedNotification.targetInfo}}</text>
          </view>
        </view>

        <!-- å†…å®¹ -->
        <view class="detail-section">
          <text class="section-title">é€šçŸ¥å†…å®¹</text>
          <view class="content-display">
            <text class="content-text">{{selectedNotification.content}}</text>
          </view>
        </view>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">ç»Ÿè®¡ä¿¡æ¯</text>
          <view class="stats-grid">
            <view class="stat-item">
              <text class="stat-number">{{selectedNotification.targetCount}}</text>
              <text class="stat-label">ç›®æ ‡ç”¨æˆ·</text>
            </view>
            <view class="stat-item">
              <text class="stat-number">{{selectedNotification.readCount}}</text>
              <text class="stat-label">å·²è¯»ç”¨æˆ·</text>
            </view>
            <view class="stat-item" wx:if="{{selectedNotification.clickCount}}">
              <text class="stat-number">{{selectedNotification.clickCount}}</text>
              <text class="stat-label">ç‚¹å‡»ç”¨æˆ·</text>
            </view>
            <view class="stat-item">
              <text class="stat-number">{{selectedNotification.readRate}}%</text>
              <text class="stat-label">é˜…è¯»ç‡</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--resend"
          bindtap="resendNotification"
          data-id="{{selectedNotification.id}}"
          wx:if="{{selectedNotification.status === 'sent' && selectedNotification.readCount < selectedNotification.targetCount}}"
        >
          é‡æ–°å‘é€
        </button>
        <button
          class="modal-btn modal-btn--recall"
          bindtap="recallNotification"
          data-id="{{selectedNotification.id}}"
          wx:if="{{selectedNotification.status === 'sent'}}"
        >
          æ’¤å›é€šçŸ¥
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>
</view>