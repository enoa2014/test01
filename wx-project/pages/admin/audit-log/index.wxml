<!-- pages/admin/audit-log/index.wxml -->
<view class="audit-log">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <text class="header-title">å®¡è®¡æ—¥å¿—</text>
      <text class="header-subtitle">ç³»ç»Ÿæ“ä½œè®°å½•ä¸å®‰å…¨å®¡è®¡</text>
    </view>
    <view class="header-actions">
      <button class="export-btn" bindtap="exportLogs">
        <text class="btn-icon">ğŸ“Š</text>
        <text class="btn-text">å¯¼å‡ºæ—¥å¿—</text>
      </button>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <text class="stat-number">{{stats.totalLogs}}</text>
        <text class="stat-label">æ€»æ—¥å¿—æ•°</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.todayLogs}}</text>
        <text class="stat-label">ä»Šæ—¥æ“ä½œ</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.securityEvents}}</text>
        <text class="stat-label">å®‰å…¨äº‹ä»¶</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.errorCount}}</text>
        <text class="stat-label">é”™è¯¯è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæœç´¢ -->
  <view class="filter-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢æ“ä½œç”¨æˆ·ã€IPåœ°å€æˆ–æ“ä½œæè¿°"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">Ã—</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">æ“ä½œç±»å‹</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{actionOptions}}"
          range-key="label"
          value="{{selectedActionIndex}}"
          bindchange="onActionChange"
        >
          <view class="picker-display">
            {{actionOptions[selectedActionIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ“ä½œçº§åˆ«</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{levelOptions}}"
          range-key="label"
          value="{{selectedLevelIndex}}"
          bindchange="onLevelChange"
        >
          <view class="picker-display">
            {{levelOptions[selectedLevelIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ“ä½œç»“æœ</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{resultOptions}}"
          range-key="label"
          value="{{selectedResultIndex}}"
          bindchange="onResultChange"
        >
          <view class="picker-display">
            {{resultOptions[selectedResultIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ—¶é—´èŒƒå›´</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{timeRangeOptions}}"
          range-key="label"
          value="{{selectedTimeRangeIndex}}"
          bindchange="onTimeRangeChange"
        >
          <view class="picker-display">
            {{timeRangeOptions[selectedTimeRangeIndex].label}}
          </view>
        </picker>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <button class="action-btn action-btn--security" bindtap="filterSecurityEvents">
        å®‰å…¨äº‹ä»¶
      </button>
      <button class="action-btn action-btn--error" bindtap="filterErrors">
        é”™è¯¯è®°å½•
      </button>
      <button class="action-btn action-btn--admin" bindtap="filterAdminActions">
        ç®¡ç†æ“ä½œ
      </button>
      <button class="action-btn action-btn--refresh" bindtap="refreshLogs">
        åˆ·æ–°æ•°æ®
      </button>
    </view>
  </view>

  <!-- æ—¥å¿—åˆ—è¡¨ -->
  <view class="log-list" wx:if="{{logs.length > 0}}">
    <view
      class="log-item log-item--{{item.level}}"
      wx:for="{{logs}}"
      wx:key="id"
      bindtap="viewLogDetail"
      data-id="{{item.id}}"
    >
      <view class="item-header">
        <view class="log-info">
          <view class="log-action">
            <text class="action-text">{{item.actionText}}</text>
            <view class="level-badge level-badge--{{item.level}}">
              {{item.levelText}}
            </view>
          </view>
          <view class="log-meta">
            <text class="user-info">{{item.userName}} ({{item.userRole}})</text>
            <text class="log-time">{{item.logTime}}</text>
          </view>
        </view>
        <view class="log-status">
          <view class="result-badge result-badge--{{item.result}}">
            {{item.resultText}}
          </view>
        </view>
      </view>

      <view class="item-content">
        <view class="description-preview">
          <text class="preview-text">{{item.description}}</text>
        </view>

        <view class="detail-info">
          <view class="detail-item" wx:if="{{item.ipAddress}}">
            <text class="detail-label">IPåœ°å€ï¼š</text>
            <text class="detail-text">{{item.ipAddress}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.userAgent}}">
            <text class="detail-label">è®¾å¤‡ä¿¡æ¯ï¼š</text>
            <text class="detail-text">{{item.userAgent}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.targetUser}}">
            <text class="detail-label">ç›®æ ‡ç”¨æˆ·ï¼š</text>
            <text class="detail-text">{{item.targetUser}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.resource}}">
            <text class="detail-label">æ“ä½œèµ„æºï¼š</text>
            <text class="detail-text">{{item.resource}}</text>
          </view>
        </view>

        <view class="security-tags" wx:if="{{item.securityTags.length > 0}}">
          <text class="security-tag" wx:for="{{item.securityTags}}" wx:key="*this" wx:for-item="tag">
            {{tag}}
          </text>
        </view>
      </view>

      <view class="item-actions">
        <button
          class="action-btn action-btn--detail"
          bindtap="viewLogDetail"
          data-id="{{item.id}}"
          catchtap="true"
        >
          æŸ¥çœ‹è¯¦æƒ…
        </button>
        <button
          class="action-btn action-btn--trace"
          bindtap="viewTraceInfo"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.hasTrace}}"
        >
          è¿½è¸ªä¿¡æ¯
        </button>
        <button
          class="action-btn action-btn--report"
          bindtap="reportSecurityIssue"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.level === 'high' || item.level === 'critical'}}"
        >
          å®‰å…¨æŠ¥å‘Š
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ“‹</text>
    <text class="empty-text">æš‚æ— æ—¥å¿—è®°å½•</text>
    <text class="empty-desc">ç³»ç»Ÿæ“ä½œæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨åˆ†é¡µ -->
  <view class="bottom-pagination" wx:if="{{logs.length > 0}}">
    <text class="pagination-info">å…± {{total}} æ¡æ—¥å¿—</text>
    <view class="pagination-controls">
      <button
        class="page-btn {{currentPage <= 1 ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage <= 1}}"
        bindtap="prevPage"
      >
        ä¸Šä¸€é¡µ
      </button>
      <text class="page-info">{{currentPage}}/{{totalPages}}</text>
      <button
        class="page-btn {{currentPage >= totalPages ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage >= totalPages}}"
        bindtap="nextPage"
      >
        ä¸‹ä¸€é¡µ
      </button>
    </view>
  </view>

  <!-- æ—¥å¿—è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">æ—¥å¿—è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{selectedLog}}">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">æ“ä½œç±»å‹ï¼š</text>
              <text class="detail-value">{{selectedLog.actionText}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ“ä½œçº§åˆ«ï¼š</text>
              <view class="level-badge level-badge--{{selectedLog.level}}">
                {{selectedLog.levelText}}
              </view>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ“ä½œç»“æœï¼š</text>
              <view class="result-badge result-badge--{{selectedLog.result}}">
                {{selectedLog.resultText}}
              </view>
            </view>
            <view class="detail-item">
              <text class="detail-label">è®°å½•æ—¶é—´ï¼š</text>
              <text class="detail-value">{{selectedLog.logTime}}</text>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">ç”¨æˆ·ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">æ“ä½œç”¨æˆ·ï¼š</text>
              <text class="detail-value">{{selectedLog.userName}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">ç”¨æˆ·è§’è‰²ï¼š</text>
              <text class="detail-value">{{selectedLog.userRole}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">IPåœ°å€ï¼š</text>
              <text class="detail-value">{{selectedLog.ipAddress}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">åœ°ç†ä½ç½®ï¼š</text>
              <text class="detail-value">{{selectedLog.location || 'æœªçŸ¥'}}</text>
            </view>
          </view>
        </view>

        <!-- æ“ä½œè¯¦æƒ… -->
        <view class="detail-section">
          <text class="section-title">æ“ä½œè¯¦æƒ…</text>
          <view class="content-display">
            <text class="content-text">{{selectedLog.description}}</text>
          </view>
        </view>

        <!-- æŠ€æœ¯ä¿¡æ¯ -->
        <view class="detail-section" wx:if="{{selectedLog.userAgent || selectedLog.sessionId}}">
          <text class="section-title">æŠ€æœ¯ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item" wx:if="{{selectedLog.userAgent}}">
              <text class="detail-label">ç”¨æˆ·ä»£ç†ï¼š</text>
              <text class="detail-value">{{selectedLog.userAgent}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedLog.sessionId}}">
              <text class="detail-label">ä¼šè¯IDï¼š</text>
              <text class="detail-value">{{selectedLog.sessionId}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedLog.requestId}}">
              <text class="detail-label">è¯·æ±‚IDï¼š</text>
              <text class="detail-value">{{selectedLog.requestId}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedLog.duration}}">
              <text class="detail-label">æ‰§è¡Œè€—æ—¶ï¼š</text>
              <text class="detail-value">{{selectedLog.duration}}ms</text>
            </view>
          </view>
        </view>

        <!-- å®‰å…¨æ ‡ç­¾ -->
        <view class="detail-section" wx:if="{{selectedLog.securityTags.length > 0}}">
          <text class="section-title">å®‰å…¨æ ‡ç­¾</text>
          <view class="security-tags">
            <text class="security-tag" wx:for="{{selectedLog.securityTags}}" wx:key="*this" wx:for-item="tag">
              {{tag}}
            </text>
          </view>
        </view>

        <!-- ç›¸å…³èµ„æº -->
        <view class="detail-section" wx:if="{{selectedLog.targetUser || selectedLog.resource}}">
          <text class="section-title">ç›¸å…³èµ„æº</text>
          <view class="detail-grid">
            <view class="detail-item" wx:if="{{selectedLog.targetUser}}">
              <text class="detail-label">ç›®æ ‡ç”¨æˆ·ï¼š</text>
              <text class="detail-value">{{selectedLog.targetUser}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedLog.resource}}">
              <text class="detail-label">æ“ä½œèµ„æºï¼š</text>
              <text class="detail-value">{{selectedLog.resource}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedLog.resourceId}}">
              <text class="detail-label">èµ„æºIDï¼š</text>
              <text class="detail-value">{{selectedLog.resourceId}}</text>
            </view>
          </view>
        </view>

        <!-- åŸå§‹æ•°æ® -->
        <view class="detail-section" wx:if="{{selectedLog.rawData}}">
          <text class="section-title">åŸå§‹æ•°æ®</text>
          <view class="raw-data-display">
            <text class="raw-data-text">{{selectedLog.rawData}}</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--trace"
          bindtap="viewTraceInfo"
          data-id="{{selectedLog.id}}"
          wx:if="{{selectedLog.hasTrace}}"
        >
          æŸ¥çœ‹è¿½è¸ªä¿¡æ¯
        </button>
        <button
          class="modal-btn modal-btn--report"
          bindtap="reportSecurityIssue"
          data-id="{{selectedLog.id}}"
          wx:if="{{selectedLog.level === 'high' || selectedLog.level === 'critical'}}"
        >
          ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>

  <!-- è¿½è¸ªä¿¡æ¯å¼¹çª— -->
  <view class="trace-modal" wx:if="{{showTraceModal}}">
    <view class="modal-mask" bindtap="closeTraceModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ“ä½œè¿½è¸ªä¿¡æ¯</text>
        <text class="modal-close" bindtap="closeTraceModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{traceInfo}}">
        <view class="trace-section">
          <text class="section-title">è¿½è¸ªé“¾è·¯</text>
          <view class="trace-chain">
            <view class="trace-step" wx:for="{{traceInfo.chain}}" wx:key="step">
              <view class="step-number">{{item.step}}</view>
              <view class="step-content">
                <text class="step-action">{{item.action}}</text>
                <text class="step-time">{{item.time}}</text>
              </view>
            </view>
          </view>
        </view>

        <view class="trace-section">
          <text class="section-title">ç›¸å…³æ“ä½œ</text>
          <view class="related-logs">
            <view class="related-log" wx:for="{{traceInfo.relatedLogs}}" wx:key="id">
              <text class="related-action">{{item.action}}</text>
              <text class="related-time">{{item.time}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn modal-btn--close" bindtap="closeTraceModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>
</view>