<!-- pages/admin/invite-management/index.wxml -->
<view class="invite-management">
  <!-- éª¨æ¶å± -->
  <skeleton-screen show="{{showSkeleton}}" type="page,stats,search,filters,list" rows="5"></skeleton-screen>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <text class="header-title">é‚€è¯·ç ç®¡ç†</text>
      <text class="header-subtitle">åˆ›å»ºå’Œç®¡ç†é‚€è¯·ç </text>
    </view>
    <view class="header-actions">
      <button class="create-btn" bindtap="showCreateModal">
        <text class="btn-icon">+</text>
        <text class="btn-text">åˆ›å»ºé‚€è¯·ç </text>
      </button>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <text class="stat-number">{{stats.totalInvites}}</text>
        <text class="stat-label">æ€»é‚€è¯·ç </text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.activeInvites}}</text>
        <text class="stat-label">æœ‰æ•ˆé‚€è¯·ç </text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.usedInvites}}</text>
        <text class="stat-label">å·²ä½¿ç”¨</text>
      </view>
      <view class="stat-card">
        <text class="stat-number">{{stats.expiredInvites}}</text>
        <text class="stat-label">å·²è¿‡æœŸ</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæœç´¢ -->
  <view class="filter-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢é‚€è¯·ç æˆ–æè¿°"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">Ã—</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">è§’è‰²</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{roleOptions}}"
          range-key="label"
          value="{{selectedRoleIndex}}"
          bindchange="onRoleChange"
        >
          <view class="picker-display">
            {{roleOptions[selectedRoleIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">çŠ¶æ€</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{statusOptions}}"
          range-key="label"
          value="{{selectedStatusIndex}}"
          bindchange="onStatusChange"
        >
          <view class="picker-display">
            {{statusOptions[selectedStatusIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">åˆ›å»ºæ—¶é—´</text>
        <picker
          class="filter-picker"
          mode="date"
          value="{{selectedDate}}"
          bindchange="onDateChange"
        >
          <view class="picker-display">
            {{selectedDate || 'å…¨éƒ¨æ—¶é—´'}}
          </view>
        </picker>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <button class="action-btn action-btn--batch" bindtap="showBatchCreateModal">
        æ‰¹é‡åˆ›å»º
      </button>
      <button class="action-btn action-btn--export" bindtap="exportInvites">
        å¯¼å‡ºæ•°æ®
      </button>
    </view>
  </view>

  <!-- é‚€è¯·ç åˆ—è¡¨ -->
  <view class="invite-list" wx:if="{{invites.length > 0}}">
    <view
      class="invite-item"
      wx:for="{{invites}}"
      wx:key="id"
      bindtap="viewInviteDetail"
      data-id="{{item.id}}"
    >
      <view class="item-header">
        <view class="invite-info">
          <view class="invite-code">
            <text class="code-text">{{item.code}}</text>
            <button class="copy-btn" bindtap="copyInviteCode" data-code="{{item.code}}" catchtap="true">
              å¤åˆ¶
            </button>
          </view>
          <view class="invite-meta">
            <role-badge role="{{item.role}}" size="small"></role-badge>
            <text class="create-time">åˆ›å»ºäº {{item.createTime}}</text>
          </view>
        </view>
        <view class="invite-status">
          <view class="status-badge status-badge--{{item.status}}">
            {{item.statusText}}
          </view>
        </view>
      </view>

      <view class="item-content">
        <view class="detail-info">
          <view class="detail-item" wx:if="{{item.description}}">
            <text class="detail-label">è¯´æ˜ï¼š</text>
            <text class="detail-text">{{item.description}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ä½¿ç”¨æ¬¡æ•°ï¼š</text>
            <text class="detail-text">{{item.usedCount}}/{{item.maxUses}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.expiresAt}}">
            <text class="detail-label">è¿‡æœŸæ—¶é—´ï¼š</text>
            <text class="detail-text">{{item.expiresAt}}</text>
          </view>
          <view class="detail-item" wx:if="{{item.createdBy}}">
            <text class="detail-label">åˆ›å»ºè€…ï¼š</text>
            <text class="detail-text">{{item.createdByName || 'ç®¡ç†å‘˜'}}</text>
          </view>
        </view>

        <view class="usage-info" wx:if="{{item.usedCount > 0}}">
          <text class="usage-label">ä½¿ç”¨è®°å½•ï¼š</text>
          <view class="usage-list">
            <view
              class="usage-item"
              wx:for="{{item.usageRecords}}"
              wx:for-item="record"
              wx:key="id"
            >
              <text class="usage-user">{{record.userName}}</text>
              <text class="usage-time">{{record.useTime}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="item-actions">
        <button
          class="action-btn action-btn--edit"
          bindtap="editInvite"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.status === 'active'}}"
        >
          ç¼–è¾‘
        </button>
        <button
          class="action-btn action-btn--revoke"
          bindtap="revokeInvite"
          data-id="{{item.id}}"
          catchtap="true"
          wx:if="{{item.status === 'active'}}"
        >
          æ’¤é”€
        </button>
        <button
          class="action-btn action-btn--detail"
          bindtap="viewInviteDetail"
          data-id="{{item.id}}"
          catchtap="true"
        >
          è¯¦æƒ…
        </button>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ«</text>
    <text class="empty-text">æš‚æ— é‚€è¯·ç </text>
    <text class="empty-desc">ç‚¹å‡»ä¸Šæ–¹"åˆ›å»ºé‚€è¯·ç "æŒ‰é’®å¼€å§‹åˆ›å»º</text>
    <button class="create-empty-btn" bindtap="showCreateModal">
      åˆ›å»ºç¬¬ä¸€ä¸ªé‚€è¯·ç 
    </button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨åˆ†é¡µ -->
  <view class="bottom-pagination" wx:if="{{invites.length > 0}}">
    <text class="pagination-info">å…± {{total}} ä¸ªé‚€è¯·ç </text>
    <view class="pagination-controls">
      <button
        class="page-btn {{currentPage <= 1 ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage <= 1}}"
        bindtap="prevPage"
      >
        ä¸Šä¸€é¡µ
      </button>
      <text class="page-info">{{currentPage}}/{{totalPages}}</text>
      <button
        class="page-btn {{currentPage >= totalPages ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage >= totalPages}}"
        bindtap="nextPage"
      >
        ä¸‹ä¸€é¡µ
      </button>
    </view>
  </view>

  <!-- åˆ›å»ºé‚€è¯·ç å¼¹çª— -->
  <view class="create-modal" wx:if="{{showCreateModal}}">
    <view class="modal-mask" bindtap="closeCreateModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºé‚€è¯·ç </text>
        <text class="modal-close" bindtap="closeCreateModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="form-item">
            <text class="form-label">è§’è‰²ç±»å‹ *</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{roleOptions}}"
              range-key="label"
              value="{{formRoleIndex}}"
              bindchange="onFormRoleChange"
            >
              <view class="picker-display">
                {{roleOptions[formRoleIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">ä½¿ç”¨æ¬¡æ•° *</text>
            <input
              class="form-input"
              type="number"
              placeholder="è¯·è¾“å…¥ä½¿ç”¨æ¬¡æ•°"
              value="{{formMaxUses}}"
              bindinput="onFormMaxUsesInput"
            />
          </view>

          <view class="form-item">
            <text class="form-label">è¯´æ˜</text>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥é‚€è¯·ç è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"
              value="{{formDescription}}"
              bindinput="onFormDescriptionInput"
              maxlength="200"
              auto-height
            ></textarea>
            <text class="input-counter">{{formDescription.length}}/200</text>
          </view>
        </view>

        <view class="form-section">
          <text class="section-title">æœ‰æ•ˆæœŸè®¾ç½®</text>
          <view class="form-item">
            <checkbox-group bindchange="onExpiryChange">
              <label class="checkbox-item">
                <checkbox value="never" checked="{{formExpiryType === 'never'}}"/>
                <text class="checkbox-text">æ°¸ä¸è¿‡æœŸ</text>
              </label>
              <label class="checkbox-item">
                <checkbox value="date" checked="{{formExpiryType === 'date'}}"/>
                <text class="checkbox-text">æŒ‡å®šè¿‡æœŸæ—¶é—´</text>
              </label>
            </checkbox-group>
          </view>

          <view class="form-item" wx:if="{{formExpiryType === 'date'}}">
            <text class="form-label">è¿‡æœŸæ—¶é—´</text>
            <picker
              class="form-picker"
              mode="date"
              value="{{formExpiresAt}}"
              bindchange="onFormExpiresAtChange"
            >
              <view class="picker-display">
                {{formExpiresAt || 'è¯·é€‰æ‹©è¿‡æœŸæ—¶é—´'}}
              </view>
            </picker>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--confirm"
          bindtap="confirmCreateInvite"
          disabled="{{!isFormValid}}"
        >
          åˆ›å»ºé‚€è¯·ç 
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeCreateModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡åˆ›å»ºå¼¹çª— -->
  <view class="batch-modal" wx:if="{{showBatchModal}}">
    <view class="modal-mask" bindtap="closeBatchModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">æ‰¹é‡åˆ›å»ºé‚€è¯·ç </text>
        <text class="modal-close" bindtap="closeBatchModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-section">
          <text class="section-title">æ‰¹é‡è®¾ç½®</text>
          <view class="form-item">
            <text class="form-label">è§’è‰²ç±»å‹ *</text>
            <picker
              class="form-picker"
              mode="selector"
              range="{{roleOptions}}"
              range-key="label"
              value="{{batchRoleIndex}}"
              bindchange="onBatchRoleChange"
            >
              <view class="picker-display">
                {{roleOptions[batchRoleIndex].label}}
              </view>
            </picker>
          </view>

          <view class="form-item">
            <text class="form-label">æ•°é‡ *</text>
            <input
              class="form-input"
              type="number"
              placeholder="è¯·è¾“å…¥åˆ›å»ºæ•°é‡ï¼ˆ1-50ï¼‰"
              value="{{batchCount}}"
              bindinput="onBatchCountInput"
            />
          </view>

          <view class="form-item">
            <text class="form-label">æ¯ä¸ªé‚€è¯·ç ä½¿ç”¨æ¬¡æ•° *</text>
            <input
              class="form-input"
              type="number"
              placeholder="è¯·è¾“å…¥ä½¿ç”¨æ¬¡æ•°"
              value="{{batchMaxUses}}"
              bindinput="onBatchMaxUsesInput"
            />
          </view>

          <view class="form-item">
            <text class="form-label">ç»Ÿä¸€è¯´æ˜</text>
            <textarea
              class="form-textarea"
              placeholder="æ‰¹é‡åˆ›å»ºçš„é‚€è¯·ç å°†ä½¿ç”¨æ­¤è¯´æ˜ï¼ˆé€‰å¡«ï¼‰"
              value="{{batchDescription}}"
              bindinput="onBatchDescriptionInput"
              maxlength="200"
              auto-height
            ></textarea>
            <text class="input-counter">{{batchDescription.length}}/200</text>
          </view>
        </view>

        <view class="form-section">
          <text class="section-title">é¢„è§ˆ</text>
          <view class="preview-section">
            <text class="preview-title">å°†åˆ›å»º {{batchCount || 0}} ä¸ªé‚€è¯·ç </text>
            <text class="preview-info">è§’è‰²ï¼š{{roleOptions[batchRoleIndex].label}}</text>
            <text class="preview-info">ä½¿ç”¨æ¬¡æ•°ï¼š{{batchMaxUses || 1}} æ¬¡</text>
            <text class="preview-info" wx:if="{{batchDescription}}">è¯´æ˜ï¼š{{batchDescription}}</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--confirm"
          bindtap="confirmBatchCreate"
          disabled="{{!isBatchFormValid}}"
        >
          æ‰¹é‡åˆ›å»º
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeBatchModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>

  <!-- é‚€è¯·ç è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">é‚€è¯·ç è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{selectedInvite}}">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">é‚€è¯·ç ï¼š</text>
            <view class="code-display">
              <text class="code-text">{{selectedInvite.code}}</text>
              <button class="copy-btn" bindtap="copyInviteCode" data-code="{{selectedInvite.code}}">
                å¤åˆ¶
              </button>
            </view>
          </view>
          <view class="detail-item">
            <text class="detail-label">è§’è‰²ï¼š</text>
            <role-badge role="{{selectedInvite.role}}"></role-badge>
          </view>
          <view class="detail-item">
            <text class="detail-label">çŠ¶æ€ï¼š</text>
            <view class="status-badge status-badge--{{selectedInvite.status}}">
              {{selectedInvite.statusText}}
            </view>
          </view>
        </view>

        <!-- ä½¿ç”¨ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">ä½¿ç”¨ä¿¡æ¯</text>
          <view class="detail-item">
            <text class="detail-label">ä½¿ç”¨æ¬¡æ•°ï¼š</text>
            <text class="detail-value">{{selectedInvite.usedCount}}/{{selectedInvite.maxUses}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å‰©ä½™æ¬¡æ•°ï¼š</text>
            <text class="detail-value">{{selectedInvite.remainingUses}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedInvite.expiresAt}}">
            <text class="detail-label">è¿‡æœŸæ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedInvite.expiresAt}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</text>
            <text class="detail-value">{{selectedInvite.createTime}}</text>
          </view>
        </view>

        <!-- ä½¿ç”¨è®°å½• -->
        <view class="detail-section" wx:if="{{selectedInvite.usageRecords.length > 0}}">
          <text class="section-title">ä½¿ç”¨è®°å½•</text>
          <view class="usage-list">
            <view
              class="usage-record"
              wx:for="{{selectedInvite.usageRecords}}"
              wx:for-item="record"
              wx:key="id"
            >
              <view class="record-user">
                <text class="user-name">{{record.userName}}</text>
                <text class="user-email">{{record.userEmail || ''}}</text>
              </view>
              <view class="record-meta">
                <text class="use-time">ä½¿ç”¨æ—¶é—´ï¼š{{record.useTime}}</text>
                <text class="user-ip">IPï¼š{{record.userIp || 'æœªçŸ¥'}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- å…¶ä»–ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">å…¶ä»–ä¿¡æ¯</text>
          <view class="detail-item" wx:if="{{selectedInvite.description}}">
            <text class="detail-label">è¯´æ˜ï¼š</text>
            <text class="detail-value">{{selectedInvite.description}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åˆ›å»ºè€…ï¼š</text>
            <text class="detail-value">{{selectedInvite.createdByName || 'ç®¡ç†å‘˜'}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">IDï¼š</text>
            <text class="detail-value">{{selectedInvite.id}}</text>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--revoke"
          bindtap="revokeInvite"
          data-id="{{selectedInvite.id}}"
          wx:if="{{selectedInvite.status === 'active'}}"
        >
          æ’¤é”€é‚€è¯·ç 
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>
</view>