<!-- pages/admin/user-management/index.wxml -->
<view class="user-management">
  <!-- 骨架屏 -->
  <skeleton-screen show="{{showSkeleton}}" type="page,stats,search,filters,list" rows="5"></skeleton-screen>

  <!-- 页面头部 -->
  <view class="page-header">
    <view class="header-content">
      <text class="header-title">用户管理</text>
      <text class="header-subtitle">管理系统用户和权限</text>
    </view>
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">总用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">活跃用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.newUsers}}</text>
        <text class="stat-label">今日新增</text>
      </view>
    </view>
  </view>

  <!-- 搜索和筛选 -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">🔍</text>
        <input
          class="search-input"
          type="text"
          placeholder="搜索用户姓名、手机号或邮箱"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">×</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">角色</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{roleOptions}}"
          range-key="label"
          value="{{selectedRoleIndex}}"
          bindchange="onRoleChange"
        >
          <view class="picker-display">
            {{roleOptions[selectedRoleIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">状态</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{statusOptions}}"
          range-key="label"
          value="{{selectedStatusIndex}}"
          bindchange="onStatusChange"
        >
          <view class="picker-display">
            {{statusOptions[selectedStatusIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">注册时间</text>
        <picker
          class="filter-picker"
          mode="date"
          value="{{selectedDate}}"
          bindchange="onDateChange"
        >
          <view class="picker-display">
            {{selectedDate || '全部时间'}}
          </view>
        </picker>
      </view>
    </view>
  </view>

  <!-- 批量操作 -->
  <view class="batch-operations" wx:if="{{selectedUsers.length > 0}}">
    <view class="batch-info">
      <text class="selected-count">已选择 {{selectedUsers.length}} 个用户</text>
    </view>
    <view class="batch-actions">
      <button class="batch-btn batch-btn--modify" bindtap="showBatchRoleModal">
        修改角色
      </button>
      <button class="batch-btn batch-btn--suspend" bindtap="batchSuspendUsers">
        暂停用户
      </button>
      <button class="batch-btn batch-btn--activate" bindtap="batchActivateUsers">
        激活用户
      </button>
    </view>
  </view>

  <!-- 用户列表 -->
  <view class="user-list" wx:if="{{users.length > 0}}">
    <view class="list-header">
      <view class="select-all" bindtap="toggleSelectAll">
        <view class="checkbox {{allSelected ? 'checkbox--checked' : ''}}">
          <text class="check-icon" wx:if="{{allSelected}}">✓</text>
        </view>
        <text class="select-all-text">全选</text>
      </view>
      <view class="sort-options">
        <text class="sort-label">排序：</text>
        <picker
          class="sort-picker"
          mode="selector"
          range="{{sortOptions}}"
          range-key="label"
          value="{{selectedSortIndex}}"
          bindchange="onSortChange"
        >
          <view class="picker-display">
            {{sortOptions[selectedSortIndex].label}}
          </view>
        </picker>
      </view>
    </view>

    <view
      class="user-item"
      wx:for="{{users}}"
      wx:key="id"
      bindtap="toggleUserSelection"
      data-id="{{item.id}}"
    >
      <view class="item-left">
        <view class="user-checkbox {{selectedUsers.includes(item.id) ? 'user-checkbox--checked' : ''}}">
          <text class="check-icon" wx:if="{{selectedUsers.includes(item.id)}}">✓</text>
        </view>
        <view class="user-avatar">
          <image
            class="avatar-image"
            src="{{item.avatar || '/assets/default-avatar.png'}}"
            mode="aspectFill"
          ></image>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.displayName}}</text>
          <text class="user-contact">{{item.phone || item.email}}</text>
          <view class="user-roles">
            <role-badge
              wx:for="{{item.roles}}"
              wx:for-item="role"
              wx:key="role"
              role="{{role}}"
              size="small"
            ></role-badge>
          </view>
        </view>
      </view>

      <view class="item-right">
        <view class="user-status">
          <view class="status-badge status-badge--{{item.status}}">
            {{item.statusText}}
          </view>
        </view>
        <view class="user-meta">
          <text class="register-time">注册于 {{item.registerTime}}</text>
          <text class="last-active">最后活跃 {{item.lastActiveTime}}</text>
        </view>
        <view class="user-actions">
          <button
            class="action-btn action-btn--edit"
            bindtap="editUser"
            data-id="{{item.id}}"
            catchtap="true"
          >
            编辑
          </button>
          <button
            class="action-btn action-btn--role"
            bindtap="modifyUserRole"
            data-id="{{item.id}}"
            catchtap="true"
          >
            角色
          </button>
          <button
            class="action-btn action-btn--status"
            bindtap="toggleUserStatus"
            data-id="{{item.id}}"
            catchtap="true"
          >
            {{item.status === 'active' ? '暂停' : '激活'}}
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">👥</text>
    <text class="empty-text">暂无用户数据</text>
    <text class="empty-desc">{{emptyDesc}}</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 底部分页 -->
  <view class="bottom-pagination" wx:if="{{users.length > 0}}">
    <text class="pagination-info">共 {{total}} 个用户</text>
    <view class="pagination-controls">
      <button
        class="page-btn {{currentPage <= 1 ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage <= 1}}"
        bindtap="prevPage"
      >
        上一页
      </button>
      <text class="page-info">{{currentPage}}/{{totalPages}}</text>
      <button
        class="page-btn {{currentPage >= totalPages ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage >= totalPages}}"
        bindtap="nextPage"
      >
        下一页
      </button>
    </view>
  </view>

  <!-- 用户详情弹窗 -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">用户详情</text>
        <text class="modal-close" bindtap="closeDetailModal">×</text>
      </view>

      <view class="modal-body" wx:if="{{selectedUser}}">
        <!-- 用户基本信息 -->
        <view class="detail-section">
          <text class="section-title">基本信息</text>
          <view class="user-detail">
            <image
              class="detail-avatar"
              src="{{selectedUser.avatar || '/assets/default-avatar.png'}}"
              mode="aspectFill"
            ></image>
            <view class="detail-info">
              <text class="detail-name">{{selectedUser.displayName}}</text>
              <text class="detail-contact">手机：{{selectedUser.phone || '未设置'}}</text>
              <text class="detail-contact">邮箱：{{selectedUser.email || '未设置'}}</text>
              <text class="detail-time">注册时间：{{selectedUser.registerTime}}</text>
              <text class="detail-time">最后活跃：{{selectedUser.lastActiveTime}}</text>
            </view>
          </view>
        </view>

        <!-- 用户角色 -->
        <view class="detail-section">
          <text class="section-title">用户角色</text>
          <view class="roles-detail">
            <view class="role-list">
              <role-badge
                wx:for="{{selectedUser.roles}}"
                wx:for-item="role"
                wx:key="role"
                role="{{role}}"
              ></role-badge>
              <text class="no-roles" wx:if="{{selectedUser.roles.length === 0}}">暂无角色</text>
            </view>
            <button class="modify-roles-btn" bindtap="modifyUserRole" data-id="{{selectedUser.id}}">
              修改角色
            </button>
          </view>
        </view>

        <!-- 用户状态 -->
        <view class="detail-section">
          <text class="section-title">用户状态</text>
          <view class="status-detail">
            <view class="current-status">
              <text class="status-label">当前状态：</text>
              <view class="status-badge status-badge--{{selectedUser.status}}">
                {{selectedUser.statusText}}
              </view>
            </view>
            <view class="status-actions">
              <button
                class="status-btn"
                bindtap="toggleUserStatus"
                data-id="{{selectedUser.id}}"
              >
                {{selectedUser.status === 'active' ? '暂停用户' : '激活用户'}}
              </button>
            </view>
          </view>
        </view>

        <!-- 用户资料 -->
        <view class="detail-section" wx:if="{{selectedUser.profile}}">
          <text class="section-title">详细资料</text>
          <view class="profile-detail">
            <view class="profile-item" wx:if="{{selectedUser.profile.realName}}">
              <text class="profile-label">真实姓名：</text>
              <text class="profile-value">{{selectedUser.profile.realName}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.gender}}">
              <text class="profile-label">性别：</text>
              <text class="profile-value">{{selectedUser.profile.gender === 'male' ? '男' : '女'}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.occupation}}">
              <text class="profile-label">职业：</text>
              <text class="profile-value">{{selectedUser.profile.occupation}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.organization}}">
              <text class="profile-label">机构：</text>
              <text class="profile-value">{{selectedUser.profile.organization}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn modal-btn--edit" bindtap="editUser" data-id="{{selectedUser.id}}">
          编辑用户
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          关闭
        </button>
      </view>
    </view>
  </view>

  <!-- 批量角色修改弹窗 -->
  <view class="role-modal" wx:if="{{showRoleModal}}">
    <view class="modal-mask" bindtap="closeRoleModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{roleModalTitle}}</text>
        <text class="modal-close" bindtap="closeRoleModal">×</text>
      </view>

      <view class="modal-body">
        <view class="role-selection">
          <text class="selection-title">选择角色</text>
          <view class="role-options">
            <label class="role-option" wx:for="{{availableRoles}}" wx:key="value">
              <checkbox
                class="role-checkbox"
                value="{{item.value}}"
                checked="{{selectedRoles.includes(item.value)}}"
                bindchange="onRoleCheckboxChange"
                data-value="{{item.value}}"
              ></checkbox>
              <text class="role-option-label">{{item.label}}</text>
              <text class="role-option-desc">{{item.description}}</text>
            </label>
          </view>
        </view>

        <view class="reason-input">
          <text class="input-label">修改原因</text>
          <textarea
            class="reason-textarea"
            placeholder="请输入修改原因..."
            value="{{roleChangeReason}}"
            bindinput="onRoleReasonInput"
            maxlength="200"
            auto-height
          ></textarea>
          <text class="input-counter">{{roleChangeReason.length}}/200</text>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--confirm"
          bindtap="confirmRoleChange"
          disabled="{{!roleChangeReason.trim()}}"
        >
          确认修改
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeRoleModal">
          取消
        </button>
      </view>
    </view>
  </view>
</view>