<!-- pages/admin/user-management/index.wxml -->
<view class="user-management">
  <!-- éª¨æ¶å± -->
  <skeleton-screen show="{{showSkeleton}}" type="page,stats,search,filters,list" rows="5"></skeleton-screen>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <text class="header-title">ç”¨æˆ·ç®¡ç†</text>
      <text class="header-subtitle">ç®¡ç†ç³»ç»Ÿç”¨æˆ·å’Œæƒé™</text>
    </view>
    <view class="header-stats">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">æ€»ç”¨æˆ·</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">æ´»è·ƒç”¨æˆ·</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.newUsers}}</text>
        <text class="stat-label">ä»Šæ—¥æ–°å¢</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          type="text"
          placeholder="æœç´¢ç”¨æˆ·å§“åã€æ‰‹æœºå·æˆ–é‚®ç®±"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <text class="clear-icon {{searchKeyword ? '' : 'hidden'}}" bindtap="clearSearch">Ã—</text>
      </view>
    </view>

    <view class="filter-controls">
      <view class="filter-item">
        <text class="filter-label">è§’è‰²</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{roleOptions}}"
          range-key="label"
          value="{{selectedRoleIndex}}"
          bindchange="onRoleChange"
        >
          <view class="picker-display">
            {{roleOptions[selectedRoleIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">çŠ¶æ€</text>
        <picker
          class="filter-picker"
          mode="selector"
          range="{{statusOptions}}"
          range-key="label"
          value="{{selectedStatusIndex}}"
          bindchange="onStatusChange"
        >
          <view class="picker-display">
            {{statusOptions[selectedStatusIndex].label}}
          </view>
        </picker>
      </view>

      <view class="filter-item">
        <text class="filter-label">æ³¨å†Œæ—¶é—´</text>
        <picker
          class="filter-picker"
          mode="date"
          value="{{selectedDate}}"
          bindchange="onDateChange"
        >
          <view class="picker-display">
            {{selectedDate || 'å…¨éƒ¨æ—¶é—´'}}
          </view>
        </picker>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œ -->
  <view class="batch-operations" wx:if="{{selectedUsers.length > 0}}">
    <view class="batch-info">
      <text class="selected-count">å·²é€‰æ‹© {{selectedUsers.length}} ä¸ªç”¨æˆ·</text>
    </view>
    <view class="batch-actions">
      <button class="batch-btn batch-btn--modify" bindtap="showBatchRoleModal">
        ä¿®æ”¹è§’è‰²
      </button>
      <button class="batch-btn batch-btn--suspend" bindtap="batchSuspendUsers">
        æš‚åœç”¨æˆ·
      </button>
      <button class="batch-btn batch-btn--activate" bindtap="batchActivateUsers">
        æ¿€æ´»ç”¨æˆ·
      </button>
    </view>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <view class="user-list" wx:if="{{users.length > 0}}">
    <view class="list-header">
      <view class="select-all" bindtap="toggleSelectAll">
        <view class="checkbox {{allSelected ? 'checkbox--checked' : ''}}">
          <text class="check-icon" wx:if="{{allSelected}}">âœ“</text>
        </view>
        <text class="select-all-text">å…¨é€‰</text>
      </view>
      <view class="sort-options">
        <text class="sort-label">æ’åºï¼š</text>
        <picker
          class="sort-picker"
          mode="selector"
          range="{{sortOptions}}"
          range-key="label"
          value="{{selectedSortIndex}}"
          bindchange="onSortChange"
        >
          <view class="picker-display">
            {{sortOptions[selectedSortIndex].label}}
          </view>
        </picker>
      </view>
    </view>

    <view
      class="user-item"
      wx:for="{{users}}"
      wx:key="id"
      bindtap="toggleUserSelection"
      data-id="{{item.id}}"
    >
      <view class="item-left">
        <view class="user-checkbox {{selectedUsers.includes(item.id) ? 'user-checkbox--checked' : ''}}">
          <text class="check-icon" wx:if="{{selectedUsers.includes(item.id)}}">âœ“</text>
        </view>
        <view class="user-avatar">
          <image
            class="avatar-image"
            src="{{item.avatar || '/assets/default-avatar.png'}}"
            mode="aspectFill"
          ></image>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.displayName}}</text>
          <text class="user-contact">{{item.phone || item.email}}</text>
          <view class="user-roles">
            <role-badge
              wx:for="{{item.roles}}"
              wx:for-item="role"
              wx:key="role"
              role="{{role}}"
              size="small"
            ></role-badge>
          </view>
        </view>
      </view>

      <view class="item-right">
        <view class="user-status">
          <view class="status-badge status-badge--{{item.status}}">
            {{item.statusText}}
          </view>
        </view>
        <view class="user-meta">
          <text class="register-time">æ³¨å†Œäº {{item.registerTime}}</text>
          <text class="last-active">æœ€åæ´»è·ƒ {{item.lastActiveTime}}</text>
        </view>
        <view class="user-actions">
          <button
            class="action-btn action-btn--edit"
            bindtap="editUser"
            data-id="{{item.id}}"
            catchtap="true"
          >
            ç¼–è¾‘
          </button>
          <button
            class="action-btn action-btn--role"
            bindtap="modifyUserRole"
            data-id="{{item.id}}"
            catchtap="true"
          >
            è§’è‰²
          </button>
          <button
            class="action-btn action-btn--status"
            bindtap="toggleUserStatus"
            data-id="{{item.id}}"
            catchtap="true"
          >
            {{item.status === 'active' ? 'æš‚åœ' : 'æ¿€æ´»'}}
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <text class="empty-icon">ğŸ‘¥</text>
    <text class="empty-text">æš‚æ— ç”¨æˆ·æ•°æ®</text>
    <text class="empty-desc">{{emptyDesc}}</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- åº•éƒ¨åˆ†é¡µ -->
  <view class="bottom-pagination" wx:if="{{users.length > 0}}">
    <text class="pagination-info">å…± {{total}} ä¸ªç”¨æˆ·</text>
    <view class="pagination-controls">
      <button
        class="page-btn {{currentPage <= 1 ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage <= 1}}"
        bindtap="prevPage"
      >
        ä¸Šä¸€é¡µ
      </button>
      <text class="page-info">{{currentPage}}/{{totalPages}}</text>
      <button
        class="page-btn {{currentPage >= totalPages ? 'page-btn--disabled' : ''}}"
        disabled="{{currentPage >= totalPages}}"
        bindtap="nextPage"
      >
        ä¸‹ä¸€é¡µ
      </button>
    </view>
  </view>

  <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal" wx:if="{{showDetailModal}}">
    <view class="modal-mask" bindtap="closeDetailModal"></view>
    <view class="modal-content modal-content--large">
      <view class="modal-header">
        <text class="modal-title">ç”¨æˆ·è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeDetailModal">Ã—</text>
      </view>

      <view class="modal-body" wx:if="{{selectedUser}}">
        <!-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ -->
        <view class="detail-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="user-detail">
            <image
              class="detail-avatar"
              src="{{selectedUser.avatar || '/assets/default-avatar.png'}}"
              mode="aspectFill"
            ></image>
            <view class="detail-info">
              <text class="detail-name">{{selectedUser.displayName}}</text>
              <text class="detail-contact">æ‰‹æœºï¼š{{selectedUser.phone || 'æœªè®¾ç½®'}}</text>
              <text class="detail-contact">é‚®ç®±ï¼š{{selectedUser.email || 'æœªè®¾ç½®'}}</text>
              <text class="detail-time">æ³¨å†Œæ—¶é—´ï¼š{{selectedUser.registerTime}}</text>
              <text class="detail-time">æœ€åæ´»è·ƒï¼š{{selectedUser.lastActiveTime}}</text>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·è§’è‰² -->
        <view class="detail-section">
          <text class="section-title">ç”¨æˆ·è§’è‰²</text>
          <view class="roles-detail">
            <view class="role-list">
              <role-badge
                wx:for="{{selectedUser.roles}}"
                wx:for-item="role"
                wx:key="role"
                role="{{role}}"
              ></role-badge>
              <text class="no-roles" wx:if="{{selectedUser.roles.length === 0}}">æš‚æ— è§’è‰²</text>
            </view>
            <button class="modify-roles-btn" bindtap="modifyUserRole" data-id="{{selectedUser.id}}">
              ä¿®æ”¹è§’è‰²
            </button>
          </view>
        </view>

        <!-- ç”¨æˆ·çŠ¶æ€ -->
        <view class="detail-section">
          <text class="section-title">ç”¨æˆ·çŠ¶æ€</text>
          <view class="status-detail">
            <view class="current-status">
              <text class="status-label">å½“å‰çŠ¶æ€ï¼š</text>
              <view class="status-badge status-badge--{{selectedUser.status}}">
                {{selectedUser.statusText}}
              </view>
            </view>
            <view class="status-actions">
              <button
                class="status-btn"
                bindtap="toggleUserStatus"
                data-id="{{selectedUser.id}}"
              >
                {{selectedUser.status === 'active' ? 'æš‚åœç”¨æˆ·' : 'æ¿€æ´»ç”¨æˆ·'}}
              </button>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·èµ„æ–™ -->
        <view class="detail-section" wx:if="{{selectedUser.profile}}">
          <text class="section-title">è¯¦ç»†èµ„æ–™</text>
          <view class="profile-detail">
            <view class="profile-item" wx:if="{{selectedUser.profile.realName}}">
              <text class="profile-label">çœŸå®å§“åï¼š</text>
              <text class="profile-value">{{selectedUser.profile.realName}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.gender}}">
              <text class="profile-label">æ€§åˆ«ï¼š</text>
              <text class="profile-value">{{selectedUser.profile.gender === 'male' ? 'ç”·' : 'å¥³'}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.occupation}}">
              <text class="profile-label">èŒä¸šï¼š</text>
              <text class="profile-value">{{selectedUser.profile.occupation}}</text>
            </view>
            <view class="profile-item" wx:if="{{selectedUser.profile.organization}}">
              <text class="profile-label">æœºæ„ï¼š</text>
              <text class="profile-value">{{selectedUser.profile.organization}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-btn modal-btn--edit" bindtap="editUser" data-id="{{selectedUser.id}}">
          ç¼–è¾‘ç”¨æˆ·
        </button>
        <button class="modal-btn modal-btn--close" bindtap="closeDetailModal">
          å…³é—­
        </button>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡è§’è‰²ä¿®æ”¹å¼¹çª— -->
  <view class="role-modal" wx:if="{{showRoleModal}}">
    <view class="modal-mask" bindtap="closeRoleModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{roleModalTitle}}</text>
        <text class="modal-close" bindtap="closeRoleModal">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="role-selection">
          <text class="selection-title">é€‰æ‹©è§’è‰²</text>
          <view class="role-options">
            <label class="role-option" wx:for="{{availableRoles}}" wx:key="value">
              <checkbox
                class="role-checkbox"
                value="{{item.value}}"
                checked="{{selectedRoles.includes(item.value)}}"
                bindchange="onRoleCheckboxChange"
                data-value="{{item.value}}"
              ></checkbox>
              <text class="role-option-label">{{item.label}}</text>
              <text class="role-option-desc">{{item.description}}</text>
            </label>
          </view>
        </view>

        <view class="reason-input">
          <text class="input-label">ä¿®æ”¹åŸå› </text>
          <textarea
            class="reason-textarea"
            placeholder="è¯·è¾“å…¥ä¿®æ”¹åŸå› ..."
            value="{{roleChangeReason}}"
            bindinput="onRoleReasonInput"
            maxlength="200"
            auto-height
          ></textarea>
          <text class="input-counter">{{roleChangeReason.length}}/200</text>
        </view>
      </view>

      <view class="modal-footer">
        <button
          class="modal-btn modal-btn--confirm"
          bindtap="confirmRoleChange"
          disabled="{{!roleChangeReason.trim()}}"
        >
          ç¡®è®¤ä¿®æ”¹
        </button>
        <button class="modal-btn modal-btn--cancel" bindtap="closeRoleModal">
          å–æ¶ˆ
        </button>
      </view>
    </view>
  </view>
</view>